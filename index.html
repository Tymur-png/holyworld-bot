<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CosmoPunk: Syndicate</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0b0014;
            --accent: #d300d3; /* Magenta */
            --cyan: #00f7ff;    /* Cyan */
            --yellow: #f7ff00;  /* Acid Yellow */
            --glass: rgba(20, 0, 30, 0.6);
            --border: rgba(0, 247, 255, 0.3);
            --font: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            background-image: 
                linear-gradient(0deg, transparent 24%, rgba(0, 247, 255, .05) 25%, rgba(0, 247, 255, .05) 26%, transparent 27%, transparent 74%, rgba(0, 247, 255, .05) 75%, rgba(0, 247, 255, .05) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(0, 247, 255, .05) 25%, rgba(0, 247, 255, .05) 26%, transparent 27%, transparent 74%, rgba(0, 247, 255, .05) 75%, rgba(0, 247, 255, .05) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
            color: #fff;
            font-family: var(--font);
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #app { display: flex; flex-direction: column; height: 100vh; padding: 16px; position: relative; }

        /* --- HUD --- */
        .header { display: flex; justify-content: space-between; align-items: flex-start; z-index: 10; }
        .stats-box {
            background: var(--glass);
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.2);
            backdrop-filter: blur(5px);
        }
        #energy { font-size: 26px; font-weight: 800; color: var(--cyan); text-shadow: 0 0 8px var(--cyan); }
        #rank { font-size: 12px; color: var(--accent); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }

        /* --- REACTOR --- */
        #center { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        
        .reactor-wrap { position: relative; width: 240px; height: 240px; display: flex; justify-content: center; align-items: center; }
        .reactor-glow {
            position: absolute; inset: -20px; border-radius: 50%;
            background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
            opacity: 0.2; animation: pulse 3s infinite;
        }
        #reactor-img { 
            width: 100%; height: 100%; object-fit: contain; 
            filter: drop-shadow(0 0 15px var(--accent));
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #reactor-img:active { transform: scale(0.9); }

        @keyframes pulse { 0% {opacity:0.2; transform:scale(1);} 50% {opacity:0.4; transform:scale(1.1);} 100% {opacity:0.2; transform:scale(1);} }

        /* --- BOTTOM NAV --- */
        .nav-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            background: rgba(0,0,0,0.5); padding: 10px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .nav-btn {
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
            border: 1px solid var(--border); border-radius: 12px;
            height: 44px; display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; color: var(--cyan); cursor: pointer;
        }
        .nav-btn:active { background: var(--accent); color: #000; border-color: var(--accent); }

        /* --- POPUPS --- */
        #pop {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center;
            padding: 20px; animation: popIn 0.2s ease-out;
        }
        .card {
            background: #150020; border: 1px solid var(--accent);
            border-radius: 20px; width: 100%; max-height: 80vh;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 0 30px rgba(211, 0, 211, 0.3);
        }
        .card-header { padding: 15px; background: rgba(255,255,255,0.05); text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .card-body { padding: 15px; overflow-y: auto; }
        .card-footer { padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: center; }
        
        .close-btn {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 8px 24px; border-radius: 20px; font-weight: bold;
        }

        /* --- LIST ITEMS --- */
        .list-item {
            display: flex; align-items: center; gap: 12px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            padding: 12px; border-radius: 12px; margin-bottom: 8px;
        }
        .list-item img { width: 48px; height: 48px; object-fit: contain; }
        .list-info { flex: 1; }
        .list-info h4 { color: #fff; font-size: 14px; margin-bottom: 4px; }
        .list-info p { color: #aaa; font-size: 11px; }
        .action-btn {
            background: var(--cyan); color: #000; border: none;
            padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700;
        }
        .action-btn:disabled { background: #333; color: #666; }
        .action-btn.claim { background: var(--yellow); }

        /* --- FX --- */
        .float-txt {
            position: absolute; font-weight: 900; font-size: 24px; pointer-events: none; z-index: 50;
            text-shadow: 0 0 5px currentColor;
        }
        .crit { color: var(--yellow); font-size: 32px; }
        
        @keyframes popIn { from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }
    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <div class="stats-box">
            <div id="energy">0</div>
            <div id="inc" style="font-size: 11px; opacity:0.8">+0 / —Å–µ–∫</div>
        </div>
        <div style="text-align: right;">
            <div class="stats-box" style="border-color: var(--accent);">
                <div id="rank">Street Rat</div>
                <div id="lvl" style="font-size: 11px; opacity:0.8">LVL 1</div>
            </div>
        </div>
    </div>

    <div id="center">
        <div class="reactor-wrap" id="tap-area">
            <div class="reactor-glow"></div>
            <img src="assets/reactor/reactor.gif" id="reactor-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/9309/9309584.png'">
        </div>
    </div>

    <div class="nav-grid">
        <div class="nav-btn" onclick="openShop('ships')">üöÄ –§–õ–û–¢</div>
        <div class="nav-btn" onclick="openCrew()">üë• –≠–ö–ò–ü–ê–ñ</div>
        <div class="nav-btn" onclick="openQuests()">üìú –ó–ê–î–ê–ù–ò–Ø</div>
        <div class="nav-btn" onclick="openSettings()">‚öôÔ∏è –û–ü–¶–ò–ò</div>
    </div>
</div>

<div id="pop">
    <div class="card">
        <div class="card-header"><h3 id="pop-title">TITLE</h3></div>
        <div class="card-body" id="pop-body"></div>
        <div class="card-footer"><button class="close-btn" onclick="closePop()">–ó–ê–ö–†–´–¢–¨</button></div>
    </div>
</div>

<script>
    /* --- SYSTEM SETUP --- */
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.headerColor = '#0b0014';
    
    // Config
    const SAVE_KEY = 'cp_save_v4';
    const RANKS = ["Street Rat", "Scavenger", "Cyber Punk", "Net Runner", "Void Lord"];

    // Default State
    let s = JSON.parse(localStorage.getItem(SAVE_KEY)) || {
        energy: 0,
        total: 0,
        level: 1,
        ships: {},
        crew: { hacker: 0, bot: 0 },
        quests: { q1: false, q2: false, q3: false },
        settings: { sound: true, vibro: true },
        lastLogin: 0,
        lastSave: Date.now()
    };

    // --- GAME LOOP ---
    setInterval(() => {
        // Passive Income (Ships + Bots)
        let passive = calculatePassive();
        if(passive > 0) {
            s.energy += passive / 10;
            s.total += passive / 10;
        }
        updateUI();
    }, 100);

    setInterval(saveGame, 5000); // Auto-save

    // Check Daily Bonus
    checkDaily();

    // --- LOGIC ---

    function calculatePassive() {
        let income = 0;
        // Ships Logic
        if(s.ships['s1']) income += s.ships['s1'] * 1;
        if(s.ships['s2']) income += s.ships['s2'] * 5;
        // Bot Logic
        if(s.crew['bot']) income += s.crew['bot'] * 20; // Bot is powerful
        return income;
    }

    function tap(e) {
        e.preventDefault();
        let touch = e.touches ? e.touches[0] : e;
        
        // Crit Logic (Hacker)
        let isCrit = false;
        let gain = 1;
        
        // Hacker gives 5% chance per level to crit x10
        let critChance = s.crew['hacker'] * 0.05; 
        if (Math.random() < critChance) {
            isCrit = true;
            gain = 10;
            if(s.settings.vibro) tg.HapticFeedback.notificationOccurred('warning');
        } else {
            if(s.settings.vibro) tg.HapticFeedback.impactOccurred('light');
        }

        s.energy += gain;
        s.total += gain;
        
        checkQuests();
        createParticle(touch.clientX, touch.clientY, gain, isCrit);
        updateUI();
    }

    // --- UI RENDERING ---

    function updateUI() {
        document.getElementById('energy').innerText = Math.floor(s.energy).toLocaleString();
        document.getElementById('inc').innerText = `+${calculatePassive().toFixed(1)} / —Å–µ–∫`;
        
        // Rank Logic
        let rIndex = Math.min(Math.floor(s.total / 10000), RANKS.length - 1);
        document.getElementById('rank').innerText = RANKS[rIndex];
        document.getElementById('lvl').innerText = `LVL ${s.crew['bot'] + s.crew['hacker'] + 1}`;
    }

    function createParticle(x, y, val, isCrit) {
        const el = document.createElement('div');
        el.className = isCrit ? 'float-txt crit' : 'float-txt';
        el.style.color = isCrit ? 'var(--yellow)' : 'var(--cyan)';
        el.innerText = `+${val}`;
        el.style.left = (x - 20) + 'px';
        el.style.top = (y - 40) + 'px';
        document.body.appendChild(el);

        let destX = (Math.random() - 0.5) * 60;
        el.animate([
            { transform: 'translate(0,0) scale(1)', opacity: 1 },
            { transform: `translate(${destX}px, -100px) scale(${isCrit?1.5:1.2})`, opacity: 0 }
        ], { duration: 800, easing: 'cubic-bezier(0,0,0.2,1)' });

        setTimeout(() => el.remove(), 800);
    }

    // --- MENUS ---

    function openShop(type) {
        const title = document.getElementById('pop-title');
        const body = document.getElementById('pop-body');
        document.getElementById('pop').style.display = 'flex';
        
        title.innerText = "–ê–ù–ì–ê–† –§–õ–û–¢–ê";
        
        const items = [
            { id: 's1', name: 'Scout Drone', cost: 100, inc: 1, img: 'ship1' },
            { id: 's2', name: 'Battle Cruiser', cost: 500, inc: 5, img: 'ship2' }
        ];

        body.innerHTML = items.map(i => {
            let count = s.ships[i.id] || 0;
            let price = Math.floor(i.cost * Math.pow(1.3, count));
            return `
            <div class="list-item">
                <img src="assets/ships/${i.img}.png" onerror="this.src='https://via.placeholder.com/48/00ffff?text=S'">
                <div class="list-info">
                    <h4>${i.name}</h4>
                    <p>–î–æ—Ö–æ–¥: +${i.inc}/—Å–µ–∫ | –£ —Ç–µ–±—è: ${count}</p>
                </div>
                <button class="action-btn" onclick="buyShip('${i.id}', ${price})">${price}</button>
            </div>`;
        }).join('');
    }

    function buyShip(id, price) {
        if(s.energy >= price) {
            s.energy -= price;
            s.ships[id] = (s.ships[id] || 0) + 1;
            saveGame();
            openShop('ships'); // Redraw
            tg.HapticFeedback.selectionChanged();
        }
    }

    function openCrew() {
        const title = document.getElementById('pop-title');
        const body = document.getElementById('pop-body');
        document.getElementById('pop').style.display = 'flex';
        title.innerText = "–≠–ö–ò–ü–ê–ñ";

        // Hacker Cost
        let hLvl = s.crew.hacker;
        let hCost = Math.floor(1000 * Math.pow(2, hLvl));
        
        // Bot Cost
        let bLvl = s.crew.bot;
        let bCost = Math.floor(2000 * Math.pow(1.5, bLvl));

        body.innerHTML = `
            <div class="list-item">
                <img src="assets/crew/hacker.png" onerror="this.src='https://via.placeholder.com/48/d300d3?text=H'">
                <div class="list-info">
                    <h4>–õ–∏—Å–∞-–•–∞–∫–µ—Ä (LVL ${hLvl})</h4>
                    <p>–®–∞–Ω—Å –∫—Ä–∏—Ç–∞ (x10) +5%</p>
                </div>
                <button class="action-btn" onclick="upgradeCrew('hacker', ${hCost})">${hCost}</button>
            </div>
            <div class="list-item">
                <img src="assets/crew/bot.png" onerror="this.src='https://via.placeholder.com/48/f7ff00?text=B'">
                <div class="list-info">
                    <h4>–ê–≤—Ç–æ-–ë–æ—Ç (LVL ${bLvl})</h4>
                    <p>–î–æ–±—ã–≤–∞–µ—Ç +20/—Å–µ–∫</p>
                </div>
                <button class="action-btn" onclick="upgradeCrew('bot', ${bCost})">${bCost}</button>
            </div>
        `;
    }

    function upgradeCrew(role, price) {
        if(s.energy >= price) {
            s.energy -= price;
            s.crew[role]++;
            saveGame();
            openCrew();
            tg.HapticFeedback.notificationOccurred('success');
        }
    }

    function openQuests() {
        document.getElementById('pop').style.display = 'flex';
        document.getElementById('pop-title').innerText = "–ó–ê–î–ê–ù–ò–Ø";
        const body = document.getElementById('pop-body');

        const qData = [
            { id: 'q1', txt: '–ù–∞–∫–æ–ø–∏—Ç—å 1000 —ç–Ω–µ—Ä–≥–∏–∏', reward: 500, done: s.total >= 1000 },
            { id: 'q2', txt: '–ö—É–ø–∏—Ç—å 5 –î—Ä–æ–Ω–æ–≤', reward: 1000, done: (s.ships['s1']||0) >= 5 },
            { id: 'q3', txt: '–ù–∞–Ω—è—Ç—å –•–∞–∫–µ—Ä–∞', reward: 2000, done: s.crew['hacker'] > 0 }
        ];

        body.innerHTML = qData.map(q => {
            let isClaimed = s.quests[q.id];
            let btn = '';
            
            if(isClaimed) btn = `<button class="action-btn" disabled>‚úì</button>`;
            else if(q.done) btn = `<button class="action-btn claim" onclick="claimQuest('${q.id}', ${q.reward})">–ó–ê–ë–†–ê–¢–¨</button>`;
            else btn = `<button class="action-btn" disabled>üîí</button>`;

            return `
            <div class="list-item">
                <div class="list-info">
                    <h4>${q.txt}</h4>
                    <p style="color:var(--yellow)">–ù–∞–≥—Ä–∞–¥–∞: ${q.reward} PUNK</p>
                </div>
                ${btn}
            </div>`;
        }).join('');
    }

    function claimQuest(qid, reward) {
        s.quests[qid] = true;
        s.energy += reward;
        tg.HapticFeedback.notificationOccurred('success');
        saveGame();
        openQuests();
        alert(`–ü–æ–ª—É—á–µ–Ω–æ ${reward} —ç–Ω–µ—Ä–≥–∏–∏!`);
    }

    function openSettings() {
        document.getElementById('pop').style.display = 'flex';
        document.getElementById('pop-title').innerText = "–°–ò–°–¢–ï–ú–ê";
        const body = document.getElementById('pop-body');

        body.innerHTML = `
            <div class="list-item" onclick="toggleSet('sound')">
                <div class="list-info"><h4>–ó–≤—É–∫–∏</h4></div>
                <div style="color:var(--cyan)">${s.settings.sound ? '–í–ö–õ' : '–í–´–ö–õ'}</div>
            </div>
            <div class="list-item" onclick="toggleSet('vibro')">
                <div class="list-info"><h4>–í–∏–±—Ä–∞—Ü–∏—è</h4></div>
                <div style="color:var(--cyan)">${s.settings.vibro ? '–í–ö–õ' : '–í–´–ö–õ'}</div>
            </div>
            <div class="list-item" style="border-color:red" onclick="resetGame()">
                <div class="list-info"><h4 style="color:red">–°–ë–†–û–° –ü–†–û–ì–†–ï–°–°–ê</h4></div>
            </div>
        `;
    }

    function toggleSet(key) {
        s.settings[key] = !s.settings[key];
        saveGame();
        openSettings();
    }

    // --- UTILS ---
    function checkDaily() {
        const today = new Date().toDateString();
        if(s.lastLogin !== today) {
            s.lastLogin = today;
            s.energy += 500;
            saveGame();
            setTimeout(() => alert("üìÖ –ï–ñ–ï–î–ù–ï–í–ù–´–ô –ë–û–ù–£–°: +500 PUNK"), 1000);
        }
    }
    
    function checkQuests() {
        // Run quietly to allow UI to show 'Claim' later
    }

    function saveGame() {
        localStorage.setItem(SAVE_KEY, JSON.stringify(s));
    }
    
    function resetGame() {
        if(confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")) {
            localStorage.removeItem(SAVE_KEY);
            location.reload();
        }
    }

    function closePop() { document.getElementById('pop').style.display = 'none'; }

    // Bind Tap
    document.getElementById('tap-area').addEventListener('touchstart', tap);
    document.getElementById('tap-area').addEventListener('mousedown', tap);

    // Initial UI Update
    updateUI();

</script>
</body>
</html>