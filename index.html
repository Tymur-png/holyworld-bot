<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CosmoPunk: Syndicate Wars</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #05000a;
            --accent: #d300d3;
            --cyan: #00f7ff;
            --yellow: #f7ff00;
            --red: #ff2a2a;
            --glass: rgba(16, 20, 30, 0.9);
            --border: rgba(0, 247, 255, 0.2);
            --font: 'Courier New', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            color: #fff;
            font-family: var(--font);
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* MATRIX BG */
        #matrix-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; opacity: 0.15; pointer-events: none;
        }

        #app { display: flex; flex-direction: column; height: 100vh; padding: 12px; position: relative; z-index: 2; }

        /* HUD */
        .hud { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .res-box {
            background: var(--glass); border: 1px solid var(--border);
            padding: 8px 12px; border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,247,255,0.1);
        }
        #energy-val { font-size: 22px; font-weight: 900; color: var(--cyan); text-shadow: 0 0 10px var(--cyan); }
        .sub-text { font-size: 10px; color: #aaa; margin-top: 2px; }
        .rank-box { text-align: right; border-color: var(--accent); }
        #rank-val { color: var(--accent); font-weight: bold; font-size: 12px; text-transform: uppercase; }

        /* REACTOR */
        #stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; perspective: 1000px; }
        
        .reactor-wrap { 
            position: relative; width: 260px; height: 260px; 
            display: flex; justify-content: center; align-items: center; 
            transition: transform 0.1s; transform-style: preserve-3d;
        }
        .reactor-wrap:active { transform: scale(0.95); }
        
        /* –≠—Ñ—Ñ–µ–∫—Ç —Ç—Ä—è—Å–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ */
        .shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }

        #reactor-img { 
            width: 100%; height: 100%; object-fit: contain; z-index: 5;
            filter: drop-shadow(0 0 25px rgba(211,0,211,0.4));
        }

        /* HACK BUTTON (Mini Game) */
        #hack-btn {
            margin-top: 20px;
            background: linear-gradient(90deg, #ff004c, #ff9100);
            border: none; padding: 10px 20px; border-radius: 20px;
            color: #fff; font-weight: bold; font-size: 14px;
            box-shadow: 0 0 15px rgba(255, 0, 76, 0.4);
            opacity: 0.5; filter: grayscale(1); pointer-events: none; transition: 0.3s;
        }
        #hack-btn.ready { opacity: 1; filter: grayscale(0); pointer-events: auto; animation: pulse-btn 1.5s infinite; }

        /* NAV */
        .nav { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding-bottom: 10px; }
        .nav-btn {
            background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 10px;
            height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 9px; color: #888; transition: 0.2s;
        }
        .nav-btn span { font-size: 18px; margin-bottom: 3px; }
        .nav-btn:active { background: var(--cyan); color: #000; }

        /* MODALS */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            display: none; align-items: flex-end; justify-content: center;
            animation: fadeIn 0.2s;
        }
        .modal-card {
            background: #0b0514; border-top: 2px solid var(--accent);
            width: 100%; max-height: 85vh; border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 -10px 40px rgba(211, 0, 211, 0.3);
            animation: slideUp 0.3s;
        }
        .modal-header { padding: 15px; text-align: center; font-weight: bold; font-size: 16px; border-bottom: 1px solid #222; }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }

        /* ITEMS LIST */
        .item { 
            display: flex; gap: 10px; align-items: center; 
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            padding: 10px; border-radius: 12px; margin-bottom: 8px;
        }
        .item img { width: 45px; height: 45px; object-fit: contain; background: #000; border-radius: 8px; }
        .item-info { flex: 1; }
        .item-name { font-size: 13px; font-weight: bold; color: #fff; }
        .item-desc { font-size: 10px; color: #777; }
        .btn-buy {
            background: var(--cyan); color: #000; border: none; padding: 6px 12px;
            border-radius: 6px; font-size: 11px; font-weight: bold;
        }

        /* MINI GAME UI */
        #hack-game-ui {
            width: 100%; padding: 30px; text-align: center;
            display: flex; flex-direction: column; align-items: center;
        }
        .hack-track {
            width: 100%; height: 20px; background: #333; border-radius: 10px;
            position: relative; overflow: hidden; margin: 20px 0; border: 1px solid #555;
        }
        .hack-target {
            position: absolute; top: 0; bottom: 0; width: 40px; /* Target Zone */
            background: var(--yellow); opacity: 0.7; left: 50%; transform: translateX(-50%);
            box-shadow: 0 0 10px var(--yellow);
        }
        .hack-cursor {
            position: absolute; top: -5px; bottom: -5px; width: 4px;
            background: var(--red); left: 0%; transition: none;
            box-shadow: 0 0 10px var(--red); z-index: 2;
        }
        .hack-btn-action {
            width: 100%; padding: 20px; background: var(--red); color: #fff;
            border: none; font-size: 18px; font-weight: 900; border-radius: 12px;
        }

        /* DAILY REWARD */
        .daily-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .daily-day {
            background: #111; border: 1px solid #333; padding: 10px 5px;
            border-radius: 8px; text-align: center; opacity: 0.5;
        }
        .daily-day.active { border-color: var(--yellow); opacity: 1; background: rgba(247, 255, 0, 0.1); }
        .daily-day.claimed { border-color: var(--cyan); opacity: 0.3; background: rgba(0, 247, 255, 0.1); }

        /* FX */
        .float-txt { position: absolute; font-weight: bold; font-size: 24px; pointer-events: none; z-index: 50; }
        
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes pulse-btn { 0% {box-shadow: 0 0 0 0 rgba(255, 0, 76, 0.7);} 70% {box-shadow: 0 0 0 10px rgba(255, 0, 76, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 0, 76, 0);} }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div id="app">
    <div class="hud">
        <div class="res-box">
            <div id="energy-val">0</div>
            <div class="sub-text" id="inc-val">+0 / —Å–µ–∫</div>
        </div>
        <div class="res-box rank-box">
            <div id="rank-val">NOBODY</div>
            <div class="sub-text" id="lvl-val">LVL 1</div>
        </div>
    </div>

    <div id="stage">
        <div class="reactor-wrap" id="tap-zone">
            <img src="assets/reactor/reactor.gif" id="reactor-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/9309/9309584.png'">
        </div>
        <button id="hack-btn" onclick="startHackGame()">‚ò† –í–ó–õ–û–ú –°–ò–°–¢–ï–ú–´</button>
    </div>

    <div class="nav">
        <div class="nav-btn" onclick="openMenu('ships')"><span>üöÄ</span>–§–ª–æ—Ç</div>
        <div class="nav-btn" onclick="openMenu('crew')"><span>üë•</span>–ë–∞–Ω–¥–∞</div>
        <div class="nav-btn" onclick="openMenu('implants')"><span>üß†</span>–ß–∏–ø—ã</div>
        <div class="nav-btn" onclick="openMenu('daily')"><span>üéÅ</span>–ë–æ–Ω—É—Å</div>
    </div>
</div>

<div class="modal-overlay" id="main-modal" onclick="if(event.target.id==='main-modal') closeModal()">
    <div class="modal-card">
        <div class="modal-header" id="modal-title">TITLE</div>
        <div class="modal-body" id="modal-content"></div>
        <button style="padding:15px; background:#111; color:#fff; border:none;" onclick="closeModal()">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div class="modal-overlay" id="hack-modal">
    <div class="modal-card" style="height: auto;">
        <div class="modal-header" style="color:var(--red)">–ü–†–û–†–´–í FIREWALL</div>
        <div class="modal-body">
            <div id="hack-game-ui">
                <p>–û—Å—Ç–∞–Ω–æ–≤–∏ –∫—É—Ä—Å–æ—Ä –≤ –∂–µ–ª—Ç–æ–π –∑–æ–Ω–µ!</p>
                <div class="hack-track">
                    <div class="hack-target" id="hack-target-zone"></div>
                    <div class="hack-cursor" id="hack-cursor"></div>
                </div>
                <button class="hack-btn-action" onmousedown="stopHack()" ontouchstart="stopHack()">–í–ó–õ–û–ú–ê–¢–¨</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- AUDIO ENGINE (Synthesizer) ---
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–≤—É–∫–∏ –∫–æ–¥–æ–º, –Ω–µ –Ω—É–∂–Ω—ã mp3
    const AudioFX = {
        ctx: null,
        init: function() {
            if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        },
        play: function(type) {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);

            const now = this.ctx.currentTime;
            
            if(type === 'tap') {
                // High pitch short blip
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'buy') {
                // Success coin sound
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'error') {
                // Low buzz
                osc.type = 'sawtooth';
                osc.frequency.value = 150;
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }
        }
    };

    // --- GAME DATA & CONFIG ---
    const tg = window.Telegram.WebApp;
    tg.expand();
    const SAVE_KEY = 'cp_wars_v4';

    const DB = {
        ships: [
            { id: 's1', name: '–î—Ä–æ–Ω-—Å–±–æ—Ä—â–∏–∫', inc: 1, cost: 150, img: 'ship1.png' },
            { id: 's2', name: '–ò—Å—Ç—Ä–µ–±–∏—Ç–µ–ª—å', inc: 5, cost: 800, img: 'ship2.png' },
            { id: 's3', name: '–§—Ä–µ–≥–∞—Ç "–ù–µ–æ–Ω"', inc: 20, cost: 3500, img: 'ship3.png' },
            { id: 's4', name: '–ö—Ä–µ–π—Å–µ—Ä –¢–µ—Å–ª–∞', inc: 80, cost: 12000, img: 'ship4.png' }
        ],
        crew: [
            { id: 'c1', name: '–•–∞–∫–µ—Ä –õ–∏—Å–∞', desc: '–ö—Ä–∏—Ç —à–∞–Ω—Å +5%', cost: 1000, type: 'crit', val: 0.05, img: 'hacker.png' },
            { id: 'c2', name: '–ë–æ—Ç-—à–∞—Ö—Ç–µ—Ä', desc: '–ê–≤—Ç–æ-–¥–æ—Ö–æ–¥ +30/—Å–µ–∫', cost: 2000, type: 'passive', val: 30, img: 'bot.png' },
            { id: 'c3', name: '–ö–∞–ø–∏—Ç–∞–Ω', desc: '–£—Å–∏–ª–∏–≤–∞–µ—Ç —Ñ–ª–æ—Ç x1.5', cost: 10000, type: 'mult', val: 0.5, img: 'captain.png' }
        ],
        daily: [500, 1000, 1500, 3000, 5000, 10000, 25000] // –ù–∞–≥—Ä–∞–¥—ã –∑–∞ 7 –¥–Ω–µ–π
    };

    let state = {
        energy: 0,
        total: 0,
        ships: {},
        crew: {}, // Levels of crew
        implants: [],
        lastHack: 0, // timestamp
        daily: { day: 0, lastClaim: 0 },
        lastSave: Date.now()
    };

    // --- INIT ---
    // Load save
    let saved = localStorage.getItem(SAVE_KEY);
    if(saved) state = { ...state, ...JSON.parse(saved) };

    // Offline Earnings
    let offlineSeconds = (Date.now() - state.lastSave) / 1000;
    if(offlineSeconds > 60) {
        let earn = calcIncome() * offlineSeconds;
        if(earn > 0) {
            state.energy += earn;
            state.total += earn;
            setTimeout(() => alert(`–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, –ë–æ—Å—Å!\n–í–∞—à —Å–∏–Ω–¥–∏–∫–∞—Ç –∑–∞—Ä–∞–±–æ—Ç–∞–ª: ${Math.floor(earn)} PUNK`), 500);
        }
    }

    // Loops
    setInterval(() => {
        let inc = calcIncome() / 10;
        if(inc > 0) addEnergy(inc);
        updateHUD();
        checkHackStatus();
    }, 100);
    
    setInterval(saveGame, 5000);

    // Matrix Background
    initMatrix();

    // --- CORE MECHANICS ---

    function calcIncome() {
        let income = 0;
        // Ships
        DB.ships.forEach(s => {
            if(state.ships[s.id]) income += state.ships[s.id] * s.inc;
        });
        // Crew: Bot
        if(state.crew['c2']) income += state.crew['c2'] * 30;
        // Crew: Captain (Multiplier)
        if(state.crew['c3']) income *= (1 + state.crew['c3'] * 0.5);
        
        return income;
    }

    function addEnergy(amount) {
        state.energy += amount;
        state.total += amount;
    }

    function tap(e) {
        // Init audio on first interaction
        AudioFX.init();
        
        e.preventDefault();
        let touches = e.changedTouches || [e];

        for(let t of touches) {
            let power = 1 + (state.crew['c3'] || 0); // Captain adds base power
            
            // Crit logic (Hacker)
            let critChance = 0.05 + (state.crew['c1'] || 0) * 0.05;
            let isCrit = Math.random() < critChance;
            if(isCrit) {
                power *= 10;
                tg.HapticFeedback.notificationOccurred('warning');
            } else {
                tg.HapticFeedback.impactOccurred('light');
            }

            addEnergy(power);
            spawnFloat(t.clientX, t.clientY, Math.floor(power), isCrit);
            AudioFX.play('tap');
        }

        // Visual
        const r = document.getElementById('reactor-img');
        r.classList.remove('shake');
        void r.offsetWidth; // trigger reflow
        r.classList.add('shake');
    }

    // --- HACKING MINI GAME ---
    let hackAnim;
    let hackDir = 1;
    let hackPos = 0;
    
    function checkHackStatus() {
        // Cooldown 5 mins (300000 ms)
        let now = Date.now();
        let btn = document.getElementById('hack-btn');
        let diff = now - state.lastHack;
        
        if(diff > 300000) {
            btn.classList.add('ready');
            btn.innerText = "‚ò† –í–ó–õ–û–ú –î–û–°–¢–£–ü–ï–ù";
        } else {
            btn.classList.remove('ready');
            let left = Math.ceil((300000 - diff)/1000);
            let min = Math.floor(left/60);
            let sec = left%60;
            btn.innerText = `‚è≥ ${min}:${sec < 10 ? '0'+sec : sec}`;
        }
    }

    function startHackGame() {
        if(Date.now() - state.lastHack < 300000) return;
        
        document.getElementById('hack-modal').style.display = 'flex';
        hackPos = 0;
        hackDir = 1; // Speed factor
        
        // Game Loop
        let cursor = document.getElementById('hack-cursor');
        // Randomize target position
        let targetLeft = 30 + Math.random() * 40; // 30% to 70%
        document.getElementById('hack-target-zone').style.left = targetLeft + '%';
        window.hackTargetMin = targetLeft;
        window.hackTargetMax = targetLeft + 15; // Width of zone roughly

        function animate() {
            hackPos += hackDir * 1.5; // Speed
            if(hackPos > 100 || hackPos < 0) hackDir *= -1;
            cursor.style.left = hackPos + '%';
            hackAnim = requestAnimationFrame(animate);
        }
        animate();
    }

    function stopHack() {
        cancelAnimationFrame(hackAnim);
        
        // Check Hit
        if(hackPos >= window.hackTargetMin && hackPos <= window.hackTargetMax) {
            // WIN
            let reward = calcIncome() * 300; // 5 mins of income instant
            if(reward < 500) reward = 500; // Min reward
            
            addEnergy(reward);
            alert(`–í–ó–õ–û–ú –£–°–ü–ï–®–ï–ù!\n–°–∫–∞—á–∞–Ω–æ: ${Math.floor(reward)} PUNK`);
            tg.HapticFeedback.notificationOccurred('success');
            AudioFX.play('buy');
            state.lastHack = Date.now();
        } else {
            // FAIL
            alert("–û–ë–ù–ê–†–£–ñ–ï–ù–ò–ï!\n–°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –¥–æ—Å—Ç—É–ø.");
            tg.HapticFeedback.notificationOccurred('error');
            AudioFX.play('error');
            // Small cooldown punishment (30 sec)
            state.lastHack = Date.now() - 270000; 
        }
        document.getElementById('hack-modal').style.display = 'none';
        checkHackStatus();
    }

    // --- MENUS ---

    function openMenu(type) {
        document.getElementById('main-modal').style.display = 'flex';
        const title = document.getElementById('modal-title');
        const content = document.getElementById('modal-content');
        content.innerHTML = '';

        if(type === 'ships') {
            title.innerText = "–ê–ù–ì–ê–† –§–õ–û–¢–ê";
            DB.ships.forEach(s => {
                let cnt = state.ships[s.id] || 0;
                let price = Math.floor(s.cost * Math.pow(1.2, cnt));
                renderItem(content, s.name, `+${s.inc}/—Å–µ–∫ | –ï—Å—Ç—å: ${cnt}`, price, s.img, () => {
                    if(state.energy >= price) {
                        state.energy -= price;
                        state.ships[s.id] = cnt + 1;
                        AudioFX.play('buy');
                        openMenu('ships'); // redraw
                    }
                });
            });
        }
        else if(type === 'crew') {
            title.innerText = "–ù–ê–ô–ú –ë–ê–ù–î–´";
            DB.crew.forEach(c => {
                let lvl = state.crew[c.id] || 0;
                let price = Math.floor(c.cost * Math.pow(1.5, lvl));
                renderItem(content, `${c.name} (Lvl ${lvl})`, c.desc, price, c.img, () => {
                    if(state.energy >= price) {
                        state.energy -= price;
                        state.crew[c.id] = lvl + 1;
                        AudioFX.play('buy');
                        openMenu('crew');
                    }
                });
            });
        }
        else if(type === 'daily') {
            title.innerText = "–°–ù–ê–ë–ñ–ï–ù–ò–ï";
            checkDailyLogic(content);
        }
    }

    function renderItem(container, name, desc, price, img, onClick) {
        let div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
            <img src="assets/ships/${img}" onerror="this.src='https://via.placeholder.com/45?text=?'">
            <div class="item-info">
                <div class="item-name">${name}</div>
                <div class="item-desc">${desc}</div>
            </div>
            <button class="btn-buy">${price.toLocaleString()}</button>
        `;
        div.querySelector('button').onclick = onClick;
        container.appendChild(div);
    }

    function checkDailyLogic(container) {
        let now = new Date();
        let last = new Date(state.daily.lastClaim);
        let isSameDay = now.toDateString() === last.toDateString();
        
        // Reset streak if missed more than 1 day
        if((now - last) > 86400000 * 2) {
            state.daily.day = 0;
        }

        let grid = document.createElement('div');
        grid.className = 'daily-grid';

        DB.daily.forEach((reward, idx) => {
            let el = document.createElement('div');
            el.className = 'daily-day';
            el.innerHTML = `<div>–î–µ–Ω—å ${idx+1}</div><div style="color:var(--yellow)">${reward}</div>`;
            
            if(idx < state.daily.day) el.classList.add('claimed');
            if(idx === state.daily.day) el.classList.add('active');
            
            if(idx === state.daily.day && !isSameDay) {
                el.onclick = () => {
                    state.daily.lastClaim = Date.now();
                    state.daily.day++;
                    addEnergy(reward);
                    AudioFX.play('buy');
                    tg.HapticFeedback.notificationOccurred('success');
                    alert(`–ü–æ–ª—É—á–µ–Ω–æ: ${reward} PUNK`);
                    openMenu('daily');
                };
            }
            grid.appendChild(el);
        });
        container.appendChild(grid);
        
        let msg = document.createElement('p');
        msg.style.textAlign = 'center';
        msg.style.marginTop = '15px';
        msg.style.color = '#777';
        msg.innerText = isSameDay ? "–ù–∞–≥—Ä–∞–¥–∞ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–∞ —Å–µ–≥–æ–¥–Ω—è." : "–ù–∞–∂–º–∏ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å!";
        container.appendChild(msg);
    }

    function closeModal() { document.getElementById('main-modal').style.display = 'none'; }

    // --- UTILS ---
    function updateHUD() {
        document.getElementById('energy-val').innerText = Math.floor(state.energy).toLocaleString();
        document.getElementById('inc-val').innerText = `+${Math.floor(calcIncome())} / —Å–µ–∫`;
        
        let ranks = ["Street Rat", "Scavenger", "Hacker", "Cyber Lord", "Syndicate Boss"];
        let rIdx = Math.min(Math.floor(state.total / 50000), ranks.length-1);
        document.getElementById('rank-val').innerText = ranks[rIdx];
    }

    function spawnFloat(x, y, val, isCrit) {
        let el = document.createElement('div');
        el.className = 'float-txt';
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.innerText = `+${val}`;
        el.style.color = isCrit ? 'var(--red)' : 'var(--cyan)';
        document.body.appendChild(el);
        setTimeout(() => {
            el.style.transform = 'translateY(-80px)';
            el.style.opacity = 0;
        }, 50);
        setTimeout(() => el.remove(), 600);
    }

    function saveGame() {
        state.lastSave = Date.now();
        localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    }

    // --- MATRIX EFFECT ---
    function initMatrix() {
        const c = document.getElementById('matrix-canvas');
        const ctx = c.getContext('2d');
        c.width = window.innerWidth;
        c.height = window.innerHeight;
        
        const chars = "010101XYKPUNK";
        const fontSize = 14;
        const columns = c.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);

        function draw() {
            ctx.fillStyle = "rgba(5, 0, 10, 0.1)";
            ctx.fillRect(0, 0, c.width, c.height);
            ctx.fillStyle = "#0f0";
            ctx.font = fontSize + "px monospace";

            for(let i=0; i<drops.length; i++) {
                const text = chars[Math.floor(Math.random()*chars.length)];
                ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                if(drops[i]*fontSize > c.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
        setInterval(draw, 50);
    }

    // EVENTS
    const zone = document.getElementById('tap-zone');
    zone.addEventListener('touchstart', tap, {passive:false});
    zone.addEventListener('mousedown', tap);

</script>
</body>
</html>