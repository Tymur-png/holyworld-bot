<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CosmoPunk Tap Game v2.0</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<style>
:root{--bg:#0a001a;--neon1:#ff00ff;--neon2:#00ffff;--dark:#0f0022;--glow:0 0 30px var(--neon1)}
body{margin:0;background:radial-gradient(circle,#1a0033 0%,var(--bg) 70%);color:#fff;font-family:'Courier New',monospace;overflow:hidden}
#game{position:relative;width:100vw;height:100vh}
#header{position:absolute;top:10px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:center;font-size:14px}
#rank-progress{width:100%;height:8px;background:rgba(255,255,255,0.1);border:1px solid var(--neon2);border-radius:4px;margin-top:5px}
#rank-bar{width:0%;height:100%;background:linear-gradient(90deg,var(--neon1),var(--neon2));transition:width 0.5s;border-radius:3px}
#reactor{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:320px;height:320px;cursor:pointer;filter:var(--glow)}
#energy,#punk,#income{position:absolute;left:0;right:0;text-align:center;text-shadow:var(--glow);font-weight:bold}
#energy{top:160px;font-size:38px}
#punk{top:210px;font-size:26px;color:var(--neon2)}
#income{top:245px;font-size:20px}
.btn{position:absolute;background:linear-gradient(45deg,rgba(0,255,255,0.2),rgba(255,0,255,0.2));border:2px solid var(--neon2);color:#fff;padding:14px 20px;border-radius:20px;text-align:center;box-shadow:var(--glow);backdrop-filter:blur(15px);font-weight:bold;font-size:14px;transition:all 0.3s}
.btn:active{transform:scale(0.95);box-shadow:0 0 50px var(--neon1)}
#shopBtn{bottom:200px;left:20px;right:20px}
#crewBtn{bottom:140px;left:20px;right:20px}
#implantsBtn{bottom:80px;left:20px;right:20px}
#raidBtn{bottom:30px;left:15px;width:calc(50% - 25px)}
#tonBtn{bottom:30px;right:15px;width:calc(50% - 25px);border-color:#ffd700;color:#ffd700}
.glitch{animation:glitch 0.2s infinite}@keyframes glitch{0%,100%{transform:translate(0)}20%{transform:translate(-5px,5px)}40%{transform:translate(5px,-5px)}60%{transform:translate(-5px,-5px)}}
.pulse{animation:pulse 1.8s infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
.particle{position:absolute;color:var(--neon2);font-size:36px;pointer-events:none;font-weight:bold;animation:float 1.5s forwards;text-shadow:var(--glow)}@keyframes float{to{transform:translateY(-350px) rotate(720deg);opacity:0}}
#popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:100;overflow-y:auto;padding:20px}
.shop-item{margin:15px 0;padding:20px;border:2px solid var(--neon1);border-radius:15px;background:rgba(255,0,255,0.05);transition:all 0.3s}
.shop-item:hover{box-shadow:0 0 40px var(--neon1);transform:scale(1.02)}
</style>
</head>
<body>
<div id="game">
    <div id="header">
        <div>–†–∞–Ω–≥: <span id="rankName">Street Rat</span> <div id="rank-progress"><div id="rank-bar"></div></div></div>
        <div id="referral">–†–µ—Ñ: <span id="refCount">0</span></div>
    </div>
    <div id="energy">0 PUNK Energy</div>
    <div id="punk">0.000 $PUNK</div>
    <div id="income">0 /—Å–µ–∫</div>
    <img id="reactor" src="https://i.ibb.co/0jKX7Wv/reactor.gif" class="pulse" onclick="tapReactor()">
    <div id="shopBtn" class="btn glitch" onclick="openShop()">üöÄ –§–õ–û–¢</div>
    <div id="crewBtn" class="btn" onclick="openCrew()">üë• –≠–ö–ò–ü–ê–ñ</div>
    <div id="implantsBtn" class="btn" onclick="openImplants()">üîß –ò–ú–ü–õ–ê–ù–¢–´</div>
    <div id="raidBtn" class="btn" onclick="startRaid()">‚öîÔ∏è RAID</div>
    <div id="tonBtn" class="btn" id="tonStatus">TON CONNECT</div>
</div>
<div id="popup"></div>

<script>
// === –î–ê–ù–ù–´–ï –ò–ì–†–û–ö–ê ===
let player = {
    energy:0,totalEnergy:0,punk:0,tapPower:1,passiveIncome:0,multipliers:1,ships:{},implants:{},crew:{},rank:0,rankProgress:0,
    referrals:[],refIncome:0,magnet:0,lastTime:Date.now(),tonConnected:false,tonAddress:''
};
let gameData = {
    ships:{reaper:{price:2e7,income:1000,name:'Void Reaper S'},corsair:{price:1e7,income:500,name:'Neon Corsair A'},hauler:{price:5e6,income:200,name:'Punk Hauler B'},fighter:{price:2e6,income:100,name:'Scrap Fighter C'},drone:{price:1e6,income:50,name:'Rusty Drone D'}},
    implants:{neo:{price:1e6,effect:'tap',mult:2,name:'–ù–µ–æ-–ù–µ–π—Ä–æ–Ω S',max:50},glitch:{price:5e5,effect:'passive',mult:1,name:'–ì–ª–∏—Ç—á-–ü—Ä–æ—Ç–µ–∑ A',max:40},eye:{price:2e5,effect:'hack',mult:0.5,name:'–ö–∏–±–µ—Ä-–ì–ª–∞–∑ B',max:30},rust:{price:1e5,effect:'income',mult:0.2,name:'–†–∂–∞–≤—ã–π –ß–∏–ø C',max:25},basic:{price:5e4,effect:'tap',mult:0.1,name:'–ë–∞–∑–æ–≤—ã–π D',max:20}},
    crew:[
        {id:'kosmo',name:'–ö–∞–ø–∏—Ç–∞–Ω –ö–æ—Å–º–æ S',price:1e6,effect:'fleet*1.5',desc:'+50% —Ñ–ª–æ—Ç-–¥–æ—Ö–æ–¥'},
        {id:'lisa',name:'–õ–∏—Å–∞-–•–∞–∫–µ—Ä A',price:8e5,effect:'hack*1.3',desc:'+30% —à–∞–Ω—Å —Ö–∞–∫–æ–≤'},
        {id:'neuro',name:'–î–æ–∫—Ç–æ—Ä –ù–µ–π—Ä–æ A',price:7e5,effect:'regen*1.2',desc:'+20% —Ä–µ–≥–µ–Ω/–º–∏–Ω'},
        {id:'gigabot',name:'–ì–∏–≥–∞–ü–∞–Ω–∫-–ë–æ—Ç B',price:5e5,effect:'auto*1',desc:'1 –∞–≤—Ç–æ-—Ç–∞–ø/—Å–µ–∫'},
        {id:'shady',name:'–ù–µ–æ–Ω-–®–µ–π–¥–∏ B',price:4e5,effect:'market*1.15',desc:'+15% —Ç—ë–º–Ω—ã–π —Ä—ã–Ω–æ–∫'},
        {id:'mechanic',name:'Void Mechanic C',price:3e5,effect:'price*-0.2',desc:'-20% —Ü–µ–Ω—ã –∞–ø–≥—Ä–µ–π–¥–æ–≤'},
        {id:'witch',name:'Plasma Witch A',price:9e5,effect:'boss*1.4',desc:'+40% –±–æ—Å—Å-–¥–∞–º–∞–≥'},
        {id:'dealer',name:'Scrap Dealer C',price:2e5,effect:'sell*1.25',desc:'+25% —Ü–µ–Ω—ã –ø—Ä–æ–¥–∞–∂'},
        {id:'ghost',name:'Cyber Ghost S',price:1.5e6,effect:'pvp*inf',desc:'–Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç—å PvP'},
        {id:'ai',name:'Rogue AI S',price:2e6,effect:'all*1.1',desc:'+10% –≤—Å–µ —Å—Ç–∞—Ç—ã'}
    ],
    ranks:[{name:'Street Rat',req:0,bonus:'start'},{name:'Neon Scavenger',req:1e3,bonus:'+1 –º–∞–≥–∞–∑–∏–Ω'},{name:'Void Pirate',req:1e6,bonus:'PvE –±–æ—Å—Å—ã'},{name:'Cyber Overlord',req:1e9,bonus:'NFT —Å–ª–æ—Ç—ã'},{name:'Galaxy Baron',req:1e12,bonus:'–ø–æ–ª–Ω—ã–π —Ñ–ª–æ—Ç'}]
};
let raidActive=false,raidTaps=0,ocActive=false;

// === TON CONNECT ===
const tcui = new TON_CONNECT.UI.TonConnectUI({manifestUrl:'https://holyworld-bot.vercel.app/tonconnect-manifest.json'});
document.getElementById('tonBtn').onclick = async()=>{
    if(!player.tonConnected){
        await tcui.connectWallet();
        const addr = (await tcui.account).address;
        player.tonAddress = addr; player.tonConnected=true;
        document.getElementById('tonBtn').innerText='WITHDRAW $PUNK';
        Telegram.WebApp.showAlert('TON: '+addr.slice(0,8)+'...');
    } else {
        // withdraw tx (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π $PUNK –∫–æ–Ω—Ç—Ä–∞–∫—Ç)
        const tx = {validUntil:Math.floor(Date.now()/1000)+360, messages:[{address:'EQ...—Ç–≤–æ–π_–∫–æ–Ω—Ç—Ä–∞–∫—Ç',amount:(player.punk*1e9),payload:'te6cckEBAQEAAgAA...'}]};
        await tcui.sendTransaction(tx);
        player.punk=0; Telegram.WebApp.showAlert('–í—ã–≤–æ–¥ $PUNK –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
    }
    save();
};

// === –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê ===
function save(){localStorage.setItem('cosmopunk_v2',JSON.stringify(player));}
function load(){
    let s=localStorage.getItem('cosmopunk_v2');
    if(s){player=JSON.parse(s); initReferrals();}
    calculateAll();
}
function initReferrals(){
    const initData = Telegram.WebApp.initDataUnsafe;
    if(initData?.start_param && !player.referrals.includes(initData.start_param)){
        player.referrals.push(initData.start_param);
        player.energy +=1000; player.refIncome += player.passiveIncome*0.1;
        Telegram.WebApp.showAlert('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å: +1000 energy +10% –ø–∞—Å—Å–∏–≤–∫–∏!');
    }
}
setInterval(save,3000);

// === –ò–ù–ò–¢ ===
window.onload=()=>{
    Telegram.WebApp.ready(); Telegram.WebApp.expand(); Telegram.WebApp.MainButton.setText('SHARE').show().onClick(()=>Telegram.WebApp.shareUrl(Telegram.WebApp.initDataUnsafe.start_app_url||location.href,'–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –≤ CosmoPunk!'));
    load(); offlineCalc(); setInterval(updatePassive,1000); setInterval(updateUI,100);
};

// === –û–§–§–õ–ê–ô–ù ===
function offlineCalc(){
    let diff=Math.min((Date.now()-player.lastTime)/1000,12*3600);
    let earned=player.passiveIncome*diff*(1+0.5*player.magnet);
    player.energy+=earned; player.totalEnergy+=earned;
    if(earned>1000) Telegram.WebApp.showAlert(`–û—Ñ—Ñ–ª–∞–π–Ω: +${earned.toLocaleString()} energy`);
}

// === –¢–ê–ü–´ ===
function tapReactor(){
    let gain=player.tapPower*player.multipliers;
    player.energy+=gain; player.totalEnergy+=gain; raidTaps++; // –¥–ª—è —Ä–µ–π–¥–∞
    createParticle('+'+gain.toFixed(0));
    document.getElementById('reactor').classList.add('glitch'); setTimeout(()=>document.getElementById('reactor').classList.remove('glitch'),200);
}
function createParticle(text){
    let p=document.createElement('div'); p.className='particle'; p.innerText=text;
    p.style.left=Math.random()*window.innerWidth+'px'; p.style.top='60%';
    document.body.appendChild(p); setTimeout(()=>p.remove(),1500);
}

// === –†–ê–°—á—ë–¢–´ ===
function calculateAll(){
    // –ø–∞—Å—Å–∏–≤–∫–∞
    let inc=0; for(let k in player.ships) inc += (player.ships[k]||0) * gameData.ships[k].income;
    inc *= player.crew.kosmo?1.5:1; // –∫–∞–ø–∏—Ç–∞–Ω
    player.passiveIncome=inc * player.multipliers;
    // —Ç–∞–ø
    player.tapPower=1; for(let k in player.implants){
        let i=gameData.implants[k]; let lvl=player.implants[k]||0;
        if(i.effect==='tap') player.tapPower += i.mult + (i.mult*0.04*lvl); // —Ñ–æ—Ä–º—É–ª–∞
    }
    // –º–∞–≥–Ω–∏—Ç
    player.magnet=player.implants.glitch||0 * 0.025;
    // —Ä–∞–Ω–≥–∏
    updateRank();
    save();
}
function updatePassive(){
    player.energy += player.passiveIncome/60 + player.refIncome/60;
    player.totalEnergy += player.passiveIncome/60 + player.refIncome/60;
}
function updateUI(){
    document.getElementById('energy').innerText=player.energy.toLocaleString()+' PUNK';
    document.getElementById('punk').innerText=player.punk.toFixed(4)+' $PUNK';
    document.getElementById('income').innerText=player.passiveIncome.toFixed(1)+' /—Å–µ–∫';
    document.getElementById('refCount').innerText=player.referrals.length;
    // –∞–≤—Ç–æ–æ–±–º–µ–Ω
    if(player.energy>=1000){
        let c=Math.floor(player.energy/1000); player.punk += c*0.95; player.energy -= c*1000;
    }
    // —Ä–∞–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å
    let nextReq=gameData.ranks[player.rank+1]?.req || 1e15;
    let prog=(player.totalEnergy/gameData.ranks[player.rank+1].req)*100;
    document.getElementById('rank-bar').style.width=prog+'%';
}

// === –†–ê–ù–ì–ò ===
function updateRank(){
    for(let i=0;i<gameData.ranks.length;i++){
        if(player.totalEnergy >= gameData.ranks[i].req){ player.rank=i; }
    }
    document.getElementById('rankName').innerText=gameData.ranks[player.rank].name;
}

// === –ú–ê–ì–ê–ó–ò–ù–´ ===
function openShop(){ showPopup('–§–õ–û–¢',buildShop('ships'));}
function openCrew(){ showPopup('–≠–ö–ò–ü–ê–ñ',buildCrew());}
function openImplants(){ showPopup('–ò–ú–ü–õ–ê–ù–¢–´',buildShop('implants'));}
function buildShop(type){
    let html=''; let data=type==='ships'?gameData.ships:gameData.implants;
    for(let k in data){
        let item=data[k]; let owned=player[type][k]||0; let canBuy=owned<item.max||0;
        let price=item.price * Math.pow(1.1,player.rank); // –∏–Ω—Ñ–ª—è—Ü–∏—è
        html+=`<div class="shop-item">
            <h3>${item.name}</h3>
            <p>${item.desc||item.income+'/—Å–µ–∫'}</p>
            <p>–£—Ä–æ–≤–µ–Ω—å: \( {owned}/ \){item.max||'‚àû'}</p>
            <p>–¶–µ–Ω–∞: ${price.toLocaleString()}</p>
            \( {canBuy?`<button class="btn" style="width:100%;margin-top:10px" onclick="buyItem(' \){type}','\( {k}', \){price})">–ö–£–ü–ò–¢–¨</button>`:'–ú–ê–ö–°'}
        </div>`;
    }
    return html;
}
function buildCrew(){
    let html=''; for(let c of gameData.crew){
        let owned=player.crew[c.id]?1:0; let price=c.price * Math.pow(0.8,player.crew.mechanic||0); // —Å–∫–∏–¥–∫–∞ mechanic
        html+=`<div class="shop-item">
            <h3>\( {c.name}</h3><p> \){c.desc}</p>
            ${owned?'‚úÖ –ù–ê–ù–Ø–¢':'<button class="btn" style="width:100%" onclick="hireCrew(\''+c.id+'\','+price+')">–ù–ê–ù–Ø–¢–¨ '+price.toLocaleString()+'</button>'}
        </div>`;
    } return html;
}
function buyItem(type,id,price){
    if(player.energy>=price){
        player.energy-=price; player[type][id]=(player[type][id]||0)+1;
        gameData[type][id].price=Math.floor(price*1.15);
        calculateAll(); closePopup();
    } else Telegram.WebApp.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ!');
}
function hireCrew(id,price){
    if(player.energy>=price){
        player.energy-=price; player.crew[id]=1; calculateAll(); closePopup(); Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}
function showPopup(title,content){
    document.getElementById('popup').innerHTML=`<div style="text-align:center"><h2 style="color:var(--neon1)">\( {title}</h2> \){content}<button class="btn" style="width:200px;margin-top:30px" onclick="closePopup()">–ó–ê–ö–†–´–¢–¨</button></div>`;
    document.getElementById('popup').style.display='block';
}
function closePopup(){document.getElementById('popup').style.display='none';}

// === CRYPTO-RAIDS ===
function startRaid(){
    if(raidActive) return;
    raidActive=true; raidTaps=0;
    document.getElementById('raidBtn').innerText='–¢–ê–ü–ê–ô –ë–û–°–°–ê!';
    let bossHp=100 * (1+player.rank*0.5);
    let int=setInterval(()=>{
        let prog=raidTaps/bossHp*100;
        if(raidTaps>=bossHp){
            clearInterval(int); let bonus=player.energy*4; player.energy+=bonus;
            Telegram.WebApp.showAlert(`RAID –£–°–ü–ï–•! +${bonus.toLocaleString()}`);
            raidActive=false; document.getElementById('raidBtn').innerText='‚öîÔ∏è RAID';
        }
    },100);
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ
window.buyItem=buyItem; window.hireCrew=hireCrew; window.closePopup=closePopup; window.openShop=openShop; window.openCrew=openCrew; window.openImplants=openImplants; window.startRaid=startRaid;
</script>
</body>
</html>