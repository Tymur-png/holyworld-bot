<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CosmoPunk: Syndicate Wars</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #05000a;
            --accent: #d300d3;
            --cyan: #00f7ff;
            --yellow: #f7ff00;
            --red: #ff2a2a;
            --glass: rgba(16, 20, 30, 0.95);
            --border: rgba(0, 247, 255, 0.3);
            --font: 'Courier New', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            color: #fff;
            font-family: var(--font);
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* MATRIX BG */
        #matrix-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; opacity: 0.15; pointer-events: none;
        }

        #app { display: flex; flex-direction: column; height: 100vh; padding: 12px; position: relative; z-index: 2; }

        /* HUD */
        .hud { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .res-box {
            background: var(--glass); border: 1px solid var(--border);
            padding: 8px 12px; border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,247,255,0.1);
            min-width: 100px;
        }
        #energy-val { font-size: 20px; font-weight: 900; color: var(--cyan); text-shadow: 0 0 10px var(--cyan); }
        .sub-text { font-size: 10px; color: #aaa; margin-top: 2px; }
        .rank-box { text-align: right; border-color: var(--accent); }
        #rank-val { color: var(--accent); font-weight: bold; font-size: 12px; text-transform: uppercase; }

        /* REACTOR */
        #stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; perspective: 1000px; }
        
        .reactor-wrap { 
            position: relative; width: 280px; height: 280px; 
            display: flex; justify-content: center; align-items: center; 
            transition: transform 0.1s; transform-style: preserve-3d;
        }
        .reactor-wrap:active { transform: scale(0.95); }
        
        .shake { animation: shake 0.15s cubic-bezier(.36,.07,.19,.97) both; }

        #reactor-img { 
            width: 100%; height: 100%; object-fit: contain; z-index: 5;
            filter: drop-shadow(0 0 30px rgba(211,0,211,0.5));
        }

        /* HACK BUTTON */
        #hack-btn {
            margin-top: 25px;
            background: linear-gradient(90deg, #ff004c, #ff9100);
            border: none; padding: 12px 24px; border-radius: 25px;
            color: #fff; font-weight: bold; font-size: 14px; letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(255, 0, 76, 0.4);
            opacity: 0.5; filter: grayscale(1); pointer-events: none; transition: 0.3s;
        }
        #hack-btn.ready { opacity: 1; filter: grayscale(0); pointer-events: auto; animation: pulse-btn 1.5s infinite; }

        /* NAV */
        .nav { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding-bottom: 10px; }
        .nav-btn {
            background: rgba(0,0,0,0.6); border: 1px solid var(--border); border-radius: 12px;
            height: 55px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; color: #888; transition: 0.2s; backdrop-filter: blur(4px);
        }
        .nav-btn span { font-size: 20px; margin-bottom: 4px; }
        .nav-btn:active { background: var(--cyan); color: #000; border-color: #fff; }

        /* MODALS */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; align-items: flex-end; justify-content: center;
            animation: fadeIn 0.2s;
        }
        .modal-card {
            background: #0b0514; border-top: 2px solid var(--accent);
            width: 100%; max-height: 85vh; border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 -10px 50px rgba(211, 0, 211, 0.2);
            animation: slideUp 0.3s;
        }
        .modal-header { 
            padding: 15px; text-align: center; font-weight: bold; font-size: 16px; 
            border-bottom: 1px solid #222; letter-spacing: 2px; color: var(--accent);
        }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }

        /* ITEMS LIST */
        .item { 
            display: flex; gap: 12px; align-items: center; 
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            padding: 10px; border-radius: 12px; margin-bottom: 10px;
        }
        .item img { 
            width: 50px; height: 50px; object-fit: contain; 
            background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid #333;
        }
        .item-info { flex: 1; }
        .item-name { font-size: 14px; font-weight: bold; color: #fff; margin-bottom: 4px;}
        .item-desc { font-size: 11px; color: #888; }
        .btn-buy {
            background: var(--cyan); color: #000; border: none; padding: 8px 14px;
            border-radius: 8px; font-size: 12px; font-weight: bold; min-width: 80px;
        }
        .btn-owned { background: #333; color: #555; pointer-events: none; }

        /* MINI GAME UI */
        #hack-game-ui { width: 100%; padding: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .hack-track {
            width: 100%; height: 24px; background: #111; border-radius: 12px;
            position: relative; overflow: hidden; margin: 25px 0; border: 2px solid #444;
        }
        .hack-target {
            position: absolute; top: 0; bottom: 0; width: 40px; 
            background: var(--yellow); opacity: 0.8; left: 50%; transform: translateX(-50%);
            box-shadow: 0 0 15px var(--yellow);
        }
        .hack-cursor {
            position: absolute; top: -2px; bottom: -2px; width: 4px;
            background: var(--red); left: 0%; 
            box-shadow: 0 0 10px var(--red); z-index: 2;
        }
        .hack-btn-action {
            width: 100%; padding: 18px; background: var(--red); color: #fff;
            border: none; font-size: 18px; font-weight: 900; border-radius: 12px;
        }

        /* DAILY REWARD */
        .daily-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .daily-day {
            background: #111; border: 1px solid #333; padding: 12px 5px;
            border-radius: 8px; text-align: center; opacity: 0.5; font-size: 11px;
        }
        .daily-day.active { border-color: var(--yellow); opacity: 1; background: rgba(247, 255, 0, 0.1); transform: scale(1.05); }
        .daily-day.claimed { border-color: var(--cyan); opacity: 0.3; background: rgba(0, 247, 255, 0.1); }
        .reward-val { font-size: 13px; font-weight: bold; color: var(--yellow); margin-top: 4px; }

        /* FX */
        .float-txt { 
            position: absolute; font-weight: 900; font-size: 26px; 
            pointer-events: none; z-index: 50; text-shadow: 0 2px 0 #000;
        }
        
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-3px, 0, 0); } 40%, 60% { transform: translate3d(3px, 0, 0); } }
        @keyframes pulse-btn { 0% {box-shadow: 0 0 0 0 rgba(255, 0, 76, 0.7);} 70% {box-shadow: 0 0 0 15px rgba(255, 0, 76, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 0, 76, 0);} }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div id="app">
    <div class="hud">
        <div class="res-box">
            <div id="energy-val">0</div>
            <div class="sub-text" id="inc-val">+0 / —Å–µ–∫</div>
        </div>
        <div class="res-box rank-box">
            <div id="rank-val">NOBODY</div>
            <div class="sub-text">–†–ê–ù–ì –°–ò–°–¢–ï–ú–´</div>
        </div>
    </div>

    <div id="stage">
        <div class="reactor-wrap" id="tap-zone">
            <img src="assets/reactor/reactor.gif" id="reactor-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/9309/9309584.png'">
        </div>
        <button id="hack-btn" onclick="startHackGame()">‚ò† –í–ó–õ–û–ú –°–ò–°–¢–ï–ú–´</button>
    </div>

    <div class="nav">
        <div class="nav-btn" onclick="openMenu('ships')"><span>üöÄ</span>–§–ª–æ—Ç</div>
        <div class="nav-btn" onclick="openMenu('crew')"><span>üë•</span>–ë–∞–Ω–¥–∞</div>
        <div class="nav-btn" onclick="openMenu('implants')"><span>üß†</span>–ß–∏–ø—ã</div>
        <div class="nav-btn" onclick="openMenu('daily')"><span>üéÅ</span>–ë–æ–Ω—É—Å</div>
    </div>
</div>

<div class="modal-overlay" id="main-modal" onclick="if(event.target.id==='main-modal') closeModal()">
    <div class="modal-card">
        <div class="modal-header" id="modal-title">TITLE</div>
        <div class="modal-body" id="modal-content"></div>
        <button style="padding:15px; background:#111; color:#fff; border:none; border-top:1px solid #333;" onclick="closeModal()">–ó–ê–ö–†–´–¢–¨ –ò–ù–¢–ï–†–§–ï–ô–°</button>
    </div>
</div>

<div class="modal-overlay" id="hack-modal">
    <div class="modal-card" style="height: auto; border-color: var(--red);">
        <div class="modal-header" style="color:var(--red)">–ü–†–û–†–´–í FIREWALL</div>
        <div class="modal-body">
            <div id="hack-game-ui">
                <p style="color:#ccc; font-size:12px; margin-bottom:10px;">–û—Å—Ç–∞–Ω–æ–≤–∏ –∫—É—Ä—Å–æ—Ä –≤ –∂–µ–ª—Ç–æ–π –∑–æ–Ω–µ –¥–ª—è –∏–Ω—ä–µ–∫—Ü–∏–∏ –∫–æ–¥–∞.</p>
                <div class="hack-track">
                    <div class="hack-target" id="hack-target-zone"></div>
                    <div class="hack-cursor" id="hack-cursor"></div>
                </div>
                <button class="hack-btn-action" onmousedown="stopHack()" ontouchstart="stopHack()">–í–ó–õ–û–ú–ê–¢–¨</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- AUDIO ENGINE ---
    const AudioFX = {
        ctx: null,
        init: function() {
            if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        },
        play: function(type) {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            const now = this.ctx.currentTime;
            
            if(type === 'tap') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            } else if (type === 'buy') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.value = 100;
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }
    };

    // --- GAME CONFIG & DATA ---
    const tg = window.Telegram.WebApp;
    tg.expand();
    const SAVE_KEY = 'cp_wars_final';

    // –ü–û–õ–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–• –° –ö–ê–†–¢–ò–ù–ö–ê–ú–ò
    const DB = {
        ships: [
            { id: 's1', name: '–î—Ä–æ–Ω-—Ä–∞–∑–≤–µ–¥—á–∏–∫', inc: 1, cost: 150, img: 'assets/ships/ship1.png' },
            { id: 's2', name: '–®–µ—Ä—à–µ–Ω—å', inc: 5, cost: 750, img: 'assets/ships/ship2.png' },
            { id: 's3', name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∏–∫', inc: 15, cost: 2500, img: 'assets/ships/ship3.png' },
            { id: 's4', name: '–§—Ä–µ–≥–∞—Ç –ù–µ–æ–Ω', inc: 45, cost: 9000, img: 'assets/ships/ship4.png' },
            { id: 's5', name: '–ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫', inc: 120, cost: 30000, img: 'assets/ships/ship5.png' },
            { id: 's6', name: '–≠—Å–º–∏–Ω–µ—Ü –ë—É—Ä—è', inc: 400, cost: 100000, img: 'assets/ships/ship6.png' },
            { id: 's7', name: '–ö—Ä–µ–π—Å–µ—Ä –¢–µ—Å–ª–∞', inc: 1500, cost: 450000, img: 'assets/ships/ship7.png' },
            { id: 's8', name: '–õ–∏–Ω–∫–æ—Ä –î–æ–º–∏–Ω–∞—Ç–æ—Ä', inc: 5000, cost: 1500000, img: 'assets/ships/ship8.png' },
            { id: 's9', name: '–ê–≤–∏–∞–Ω–æ—Å–µ—Ü –£–ª—å—è', inc: 20000, cost: 7000000, img: 'assets/ships/ship9.png' },
            { id: 's10', name: '–ó–≤–µ–∑–¥–∞ –°–∏–Ω–¥–∏–∫–∞—Ç–∞', inc: 100000, cost: 50000000, img: 'assets/ships/ship10.png' }
        ],
        crew: [
            { id: 'c1', name: '–•–∞–∫–µ—Ä –õ–∏—Å–∞', desc: '–ö—Ä–∏—Ç —à–∞–Ω—Å +5%', cost: 1000, type: 'crit', val: 0.05, img: 'assets/crew/hacker.png' },
            { id: 'c2', name: '–ë–æ—Ç-—à–∞—Ö—Ç–µ—Ä', desc: '–ê–≤—Ç–æ-–¥–æ—Ö–æ–¥ +30/—Å–µ–∫', cost: 2000, type: 'passive', val: 30, img: 'assets/crew/bot.png' },
            { id: 'c3', name: '–ö–∞–ø–∏—Ç–∞–Ω', desc: '–ë–∞–∑–∞ –∫–ª–∏–∫–∞ x2', cost: 10000, type: 'mult', val: 1.0, img: 'assets/crew/captain.png' }
        ],
        implants: [
            { id: 'i1', name: '–ù–µ–π—Ä–æ-—á–∏–ø v1', desc: '+2 –∫ —Å–∏–ª–µ –∫–ª–∏–∫–∞', cost: 500, clickAdd: 2, img: 'assets/implants/base.png' },
            { id: 'i2', name: '–ö–∏–±–µ—Ä-–ì–ª–∞–∑', desc: '–ö—Ä–∏—Ç x2 –º–æ—â–Ω–µ–µ', cost: 3500, critPower: 1, img: 'assets/implants/eye.png' },
            { id: 'i3', name: '–¢–∏—Ç–∞–Ω-–†—É–∫–∞', desc: '+50 –∫ —Å–∏–ª–µ –∫–ª–∏–∫–∞', cost: 15000, clickAdd: 50, img: 'assets/implants/neuro.png' },
            { id: 'i4', name: '–ì–ª–∏—Ç—á-–ú–æ–¥—É–ª—å', desc: '–ê–≤—Ç–æ-–¥–æ—Ö–æ–¥ x1.2', cost: 50000, globalMult: 0.2, img: 'assets/implants/glitch.png' },
            { id: 'i5', name: '–ö–≤–∞–Ω—Ç–æ–≤–æ–µ –Ø–¥—Ä–æ', desc: '–ê–≤—Ç–æ-–¥–æ—Ö–æ–¥ x2', cost: 1000000, globalMult: 1.0, img: 'assets/implants/chip.png' }
        ],
        daily: [500, 1500, 3000, 6000, 15000, 40000, 100000]
    };

    let state = {
        energy: 0,
        total: 0,
        ships: {},
        crew: {},
        implants: [],
        lastHack: 0,
        daily: { day: 0, lastClaim: 0 },
        lastSave: Date.now()
    };

    // --- INIT ---
    let saved = localStorage.getItem(SAVE_KEY);
    if(saved) {
        let parsed = JSON.parse(saved);
        state = { ...state, ...parsed };
        if(!state.implants) state.implants = []; // migration
    }

    // Offline Earnings
    let offlineSeconds = (Date.now() - state.lastSave) / 1000;
    if(offlineSeconds > 60) {
        let earn = calcIncome() * offlineSeconds;
        if(earn > 0) {
            state.energy += earn;
            state.total += earn;
            setTimeout(() => alert(`–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, –ë–æ—Å—Å!\n–°–∏–Ω–¥–∏–∫–∞—Ç –∑–∞—Ä–∞–±–æ—Ç–∞–ª: ${Math.floor(earn).toLocaleString()} PUNK`), 500);
        }
    }

    // Loops
    setInterval(() => {
        let inc = calcIncome() / 10;
        if(inc > 0) addEnergy(inc);
        updateHUD();
        checkHackStatus();
    }, 100);
    
    setInterval(saveGame, 5000);
    initMatrix();

    // --- LOGIC ---
    function calcIncome() {
        let income = 0;
        DB.ships.forEach(s => {
            if(state.ships[s.id]) income += state.ships[s.id] * s.inc;
        });
        if(state.crew['c2']) income += state.crew['c2'] * 30;
        
        // Multipliers from Implants
        let mult = 1;
        state.implants.forEach(impId => {
            let item = DB.implants.find(i => i.id === impId);
            if(item && item.globalMult) mult += item.globalMult;
        });
        
        return income * mult;
    }

    function addEnergy(amount) {
        state.energy += amount;
        state.total += amount;
    }

    function tap(e) {
        AudioFX.init();
        e.preventDefault();
        let touches = e.changedTouches || [e];

        // 1. Calculate Base Power
        // Base = 1 + Captain + Implants(flat)
        let flatBonus = 0;
        let critMult = 10; // Base crit multiplier

        if(state.implants) {
            state.implants.forEach(impId => {
                let item = DB.implants.find(i => i.id === impId);
                if(item && item.clickAdd) flatBonus += item.clickAdd;
                if(item && item.critPower) critMult += (10 * item.critPower); // Add to multiplier
            });
        }

        let captainBonus = (state.crew['c3'] || 0) * 2; 
        let power = 1 + captainBonus + flatBonus;

        for(let t of touches) {
            // 2. Critical Hit
            let critChance = 0.05 + (state.crew['c1'] || 0) * 0.05;
            let isCrit = Math.random() < critChance;
            
            if(isCrit) {
                power *= critMult;
                tg.HapticFeedback.notificationOccurred('warning');
            } else {
                tg.HapticFeedback.impactOccurred('light');
            }

            addEnergy(power);
            spawnFloat(t.clientX, t.clientY, Math.floor(power), isCrit);
            AudioFX.play('tap');
        }

        const r = document.getElementById('reactor-img');
        r.classList.remove('shake');
        void r.offsetWidth;
        r.classList.add('shake');
    }

    // --- HACKING ---
    let hackAnim;
    let hackDir = 1, hackPos = 0;
    
    function checkHackStatus() {
        let now = Date.now();
        let btn = document.getElementById('hack-btn');
        let diff = now - state.lastHack;
        // 5 min cooldown
        if(diff > 300000) {
            btn.classList.add('ready');
            btn.innerText = "‚ò† –í–ó–õ–û–ú –î–û–°–¢–£–ü–ï–ù";
        } else {
            btn.classList.remove('ready');
            let left = Math.ceil((300000 - diff)/1000);
            let min = Math.floor(left/60);
            let sec = left%60;
            btn.innerText = `‚è≥ ${min}:${sec < 10 ? '0'+sec : sec}`;
        }
    }

    function startHackGame() {
        if(Date.now() - state.lastHack < 300000) return;
        document.getElementById('hack-modal').style.display = 'flex';
        hackPos = 0; hackDir = 1.2;
        let targetLeft = 20 + Math.random() * 50;
        document.getElementById('hack-target-zone').style.left = targetLeft + '%';
        window.hackTargetMin = targetLeft;
        window.hackTargetMax = targetLeft + 15;

        function animate() {
            hackPos += hackDir;
            if(hackPos > 100 || hackPos < 0) hackDir *= -1;
            document.getElementById('hack-cursor').style.left = hackPos + '%';
            hackAnim = requestAnimationFrame(animate);
        }
        animate();
    }

    function stopHack() {
        cancelAnimationFrame(hackAnim);
        if(hackPos >= window.hackTargetMin && hackPos <= window.hackTargetMax) {
            let reward = calcIncome() * 300; 
            if(reward < 1000) reward = 1000;
            addEnergy(reward);
            alert(`–°–ò–°–¢–ï–ú–ê –í–ó–õ–û–ú–ê–ù–ê!\n–°–ö–ê–ß–ê–ù–û: ${Math.floor(reward)} PUNK`);
            tg.HapticFeedback.notificationOccurred('success');
            AudioFX.play('buy');
            state.lastHack = Date.now();
        } else {
            tg.HapticFeedback.notificationOccurred('error');
            AudioFX.play('error');
            state.lastHack = Date.now() - 240000; // 1 min penalty remaining
        }
        document.getElementById('hack-modal').style.display = 'none';
        checkHackStatus();
    }

    // --- MENUS ---
    function openMenu(type) {
        document.getElementById('main-modal').style.display = 'flex';
        const title = document.getElementById('modal-title');
        const content = document.getElementById('modal-content');
        content.innerHTML = '';

        if(type === 'ships') {
            title.innerText = "–ê–ù–ì–ê–† –§–õ–û–¢–ê";
            DB.ships.forEach(s => {
                let cnt = state.ships[s.id] || 0;
                let price = Math.floor(s.cost * Math.pow(1.15, cnt));
                renderItem(content, s.name, `+${s.inc}/—Å–µ–∫ | –ê–Ω–≥–∞—Ä: ${cnt}`, price, s.img, false, () => {
                    if(state.energy >= price) {
                        state.energy -= price;
                        state.ships[s.id] = cnt + 1;
                        AudioFX.play('buy');
                        openMenu('ships');
                    }
                });
            });
        }
        else if(type === 'crew') {
            title.innerText = "–ù–ê–ô–ú –ë–ê–ù–î–´";
            DB.crew.forEach(c => {
                let lvl = state.crew[c.id] || 0;
                let price = Math.floor(c.cost * Math.pow(1.4, lvl));
                renderItem(content, `${c.name} (Lvl ${lvl})`, c.desc, price, c.img, false, () => {
                    if(state.energy >= price) {
                        state.energy -= price;
                        state.crew[c.id] = lvl + 1;
                        AudioFX.play('buy');
                        openMenu('crew');
                    }
                });
            });
        }
        else if(type === 'implants') {
            title.innerText = "–ö–ò–ë–ï–†-–ò–ú–ü–õ–ê–ù–¢–´";
            DB.implants.forEach(item => {
                let isOwned = state.implants.includes(item.id);
                renderItem(content, item.name, isOwned ? "–£–°–¢–ê–ù–û–í–õ–ï–ù–û" : item.desc, item.cost, item.img, isOwned, () => {
                    if(isOwned) return;
                    if(state.energy >= item.cost) {
                        state.energy -= item.cost;
                        state.implants.push(item.id);
                        AudioFX.play('buy');
                        openMenu('implants');
                    }
                });
            });
        }
        else if(type === 'daily') {
            title.innerText = "–ï–ñ–ï–î–ù–ï–í–ù–ê–Ø –ü–û–°–¢–ê–í–ö–ê";
            checkDailyLogic(content);
        }
    }

    function renderItem(container, name, desc, price, img, isOwned, onClick) {
        let div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
            <img src="${img}" onerror="this.src='https://via.placeholder.com/50?text=ERR'">
            <div class="item-info">
                <div class="item-name">${name}</div>
                <div class="item-desc">${desc}</div>
            </div>
            <button class="btn-buy ${isOwned ? 'btn-owned' : ''}">${isOwned ? 'V' : price.toLocaleString()}</button>
        `;
        if(!isOwned) div.querySelector('button').onclick = onClick;
        container.appendChild(div);
    }

    function checkDailyLogic(container) {
        let now = new Date();
        let last = new Date(state.daily.lastClaim);
        let isSameDay = now.toDateString() === last.toDateString();
        
        if((now - last) > 86400000 * 2) state.daily.day = 0; // Reset streak

        let grid = document.createElement('div');
        grid.className = 'daily-grid';

        DB.daily.forEach((reward, idx) => {
            let el = document.createElement('div');
            el.className = 'daily-day';
            el.innerHTML = `<div>–î–ï–ù–¨ ${idx+1}</div><div class="reward-val">${reward/1000}K</div>`;
            
            if(idx < state.daily.day) el.classList.add('claimed');
            if(idx === state.daily.day) el.classList.add('active');
            
            if(idx === state.daily.day && !isSameDay) {
                el.onclick = () => {
                    state.daily.lastClaim = Date.now();
                    state.daily.day++;
                    addEnergy(reward);
                    AudioFX.play('buy');
                    tg.HapticFeedback.notificationOccurred('success');
                    openMenu('daily');
                };
            }
            grid.appendChild(el);
        });
        container.appendChild(grid);
        
        let msg = document.createElement('p');
        msg.style.textAlign = 'center'; msg.style.marginTop = '15px'; msg.style.color = '#777'; font-size: '12px';
        msg.innerText = isSameDay ? "–ü—Ä–∏—Ö–æ–¥–∏ –∑–∞–≤—Ç—Ä–∞ –∑–∞ –Ω–æ–≤–æ–π –ø–æ—Å—Ç–∞–≤–∫–æ–π." : "–ó–∞–±–∏—Ä–∞–π –∞–∫—Ç–∏–≤–Ω—É—é –Ω–∞–≥—Ä–∞–¥—É!";
        container.appendChild(msg);
    }

    function closeModal() { document.getElementById('main-modal').style.display = 'none'; }

    // --- UTILS ---
    function updateHUD() {
        document.getElementById('energy-val').innerText = Math.floor(state.energy).toLocaleString();
        document.getElementById('inc-val').innerText = `+${Math.floor(calcIncome())} / —Å–µ–∫`;
        
        let ranks = ["–û—Ç–±—Ä–æ—Å", "–°–±–æ—Ä—â–∏–∫", "–•–∞–∫–µ—Ä", "–ö–∏–±–µ—Ä-–ü–∞–Ω–∫", "–ë–æ—Å—Å –£–ª–∏—Ü", "–ì–ª–∞–≤–∞ –°–∏–Ω–¥–∏–∫–∞—Ç–∞", "–ö–æ—Ä–ø–æ—Ä–∞—Ç", "–í–ª–∞—Å—Ç–µ–ª–∏–Ω –°–µ—Ç–∏"];
        let rIdx = Math.min(Math.floor(Math.log10(state.total + 1)), ranks.length-1);
        if(state.total < 1000) rIdx = 0;
        document.getElementById('rank-val').innerText = ranks[rIdx];
    }

    function spawnFloat(x, y, val, isCrit) {
        let el = document.createElement('div');
        el.className = 'float-txt';
        el.style.left = (x - 20) + 'px'; el.style.top = (y - 40) + 'px';
        el.innerText = `+${val}`;
        el.style.color = isCrit ? 'var(--red)' : 'var(--cyan)';
        if(isCrit) el.style.fontSize = '32px';
        document.body.appendChild(el);
        setTimeout(() => {
            el.style.transition = 'all 0.6s';
            el.style.transform = 'translateY(-100px)';
            el.style.opacity = 0;
        }, 50);
        setTimeout(() => el.remove(), 600);
    }

    function saveGame() {
        state.lastSave = Date.now();
        localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    }

    // --- MATRIX BG ---
    function initMatrix() {
        const c = document.getElementById('matrix-canvas');
        const ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const chars = "01XYZ"; 
        const fontSize = 14;
        const columns = c.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);
        function draw() {
            ctx.fillStyle = "rgba(5, 0, 10, 0.1)";
            ctx.fillRect(0, 0, c.width, c.height);
            ctx.fillStyle = "#0f0"; ctx.font = fontSize + "px monospace";
            for(let i=0; i<drops.length; i++) {
                const text = chars[Math.floor(Math.random()*chars.length)];
                ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                if(drops[i]*fontSize > c.height && Math.random() > 0.98) drops[i] = 0;
                drops[i]++;
            }
        }
        setInterval(draw, 50);
    }

    // EVENTS
    const zone = document.getElementById('tap-zone');
    zone.addEventListener('touchstart', tap, {passive:false});
    zone.addEventListener('mousedown', tap);

</script>
</body>
</html>