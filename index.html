<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>CosmoPunk Tap Game — Full</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg:#0a001a; --n1:#ff00ff; --n2:#00ffff; --text:#fff; --panel:rgba(255,255,255,0.04);
  --glow: 0 0 34px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body,#app{height:100%}
body{
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: radial-gradient(circle at 30% 20%, #1a0033 0%, var(--bg) 45%, #000 100%);
  color:var(--text);
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* themes */
body.theme-neon { --bg:#0a001a; --n1:#ff00ff; --n2:#00ffff; }
body.theme-holo { --bg:#001022; --n1:#7fe3ff; --n2:#a7ffa8; }
body.theme-cartoon { --bg:#0a1022; --n1:#ffd166; --n2:#7ee7a6; }
body.theme-dark { --bg:#03040a; --n1:#ff3333; --n2:#33ff99; }
body.theme-3d { --bg:#08111a; --n1:#ff66cc; --n2:#66ddff; }

/* layout */
#app{position:relative;width:100vw;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hud{position:absolute;top:12px;left:12px;right:12px;display:flex;align-items:center;justify-content:space-between;z-index:120}
.hud-left{display:flex;flex-direction:column;gap:6px}
.badge{padding:6px 10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.1));border:1px solid rgba(255,255,255,0.03);font-weight:700}
.title{font-size:14px;color:var(--n2);letter-spacing:0.6px}
.balance{font-size:18px;font-weight:800;text-shadow:var(--glow) var(--n1)}
.small-muted{font-size:12px;color:rgba(255,255,255,0.7)}

/* theme selector */
.theme-switch{display:flex;gap:8px;align-items:center}
.theme-button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;cursor:pointer;color:var(--text);font-weight:700;min-width:36px;text-align:center}
.theme-button.active{box-shadow:var(--glow) var(--n1);transform:scale(1.04)}

/* reactor */
.stage{position:relative;display:flex;align-items:center;justify-content:center;width:100%;height:100%;}
.reactor-wrap{width:min(76vmin,520px);height:min(76vmin,520px);position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50}
.reactor{width:100%;height:100%;border-radius:28px;background:
  radial-gradient(ellipse at 50% 20%, rgba(255,255,255,0.03) 0%, transparent 35%),
  linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15));
  display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;
  border:2px solid rgba(255,255,255,0.04);box-shadow: var(--glow) var(--n1);
  transition:transform .12s ease, box-shadow .12s ease;
}
.reactor img{width:78%;height:78%;object-fit:contain;filter:drop-shadow(var(--glow) var(--n1))}
.reactor:active{transform:scale(.98)}
.reactor.glitch{animation:glitch .18s steps(2);transform:translate3d(0,0,0)}
@keyframes glitch{20%{transform:translate(-6px,6px)}40%{transform:translate(6px,-6px)}60%{transform:translate(-6px,-6px)}80%{transform:translate(3px,3px)}}

/* floating numbers */
.floating{position:absolute;pointer-events:none;font-size:28px;color:var(--n2);text-shadow:var(--glow) var(--n1);}
.critBoom{position:fixed;color:#ff0077;font-size:34px;font-weight:900;text-shadow:0 0 8px #ff00ff;pointer-events:none;z-index:2000}

/* bottom controls */
.bottom-bar{position:absolute;bottom:0;left:0;right:0;padding:12px 0;background:linear-gradient(180deg, rgba(0,0,0,0.01), var(--bg) 90%);backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,0.05);z-index:70}
.scroll-container{display:flex;gap:10px;overflow-x:auto;white-space:nowrap;padding:0 14px}
.btn{background:var(--panel);border:1px solid rgba(255,255,255,0.04);padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;backdrop-filter:blur(6px);flex-shrink:0;color:var(--text);display:flex;gap:8px;align-items:center}
.btn.primary{background:linear-gradient(90deg,var(--n1),var(--n2));color:#000;border:none;box-shadow:var(--glow) var(--n2)}

/* pop */
#pop{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(0,0,0,0.6),rgba(0,0,0,0.9));z-index:999}
.pop-card{width:min(760px,96%);max-height:86%;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2));padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.04)}
.pop-item{padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02)}

/* inventory thumbnails */
.thumb-list{display:flex;flex-wrap:wrap;gap:10px;padding:8px}
.thumb{width:140px;background:rgba(255,255,255,0.02);padding:8px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.03)}
.thumb img{width:80px;height:80px;object-fit:contain;margin-bottom:6px}

/* profile window */
.profile-window{width:92%;max-width:920px;border-radius:14px;border:2px solid var(--n2);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.22));padding:16px;display:grid;grid-template-columns:220px 1fr;gap:14px}
.profile-avatar{width:200px;height:200px;border-radius:12px;object-fit:cover;border:3px solid rgba(255,255,255,0.06)}
.stat-block{background:rgba(255,255,255,0.03);padding:12px;border-radius:12px}

/* responsive */
@media (max-width:760px){
  .profile-window{grid-template-columns:1fr}
  .profile-avatar{width:140px;height:140px}
}
</style>
</head>
<body class="theme-neon">
<div id="app">
  <div class="hud">
    <div class="hud-left">
      <div class="badge title">CosmoPunk Tap Game</div>
      <div class="badge balance" id="energy">0 PUNK</div>
      <div class="small-muted" id="punk">$0.0000 $PUNK • курс 1000:1</div>
    </div>
    <div class="theme-switch" id="themeSwitch">
      <button class="theme-button active" data-theme="neon" title="Neon">N</button>
      <button class="theme-button" data-theme="holo" title="Holo">H</button>
      <button class="theme-button" data-theme="cartoon" title="Cartoon">C</button>
      <button class="theme-button" data-theme="dark" title="Dark">D</button>
      <button class="theme-button" data-theme="3d" title="3D">3D</button>
    </div>
  </div>

  <div class="stage">
    <div class="reactor-wrap">
      <div id="reactor" class="reactor"><img src="/assets/reactor/reactor.gif" alt="reactor"></div>
      <div style="margin-top:12px;text-align:center">
        <div id="inc" class="small-muted">0 /сек (PPH: 0)</div>
        <div id="rank" class="badge" style="margin-top:6px">Street Rat</div>
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <div class="scroll-container" id="controlsRow">
      <button class="btn" data-action="fleet"><img src="/assets/ui/fleet.png" width="18" alt="">ФЛОТ</button>
      <button class="btn" data-action="crew"><img src="/assets/ui/crew.png" width="18" alt="">ЭКИПАЖ</button>
      <button class="btn" data-action="impl"><img src="/assets/ui/impl.png" width="18" alt="">ИМПЛАНТЫ</button>
      <button class="btn primary" data-action="raid"><img src="/assets/ui/raid.png" width="18" alt="">RAID</button>
      <button class="btn" data-action="quests"><img src="/assets/ui/quests.png" width="18" alt="">КВЕСТЫ</button>
      <button class="btn" data-action="market"><img src="/assets/ui/market.png" width="18" alt="">МАРКЕТ</button>
      <button class="btn" data-action="profile"><img src="/assets/ui/profile.png" width="18" alt="">ПРОФИЛЬ</button>
    </div>
  </div>
</div>

<div id="pop" onclick="if(event.target.id==='pop') popClose()">
  <div class="pop-card" id="popcard"></div>
</div>

<script>
/* =========================
   Game core + inventory
   ========================= */

/* ---- Save key ---- */
const SAVE_KEY = 'cosmopunk_full_v1';

/* ---- Player state ---- */
let s = {
  energy:0, punk:0, totalEarned:0,
  tapBase:3, tapMult:1,
  ships:{ r:0, c:0, h:0, f:0, d:0 },   // counts owned
  impl:{},                            // { id: { level } }
  crew:{},                            // { id: true }
  equipped:{ ships:[], impl:[], crew:[] }, // arrays of ids
  fleetCapacity:3,                    // starts at 3, upgradable to 9
  lastSave: Date.now()
};

/* ---- Ship definitions, include rarity and base income ----
   Rarity multiplier mapping (variant 3):
   S: 1.6, A: 1.25, B: 1.0, C: 0.7, D: 0.45
*/
const SHIPS = {
  r:{id:'void_reaper', name:'Void Reaper', rarity:'S', basePrice:20000000, income:1000, rarityMult:1.6},
  c:{id:'neon_corsair', name:'Neon Corsair', rarity:'A', basePrice:10000000, income:500, rarityMult:1.25},
  h:{id:'punk_hauler', name:'Punk Hauler', rarity:'B', basePrice:5000000, income:200, rarityMult:1.0},
  f:{id:'scrap_fighter', name:'Scrap Fighter', rarity:'C', basePrice:2000000, income:100, rarityMult:0.7},
  d:{id:'rusty_drone', name:'Rusty Drone', rarity:'D', basePrice:1000000, income:50, rarityMult:0.45}
};

/* ---- Implants ---- */
const IMPLANTS = {
  neuro:{id:'neuro', name:'Нео-Нейрон (S)', basePrice:1e6, type:'tap', effectBase:2.0, levelMult:0.04, maxLvl:50, desc:'+200% тапы'},
  glitch:{id:'glitch', name:'Глитч-Протез (A)', basePrice:5e5, type:'pph', effectBase:1.0, levelMult:0.025, maxLvl:40, desc:'+100% пассив'},
  eye:{id:'eye', name:'Кибер-Глаз (B)', basePrice:2e5, type:'hack', effectBase:0.5, levelMult:0.016, maxLvl:30, desc:'+ шанс хак'},
  chip:{id:'chip', name:'Ржавый Чип (C)', basePrice:1e5, type:'pph', effectBase:0.2, levelMult:0.008, maxLvl:25, desc:'+20% пассив'},
  base:{id:'base', name:'Базовый Имплант (D)', basePrice:5e4, type:'tap', effectBase:0.1, levelMult:0.005, maxLvl:20, desc:'+10% тапы'}
};

/* ---- Crew ---- */
const CREW = {
  captain:{id:'captain', name:'Капитан Космо (S)', price:1e7, type:'pph', mult:0.5, desc:'+50% флот-доход'},
  hacker:{id:'hacker', name:'Лиса-Хакер (A)', price:5e6, type:'hack', mult:0.3, desc:'+30% шанс хаков'},
  doctor:{id:'doctor', name:'Доктор Нейро (A)', price:4e6, type:'regen', mult:0.2, desc:'+20% реген/мин'},
  bot:{id:'bot', name:'ГигаПанк-Бот (B)', price:2e6, type:'autotap', mult:1, desc:'1 авто-тап/сек'}
};

/* ---- Ranks ---- */
const RANK_NAMES = ["Street Rat","Neon Scavenger","Void Pirate","Cyber Overlord","Galaxy Baron"];
const RANK_REQ = [0,1e3,1e6,1e9,1e12];

/* ---- Utils ---- */
function fmt(n){ return n>=1000?Math.floor(n).toLocaleString('ru-RU'):n.toFixed(2) }
function save(){ s.lastSave=Date.now(); localStorage.setItem(SAVE_KEY, JSON.stringify(s)); }
function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(raw) try{ Object.assign(s, JSON.parse(raw)); }catch(e){}
  // init structures if not present
  if(!s.ships) s.ships = { r:0,c:0,h:0,f:0,d:0 };
  if(!s.impl) s.impl = {};
  if(!s.crew) s.crew = {};
  if(!s.equipped) s.equipped = { ships:[], impl:[], crew:[] };
  recalcPassive();
  // offline gain
  const now=Date.now(); const secs = Math.min((now-(s.lastSave||now))/1000, 12*3600);
  if(secs>2){ recalcPassive(); const gained = s.pph * secs; s.energy += gained; s.totalEarned += gained; try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert(`Оффлайн: +${Math.floor(gained).toLocaleString('ru-RU')} энергии`) }catch(e){} }
  updateUI();
}

/* ---- Price helpers ---- */
function priceForShip(key){
  const owned = s.ships[key]||0;
  return Math.floor(SHIPS[key].basePrice * Math.pow(1.15, owned));
}
function priceForImpl(id){
  const lvl = s.impl[id]?.level || 0;
  return Math.floor(IMPLANTS[id].basePrice * Math.pow(1.2, lvl));
}
function priceForCrew(id){ return CREW[id].price; }

/* ---- Fleet capacity upgrade pricing ----
   We'll use base 500k, + each upgrade *2, maxCapacity 9.
   Each upgrade increases fleetCapacity by +1.
*/
const FLEET_UPGRADE = { basePrice:500000, maxCapacity:9 };
function fleetUpgradePrice(){
  return Math.floor(FLEET_UPGRADE.basePrice * Math.pow(2, s.fleetCapacity - 3));
}

/* ---- Recalculate passive income (PPH) and tap multiplier ----
   PPH calculation (variant 3):
   - Sum over equipped ships: (ship.income * ship.rarityMult)
   - Multiply by crew bonuses and implant PPH multipliers
   Tap multiplier:
   - base 1 + sum of implant tap effects
*/
function recalcPassive(){
  // compute equipped ships income
  let shipsIncome = 0;
  for(const k of s.equipped.ships){
    if(!SHIPS[k]) continue;
    const sh = Object.values(SHIPS).find(x=>x.id===k);
    if(!sh) continue;
    shipsIncome += sh.income * sh.rarityMult;
  }
  // implants
  let tapImplSum = 0, pphImplSum = 0;
  for(const id in s.impl){
    const lvl = s.impl[id]?.level || 0;
    if(lvl<=0) continue;
    const it = IMPLANTS[id];
    if(!it) continue;
    const cur = it.effectBase + it.levelMult * (lvl-1);
    if(it.type === 'tap') tapImplSum += cur;
    if(it.type === 'pph') pphImplSum += cur;
  }
  // crew
  let crewMult = 1;
  if(s.crew['captain']) crewMult += CREW.captain.mult;
  // PPH is sum * (1 + pphImplSum) * crewMult
  s.pph = shipsIncome * (1 + pphImplSum) * crewMult;
  s.tapMult = 1 + tapImplSum;
}

/* ---- UI update ---- */
function updateUI(){
  document.getElementById('energy').innerText = fmt(s.energy) + ' PUNK';
  document.getElementById('punk').innerText = (s.punk||0).toFixed(4) + ' $PUNK • курс 1000:1';
  document.getElementById('inc').innerText = fmt(s.pph) + ' /сек (PPH: ' + fmt(s.pph * 3600) + ')';
  // rank
  for(let i=RANK_REQ.length-1;i>=0;i--) if(s.totalEarned>=RANK_REQ[i]){ s.rank=i; break; }
  document.getElementById('rank').innerText = RANK_NAMES[s.rank];
}

/* ---- Tapping (tap crits & visuals) ---- */
const reactor = document.getElementById('reactor');
reactor.addEventListener('click', (ev)=>{ doTap(ev) });

function doTap(ev){
  const x = ev.clientX || window.innerWidth/2;
  const y = ev.clientY || window.innerHeight/2;
  let crit = 1;
  const roll = Math.random();
  if (roll < 0.005) crit = 10;
  else if (roll < 0.035) crit = 5;
  else if (roll < 0.155) crit = 2;
  const gain = Math.floor(s.tapBase * s.tapMult * crit);
  s.energy += gain; s.totalEarned += gain;
  // visual floating
  showFloating('+'+gain, x, y);
  if(crit>1) showCrit('x'+crit, x, y);
  reactor.classList.add('glitch'); setTimeout(()=>reactor.classList.remove('glitch'),180);
  recalcPassive(); updateUI(); save();
}

function showFloating(text,x,y){
  const el = document.createElement('div'); el.className = 'floating'; el.innerText = text;
  const angle = (Math.random()*40-20);
  const offsetX = (Math.random()*60-30);
  const offsetY = Math.random()*140+80;
  el.style.left = (x + offsetX) + 'px'; el.style.top = (y + 10) + 'px';
  document.body.appendChild(el);
  el.animate([{ transform: 'translate(0,0) rotate(' + angle + 'deg)', opacity: 1 },{ transform: 'translate(0,-' + offsetY + 'px) rotate(' + angle + 'deg)', opacity: 0 }], { duration: 1100 + Math.random()*400, easing: 'ease-out' });
  setTimeout(()=>el.remove(), 1600);
}
function showCrit(text,x,y){
  const boom = document.createElement('div'); boom.className='critBoom'; boom.innerText = text;
  boom.style.left = (x-20) + 'px'; boom.style.top = (y-20) + 'px';
  document.body.appendChild(boom);
  boom.animate([{ transform:'scale(1)', opacity: 1 },{ transform:'scale(2.2)', opacity: 0 }], { duration: 420, easing: 'ease-out' });
  setTimeout(()=>boom.remove(), 500);
}

/* ---- Passive loop ---- */
setInterval(()=>{
  recalcPassive();
  s.energy += s.pph/10;
  // auto-convert energy to $PUNK at 1000:1 with 5% fee
  if(s.energy >= 1000){
    const whole = Math.floor(s.energy/1000);
    const toAdd = whole * 0.95;
    s.punk += toAdd; s.energy -= whole*1000;
  }
  updateUI();
}, 100);

/* ---- Popup helpers ---- */
function pop(html){ document.getElementById('popcard').innerHTML = html; document.getElementById('pop').style.display = 'flex'; delegatePopClicks(); }
function popClose(){ document.getElementById('pop').style.display = 'none'; }

/* ---- Delegation for pop events ---- */
function delegatePopClicks(){
  const popCard = document.getElementById('popcard');
  if(!popCard) return;
  popCard.querySelectorAll('[data-close]').forEach(btn=>btn.addEventListener('click', popClose));
  popCard.querySelectorAll('[data-buy-ship]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ buyShip(btn.getAttribute('data-buy-ship'), Number(btn.getAttribute('data-price'))); });
  });
  popCard.querySelectorAll('[data-equip-ship]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ toggleEquipShip(btn.getAttribute('data-equip-ship')); });
  });
  popCard.querySelectorAll('[data-buy-impl]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ buyImpl(btn.getAttribute('data-buy-impl'), Number(btn.getAttribute('data-price'))); });
  });
  popCard.querySelectorAll('[data-equip-impl]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ toggleEquipImpl(btn.getAttribute('data-equip-impl')); });
  });
  popCard.querySelectorAll('[data-hire]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ toggleHire(btn.getAttribute('data-hire'), Number(btn.getAttribute('data-price'))); });
  });
  popCard.querySelectorAll('[data-equip-crew]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ toggleEquipCrew(btn.getAttribute('data-equip-crew')); });
  });
  popCard.querySelectorAll('[data-fleet-upgrade]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ buyFleetUpgrade(); });
  });
}

/* ---- Shops / Actions ---- */

/* Fleet shop (shows ships + fleet capacity upgrade) */
function openFleet(){
  let html = `<h2 style="color:var(--n1);text-align:center">ФЛОТ</h2>`;
  html += `<div class="small-muted" style="text-align:center">Экипируем максимум: ${s.fleetCapacity} корабля(ей). Апгрейд стоимости: ${fmt(fleetUpgradePrice())} энергии</div>`;
  html += `<div style="margin-top:12px"><button class="btn" data-fleet-upgrade>Улучшить вместимость флота (+1) — цена: ${fmt(fleetUpgradePrice())}</button></div>`;
  html += `<hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">`;
  html += `<div class="thumb-list">`;
  for(const k in SHIPS){
    const sh = SHIPS[k];
    const owned = s.ships[k]||0;
    const price = priceForShip(k);
    const purchased = owned > 0;
    html += `<div class="thumb">
      <img src="/assets/ships/${sh.id}.png" alt="${sh.name}" onerror="this.style.opacity=.6">
      <strong>${sh.name}</strong>
      <div class="small-muted">Редкость: ${sh.rarity} • Базовый доход: ${sh.income}/сек</div>
      <div style="margin-top:6px">У тебя: ${owned}</div>
      <div style="margin-top:8px">
        <button class="btn primary" data-buy-ship="${k}" data-price="${price}">Купить (${fmt(price)})</button>
      </div>
      <div style="margin-top:6px">
        ${purchased ? `<button class="btn" data-equip-ship="${k}">${s.equipped.ships.includes(sh.id)?'Снять':'Экипировать'}</button>` : `<button class="btn" disabled>Экипировать (купите сначала)</button>`}
      </div>
    </div>`;
  }
  html += `</div><div style="margin-top:12px;text-align:center"><button class="btn" data-close>Закрыть</button></div>`;
  pop(html);
}

/* Buy ship (adds to inventory) */
function buyShip(k, price){
  if(s.energy >= price){
    s.energy -= price;
    s.ships[k] = (s.ships[k]||0) + 1;
    save(); recalcPassive(); updateUI(); popClose(); try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Корабль куплен') }catch(e){}
  } else {
    try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Недостаточно энергии') }catch(e){ alert('Недостаточно энергии'); }
  }
}

/* Equip ship: only if owned and capacity allows */
function toggleEquipShip(k){
  const sh = SHIPS[k];
  if(!sh) return;
  const id = sh.id;
  const owned = s.ships[k]||0;
  if(owned <= 0){
    try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Корабль не куплен') }catch(e){}
    return;
  }
  const idx = s.equipped.ships.indexOf(id);
  if(idx >= 0){
    // unequip
    s.equipped.ships.splice(idx,1);
    recalcPassive(); save(); popClose(); openFleet();
    return;
  }
  // equip: check capacity
  if(s.equipped.ships.length >= s.fleetCapacity){
    try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert(`Достигнут лимит слотов флота (${s.fleetCapacity}). Улучшите вместимость в магазине.`)}catch(e){}
    return;
  }
  s.equipped.ships.push(id);
  recalcPassive(); save(); popClose(); openFleet();
}

/* Fleet capacity upgrade */
function buyFleetUpgrade(){
  if(s.fleetCapacity >= FLEET_UPGRADE.maxCapacity){
    try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Максимальная вместимость достигнута') }catch(e){}
    return;
  }
  const price = fleetUpgradePrice();
  if(s.energy >= price){
    s.energy -= price;
    s.fleetCapacity = Math.min(FLEET_UPGRADE.maxCapacity, s.fleetCapacity + 1);
    save(); popClose(); openFleet(); recalcPassive(); updateUI();
    try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Вместимость флота увеличена') }catch(e){}
  } else {
    try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Недостаточно энергии') }catch(e){}
  }
}

/* ---- Implants shop ---- */
function openImplants(){
  let html = `<h2 style="color:var(--n1);text-align:center">ИМПЛАНТЫ</h2>`;
  html += `<div class="thumb-list">`;
  for(const k in IMPLANTS){
    const it = IMPLANTS[k];
    const lvl = s.impl[it.id]?.level || 0;
    const price = priceForImpl(it.id);
    const purchased = lvl > 0;
    html += `<div class="thumb">
      <img src="/assets/implants/${it.id}.png" alt="${it.name}" onerror="this.style.opacity=.6">
      <strong>${it.name}</strong>
      <div class="small-muted">${it.desc}</div>
      <div class="small-muted">Ур: ${lvl}/${it.maxLvl}</div>
      <div style="margin-top:8px">
        <button class="btn primary" data-buy-impl="${it.id}" data-price="${price}" ${lvl>=it.maxLvl?'disabled':''}>${lvl>=it.maxLvl?'MAX':'Улучшить ('+fmt(price)+')'}</button>
      </div>
      <div style="margin-top:8px">
        ${purchased ? `<button class="btn" data-equip-impl="${it.id}">${s.equipped.impl.includes(it.id)?'Снять':'Экипировать'}</button>` : `<button class="btn" disabled>Экипировать (купите сначала)</button>`}
      </div>
    </div>`;
  }
  html += `</div><div style="margin-top:12px;text-align:center"><button class="btn" data-close>Закрыть</button></div>`;
  pop(html);
}

/* Buy implant */
function buyImpl(id, price){
  const it = Object.values(IMPLANTS).find(x=>x.id===id);
  if(!it) return;
  const lvl = s.impl[id]?.level || 0;
  if(lvl >= it.maxLvl) return;
  if(s.energy >= price){
    s.energy -= price;
    if(!s.impl[id]) s.impl[id] = { level: 0 };
    s.impl[id].level++;
    save(); recalcPassive(); updateUI(); popClose(); openImplants();
    try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Имплант улучшен') }catch(e){}
  } else {
    try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Недостаточно энергии') }catch(e){}
  }
}

/* Equip implant */
function toggleEquipImpl(id){
  const lvl = s.impl[id]?.level || 0;
  if(lvl <= 0){ try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Имплант не куплен') }catch(e){} return; }
  const idx = s.equipped.impl.indexOf(id);
  if(idx >= 0){ s.equipped.impl.splice(idx,1); } else { s.equipped.impl.push(id); }
  save(); recalcPassive(); popClose(); openImplants();
}

/* ---- Crew shop ---- */
function openCrew(){
  let html = `<h2 style="color:var(--n1);text-align:center">ЭКИПАЖ</h2>`;
  html += `<div class="thumb-list">`;
  for(const k in CREW){
    const it = CREW[k];
    const hired = s.crew[it.id] ? true : false;
    html += `<div class="thumb">
      <img src="/assets/crew/${it.id}.png" alt="${it.name}" onerror="this.style.opacity=.6">
      <strong>${it.name}</strong>
      <div class="small-muted">${it.desc}</div>
      <div style="margin-top:8px">${fmt(it.price)} energy</div>
      <div style="margin-top:8px">
        <button class="btn" data-hire="${it.id}" data-price="${it.price}">${hired ? 'Уволить' : 'Нанять'}</button>
      </div>
      <div style="margin-top:8px">
        ${hired ? `<button class="btn" data-equip-crew="${it.id}">${s.equipped.crew.includes(it.id)?'Снять':'Экипировать'}</button>` : `<button class="btn" disabled>Экипировать (Нанять сначала)</button>`}
      </div>
    </div>`;
  }
  html += `</div><div style="margin-top:12px;text-align:center"><button class="btn" data-close>Закрыть</button></div>`;
  pop(html);
}

/* Hire / fire */
function toggleHire(id, price){
  if(s.crew[id]){
    delete s.crew[id];
    // also remove equip if was equipped
    const idx = s.equipped.crew.indexOf(id);
    if(idx >= 0) s.equipped.crew.splice(idx,1);
    save(); recalcPassive(); popClose(); openCrew();
    return;
  }
  if(s.energy >= price){
    s.energy -= price; s.crew[id] = true; save(); recalcPassive(); popClose(); openCrew();
    try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Член экипажа нанят') }catch(e){}
  } else try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Недостаточно энергии') }catch(e){}
}

/* Equip crew */
function toggleEquipCrew(id){
  if(!s.crew[id]){ try{ Telegram.WebApp.showAlert && Telegram.WebApp.showAlert('Член экипажа не нанят') }catch(e){} return; }
  const idx = s.equipped.crew.indexOf(id);
  if(idx >= 0){ s.equipped.crew.splice(idx,1); } else { s.equipped.crew.push(id); }
  save(); recalcPassive(); popClose(); openCrew();
}

/* ---- Market / Raid / Quests placeholders ---- */
function openMarket(){ pop(`<h2 style="color:var(--n1);text-align:center">ТЁМНЫЙ РЫНОК</h2><div class="pop-item">NFT и бустеры — появятся в следующих релизах.</div><div style="text-align:center;margin-top:12px"><button class="btn" data-close>Закрыть</button></div>`); }
function openRaid(){ pop(`<h2 style="color:var(--n1);text-align:center">КРИПТО-РЕЙД</h2><div class="pop-item">Community Raid — в разработке.</div><div style="text-align:center;margin-top:12px"><button class="btn" data-close>Закрыть</button></div>`); }
function openQuests(){ pop(`<h2 style="color:var(--n1);text-align:center">КВЕСТЫ</h2><div class="pop-item">Квесты — в разработке.</div><div style="text-align:center;margin-top:12px"><button class="btn" data-close>Закрыть</button></div>`); }

/* ---- Profile (shows only bought items + equipped) ---- */
function openProfile(){
  const avatar = '/assets/profile/avatar.png';
  const name = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user && Telegram.WebApp.initDataUnsafe.user.first_name) ? Telegram.WebApp.initDataUnsafe.user.first_name : 'Пилот';
  // fleet inventory: only bought
  const fleetOwned = Object.keys(SHIPS).filter(k=> (s.ships[k]||0) > 0).map(k=>{
    const sh = SHIPS[k];
    const owned = s.ships[k]||0;
    const equipped = s.equipped.ships.includes(sh.id);
    return `<div style="display:flex;flex-direction:column;align-items:center;width:96px;margin-right:8px">
      <img src="/assets/ships/${sh.id}.png" style="width:72px;height:72px;object-fit:contain" onerror="this.style.opacity=.5">
      <div class="small-muted" style="margin-top:6px">${sh.name}</div>
      <div style="font-weight:800">${owned}</div>
      <div style="margin-top:6px"><button class="btn" data-equip-ship="${k}">${equipped?'Снять':'Экипировать'}</button></div>
    </div>`;
  }).join('');
  const implOwned = Object.keys(IMPLANTS).filter(k=> (s.impl[IMPLANTS[k].id]?.level||0) > 0).map(k=>{
    const it = IMPLANTS[k]; const lvl = s.impl[it.id]?.level||0; const equipped = s.equipped.impl.includes(it.id);
    return `<div style="display:flex;flex-direction:column;align-items:center;width:86px;margin-right:8px">
      <img src="/assets/implants/${it.id}.png" style="width:64px;height:64px" onerror="this.style.opacity=.5">
      <div class="small-muted" style="margin-top:6px">${it.name.split(' ')[0]}</div>
      <div style="font-weight:800">${lvl}</div>
      <div style="margin-top:6px"><button class="btn" data-equip-impl="${it.id}">${equipped?'Снять':'Экипировать'}</button></div>
    </div>`;
  }).join('');
  const crewOwned = Object.keys(CREW).filter(k=> s.crew[CREW[k].id]).map(k=>{
    const it = CREW[k]; const equipped = s.equipped.crew.includes(it.id);
    return `<div style="display:flex;flex-direction:column;align-items:center;width:96px;margin-right:8px">
      <img src="/assets/crew/${it.id}.png" style="width:72px;height:72px;object-fit:contain" onerror="this.style.opacity=.5">
      <div class="small-muted" style="margin-top:6px">${it.name.split(' ')[0]}</div>
      <div style="margin-top:6px"><button class="btn" data-equip-crew="${it.id}">${equipped?'Снять':'Экипировать'}</button></div>
    </div>`;
  }).join('');

  let html = `<div class="profile-window">
    <div style="display:flex;flex-direction:column;align-items:center;gap:12px">
      <img src="${avatar}" class="profile-avatar" onerror="this.style.opacity=.5">
      <div style="text-align:center"><div style="font-size:20px;font-weight:900;color:var(--n1)">${name}</div><div class="small-muted">@CosmoPunk</div></div>
      <div style="margin-top:8px"><button class="btn" data-close>Закрыть</button></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px">
      <div class="stat-block"><div class="small-muted">Ранг</div><div style="font-weight:900">${RANK_NAMES[s.rank]}</div></div>
      <div class="stat-block"><div class="small-muted">Всего заработано</div><div style="font-weight:900">${fmt(s.totalEarned)} PUNK</div></div>
      <div class="stat-block"><div class="small-muted">PPH (пассив)</div><div style="font-weight:900">${fmt(s.pph)} /сек</div></div>
      <div class="stat-block"><div class="small-muted">Вместимость флота</div><div style="font-weight:900">${s.fleetCapacity} слотов (макс ${FLEET_UPGRADE.maxCapacity})</div></div>
      <div class="stat-block"><div class="small-muted">Инвентарь — Флот</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          ${fleetOwned || '<div class="small-muted">Пока ничего не куплено</div>'}
        </div>
      </div>
      <div class="stat-block"><div class="small-muted">Инвентарь — Импланты</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          ${implOwned || '<div class="small-muted">Пока ничего не куплено</div>'}
        </div>
      </div>
      <div class="stat-block"><div class="small-muted">Инвентарь — Экипаж</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          ${crewOwned || '<div class="small-muted">Пока ничего не нанято</div>'}
        </div>
      </div>
    </div>
  </div>`;
  pop(html);
}

/* ---- Wiring bottom buttons AFTER DOM ready ---- */
document.addEventListener('DOMContentLoaded', ()=>{
  // load saved
  load();

  const actionsMap = {
    'fleet': openFleet,
    'crew': openCrew,
    'impl': openImplants,
    'raid': openRaid,
    'quests': openQuests,
    'market': openMarket,
    'profile': openProfile
  };
  const controlsRow = document.getElementById('controlsRow');
  controlsRow.querySelectorAll('button[data-action]').forEach(btn=>{
    const action = btn.getAttribute('data-action');
    if(actionsMap[action]) btn.addEventListener('click', ()=>actionsMap[action]());
  });

  // theme switching
  document.querySelectorAll('.theme-button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.theme-button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.getAttribute('data-theme') || 'neon';
      document.body.className = 'theme-' + t;
    });
  });

  // initial UI
  recalcPassive(); updateUI();
  try{ Telegram.WebApp.ready(); Telegram.WebApp.expand(); }catch(e){}
});

/* ---- Ensure save on unload ---- */
window.addEventListener('beforeunload', save);
setInterval(save, 5000);
</script>
</body>
</html>