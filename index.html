<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>CosmoPunk Tap Game — Theme Preview</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<style>
/* ====== Base / Reset ====== */
:root{
  --bg:#0a001a; --n1:#ff00ff; --n2:#00ffff; --text:#fff; --panel:rgba(255,255,255,0.04);
  --glass: rgba(255,255,255,0.04);
  --glow: 0 0 30px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body,#app{height:100%}
body{
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: radial-gradient(circle at 30% 20%, #1a0033 0%, var(--bg) 45%, #000 100%);
  color:var(--text);
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* ====== Themes (set class on body) ====== */
/* theme: neon (default) */
body.theme-neon { --bg:#0a001a; --n1:#ff00ff; --n2:#00ffff; --panel:linear-gradient(180deg, rgba(255,0,255,0.06), rgba(0,255,255,0.03)); --glow:0 0 40px }
body.theme-holo { --bg:#001022; --n1:#7fe3ff; --n2:#a7ffa8; --panel:linear-gradient(180deg, rgba(127,227,255,0.04), rgba(167,255,168,0.02)); --glow:0 0 24px; background:radial-gradient(circle at 50% 30%, #003344 0%, #001022 45%, #000 100%) }
body.theme-cartoon { --bg:#0a1022; --n1:#ffd166; --n2:#7ee7a6; --panel:linear-gradient(180deg, rgba(255,209,102,0.06), rgba(126,231,166,0.03)); --glow:0 0 18px; background: linear-gradient(180deg,#071029,#0a1022) }
body.theme-dark { --bg:#03040a; --n1:#ff3333; --n2:#33ff99; --panel:linear-gradient(180deg, rgba(255,51,51,0.03), rgba(51,255,153,0.02)); --glow:0 0 28px; background:radial-gradient(circle at 70% 20%, #06060a 0%, #03040a 60%, #000 100%) }
body.theme-3d { --bg:#08111a; --n1:#ff66cc; --n2:#66ddff; --panel:linear-gradient(180deg, rgba(255,102,204,0.04), rgba(102,221,255,0.02)); --glow:0 0 36px; background: linear-gradient(180deg,#041021,#08111a) }

/* ====== Layout ====== */
#app{position:relative;width:100vw;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hud{position:absolute;top:12px;left:12px;right:12px;display:flex;align-items:center;justify-content:space-between;z-index:80}
.hud-left{display:flex;flex-direction:column;gap:6px}
.badge{padding:6px 10px;border-radius:12px;background:var(--panel);border:1px solid rgba(255,255,255,0.03);font-weight:700;backdrop-filter: blur(6px)}
.title{font-size:14px;color:var(--n2);letter-spacing:0.6px}
.balance{font-size:18px;font-weight:800;text-shadow:var(--glow) var(--n1)}
.sub{font-size:12px;color:rgba(255,255,255,0.7)}

/* Theme selector */
.theme-switch{display:flex;gap:8px;align-items:center}
.theme-button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;cursor:pointer;color:var(--text);font-weight:700;min-width:36px;text-align:center}
.theme-button.active{box-shadow:var(--glow) var(--n1);transform:scale(1.04)}

/* Reactor */
.stage{position:relative;display:flex;align-items:center;justify-content:center;width:100%;height:100%;}
.reactor-wrap{width:min(76vmin,520px);height:min(76vmin,520px);position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50}
.reactor{
  width:100%;height:100%;border-radius:28px;background:
  radial-gradient(ellipse at 50% 20%, rgba(255,255,255,0.03) 0%, transparent 35%),
  linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15));
  display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;
  border:2px solid rgba(255,255,255,0.04);box-shadow: var(--glow) var(--n1);
  transition:transform .12s ease, box-shadow .12s ease;
}
.reactor img{width:78%;height:78%;object-fit:contain;filter:drop-shadow(var(--glow) var(--n1))}
.reactor:active{transform:scale(.98)}
.reactor.glitch{animation:glitch .18s steps(2);transform:translate3d(0,0,0)}
@keyframes glitch{20%{transform:translate(-6px,6px)}40%{transform:translate(6px,-6px)}60%{transform:translate(-6px,-6px)}80%{transform:translate(3px,3px)}}

/* pop numbers */
.floating{
  position:absolute;pointer-events:none;font-size:28px;color:var(--n2);text-shadow:var(--glow) var(--n1);
  animation:floatUp 1.2s forwards;
}
@keyframes floatUp{to{transform:translateY(-380px) rotate(720deg);opacity:0}}

/* Footer controls */
.controls{position:absolute;bottom:14px;left:14px;right:14px;display:flex;gap:10px;justify-content:space-between;z-index:70}
.controls .left, .controls .right{display:flex;gap:8px;align-items:center}
.btn{background:var(--panel);border:1px solid rgba(255,255,255,0.04);padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;backdrop-filter:blur(6px)}
.btn.primary{background:linear-gradient(90deg,var(--n1),var(--n2));color:#000;box-shadow:var(--glow) var(--n2);border:none}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
.center-info{display:flex;flex-direction:column;align-items:center;gap:6px;z-index:60}

/* popup */
#pop{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(0,0,0,0.6),rgba(0,0,0,0.8));z-index:999}
.pop-card{width:min(760px,96%);max-height:86%;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2));padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.04)}
.pop-item{padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02)}

/* small responsive */
@media (max-width:600px){
  .reactor-wrap{width:92vw;height:92vw;border-radius:18px}
  .title{font-size:12px}
  .balance{font-size:16px}
  .btn{padding:8px 10px;font-size:13px}
}

/* little polish */
.small-muted{font-size:12px;color:rgba(255,255,255,0.6)}
</style>
</head>
<body class="theme-neon">
<div id="app">
  <div class="hud">
    <div class="hud-left">
      <div class="badge title">CosmoPunk Tap Game</div>
      <div class="badge balance" id="energy">0 PUNK</div>
      <div class="small-muted" id="punk">$0.0000 $PUNK • курс 1000:1</div>
    </div>
    <div class="theme-switch">
      <div class="small-muted" style="margin-right:6px">Theme</div>
      <button class="theme-button active" data-theme="neon" title="Cyberpunk Neon">N</button>
      <button class="theme-button" data-theme="holo" title="Hologram">H</button>
      <button class="theme-button" data-theme="cartoon" title="Cartoon">C</button>
      <button class="theme-button" data-theme="dark" title="Dark">D</button>
      <button class="theme-button" data-theme="3d" title="3D">3D</button>
    </div>
  </div>

  <div class="stage">
    <div class="reactor-wrap">
      <div id="reactor" class="reactor" onclick="tap(event)"><img alt="reactor" src="https://i.ibb.co/0jKX7Wv/reactor.gif"/></div>
      <div class="center-info" style="margin-top:12px">
        <div id="inc" class="small-muted">0 /сек</div>
        <div id="rank" class="badge" style="margin-top:6px">Street Rat</div>
      </div>
    </div>
  </div>

  <div class="controls">
    <div class="left">
      <button class="btn ghost" onclick="openShop('fleet')">ФЛОТ</button>
      <button class="btn ghost" onclick="openShop('crew')">ЭКИПАЖ</button>
      <button class="btn ghost" onclick="openShop('impl')">ИМПЛАНТЫ</button>
    </div>
    <div class="right">
      <button class="btn primary" onclick="openShop('raid')">RAID</button>
      <button class="btn ghost" onclick="openShop('market')">ТЁМНЫЙ РЫНОК</button>
    </div>
  </div>
</div>

<!-- popup -->
<div id="pop" onclick="if(event.target.id==='pop')popClose()">
  <div class="pop-card" id="popcard"></div>
</div>

<script>
/* ========== Game core (kept lightweight, based on v5) ========== */
const SAVE_KEY = 'cp_tap_v5_theme';
let s = {
  energy:0, punk:0, totalEarned:0, tapBase:1, tapMult:1.0, passive:0,
  ships:{r:0,c:0,h:0,f:0,d:0}, crew:{}, impl:{}, rank:0, lastSave:Date.now()
};
const SHIPS = {
  r:{name:'Void Reaper (S)', basePrice:20000000, income:1000},
  c:{name:'Neon Corsair (A)', basePrice:10000000, income:500},
  h:{name:'Punk Hauler (B)', basePrice:5000000, income:200},
  f:{name:'Scrap Fighter (C)', basePrice:2000000, income:100},
  d:{name:'Rusty Drone (D)', basePrice:1000000, income:50}
};
const RANK_NAMES = ["Street Rat","Neon Scavenger","Void Pirate","Cyber Overlord","Galaxy Baron"];
const RANK_REQ = [0,1e3,1e6,1e9,1e12];

/* Telegram WebApp */
const tg = Telegram.WebApp;
tg.ready(); try{ tg.expand(); }catch(e){}

/* Theme switching */
document.querySelectorAll('.theme-button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.theme-button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.getAttribute('data-theme');
    document.body.className = 'theme-' + t;
  });
});

/* Utils */
function fmt(n){ return n>=1000?Math.floor(n).toLocaleString():n.toFixed(2) }
function priceFor(key){
  const owned = s.ships[key]||0;
  const base = SHIPS[key].basePrice;
  return Math.floor(base * Math.pow(1.15, owned));
}

/* Load/save */
function saveState(){ s.lastSave = Date.now(); localStorage.setItem(SAVE_KEY, JSON.stringify(s)); }
function loadState(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(raw) try{ Object.assign(s, JSON.parse(raw)); }catch(e){}
  const now = Date.now();
  const secs = Math.min((now - (s.lastSave||now))/1000, 12*3600);
  if(secs>2){
    recalcPassive();
    const gained = s.passive * secs;
    s.energy += gained; s.totalEarned += gained;
    try{ tg.showAlert(`Оффлайн: +${Math.floor(gained)} энергии`); }catch(e){}
  }
  recalcPassive(); ui();
}

/* recalc passive with simple impl/crew */
function recalcPassive(){
  let sum=0;
  for(let k in s.ships) sum += (s.ships[k]||0) * SHIPS[k].income;
  let mult = 1;
  if(s.impl['neuro']) mult += 2.0;
  if(s.crew['captain']) mult += 0.5;
  s.passive = sum * mult;
}

/* UI update */
function ui(){
  document.getElementById('energy').innerText = fmt(s.energy) + ' PUNK';
  document.getElementById('punk').innerText = (s.punk).toFixed(4) + ' $PUNK • курс 1000:1';
  document.getElementById('inc').innerText = s.passive.toFixed(1) + ' /сек';
  for(let i=RANK_REQ.length-1;i>=0;i--) if(s.totalEarned>=RANK_REQ[i]){ s.rank=i; break; }
  document.getElementById('rank').innerText = RANK_NAMES[s.rank];
}

/* Tap handler */
function tap(ev){
  const x = (ev.touches && ev.touches[0])?ev.touches[0].clientX:(ev.clientX||window.innerWidth/2);
  const y = (ev.touches && ev.touches[0])?ev.touches[0].clientY:(ev.clientY||window.innerHeight/2);
  const gain = s.tapBase * s.tapMult;
  s.energy += gain; s.totalEarned += gain;
  // pop
  const el = document.createElement('div'); el.className='floating'; el.innerText = '+'+fmt(gain);
  el.style.left = (x - 20) + 'px'; el.style.top = (y - 20) + 'px';
  document.body.appendChild(el); setTimeout(()=>el.remove(),1200);
  // glitch animation
  const r = document.getElementById('reactor'); r.classList.add('glitch'); setTimeout(()=>r.classList.remove('glitch'),180);
  try{ tg.HapticFeedback?.impactOccurred('light'); }catch(e){}
  ui(); saveState();
}

/* Passive loop (smooth) */
setInterval(()=>{
  recalcPassive();
  s.energy += s.passive/10;
  if(s.energy >= 1000){
    const whole = Math.floor(s.energy/1000);
    const toAdd = whole * 0.95;
    s.punk += toAdd; s.energy -= whole*1000;
  }
  ui();
},100);

/* Autosave */
setInterval(()=>saveState(),4000);
window.addEventListener('beforeunload', saveState);

/* Popup helpers */
function pop(html){ document.getElementById('popcard').innerHTML = html; document.getElementById('pop').style.display = 'flex'; }
function popClose(){ document.getElementById('pop').style.display = 'none'; }

/* Shops */
function openShop(type){
  if(type==='fleet') return openFleet();
  if(type==='crew') return openCrew();
  if(type==='impl') return openImplants();
  if(type==='raid') return openRaid();
  if(type==='market') return openMarket();
}

/* Fleet */
function openFleet(){
  let html = `<h2 style="color:var(--n1);text-align:center">ФЛОТ</h2>`;
  for(const k in SHIPS){
    const sh = SHIPS[k];
    const owned = s.ships[k]||0;
    const price = priceFor(k);
    html += `<div class="pop-item"><strong>${sh.name}</strong><div class="small-muted">Доход: ${sh.income}/сек</div>Цена: ${price.toLocaleString()} энергии • У тебя: ${owned}<div style="margin-top:8px"><button class="btn primary" onclick="buyShip('${k}',${price})">Купить</button></div></div>`;
  }
  html += `<div style="margin-top:12px"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`;
  pop(html);
}
function buyShip(k, price){
  if(s.energy >= price){
    s.energy -= price; s.ships[k] = (s.ships[k]||0)+1; recalcPassive(); ui(); saveState(); popClose(); try{ tg.showAlert('Корабль приобретён'); }catch(e){} 
  } else { try{ tg.showAlert('Недостаточно энергии'); }catch(e){ alert('Недостаточно энергии'); } }
}

/* Crew */
function openCrew(){
  let items = [
    {id:'captain', name:'Капитан Космо (S)', price:10000000, desc:'+50% к флот-доходу'},
    {id:'hacker', name:'Лиса-Хакер (A)', price:5000000, desc:'+30% шанс хак'},
    {id:'bot', name:'ГигаПанк-Бот (B)', price:2000000, desc:'+1 авто-тап/сек'}
  ];
  let html = `<h2 style="color:var(--n1);text-align:center">ЭКИПАЖ</h2>`;
  for(const it of items){
    const owned = s.crew[it.id] ? ' (нанят)' : '';
    html += `<div class="pop-item"><strong>${it.name}</strong><div class="small-muted">${it.desc}</div>Цена: ${it.price.toLocaleString()} энергии${owned}<div style="margin-top:8px"><button class="btn" onclick="toggleCrew('${it.id}',${it.price})">${s.crew[it.id]?'Уволить':'Нанять'}</button></div></div>`;
  }
  html += `<div style="margin-top:12px"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`;
  pop(html);
}
function toggleCrew(id, price){
  if(s.crew[id]){ delete s.crew[id]; recalcPassive(); ui(); saveState(); openCrew(); return; }
  if(s.energy >= price){ s.energy -= price; s.crew[id]=true; if(id==='bot'){ setInterval(()=>{ s.energy+=1; s.totalEarned+=1; }, 1000); } recalcPassive(); ui(); saveState(); openCrew(); }
  else try{ tg.showAlert('Недостаточно энергии'); }catch(e){}
}

/* Implants */
function openImplants(){
  let items = [
    {id:'neuro', name:'Нео-Нейрон (S)', price:1000000, desc:'+200% тап-мульт'},
    {id:'glitch', name:'Глитч-Протез (A)', price:500000, desc:'+100% пассив'}
  ];
  let html = `<h2 style="color:var(--n1);text-align:center">ИМПЛАНТЫ</h2>`;
  for(const it of items){
    const own = s.impl[it.id]?' (установлен)':'';
    html += `<div class="pop-item"><strong>${it.name}</strong><div class="small-muted">${it.desc}</div>Цена: ${it.price.toLocaleString()} энергии${own}<div style="margin-top:8px"><button class="btn" onclick="buyImpl('${it.id}',${it.price})">${s.impl[it.id]?'Удалить':'Купить'}</button></div></div>`;
  }
  html += `<div style="margin-top:12px"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`;
  pop(html);
}
function buyImpl(id, price){
  if(s.impl[id]){ delete s.impl[id]; if(id==='neuro') s.tapMult = Math.max(1, s.tapMult - 2.0); recalcPassive(); ui(); saveState(); openImplants(); return; }
  if(s.energy >= price){ s.energy -= price; s.impl[id]=true; if(id==='neuro') s.tapMult += 2.0; recalcPassive(); ui(); saveState(); openImplants(); }
  else try{ tg.showAlert('Недостаточно энергии'); }catch(e){}
}

/* Raid & Market stubs */
function openRaid(){ pop(`<h2 style="color:var(--n1);text-align:center">RAID</h2><div class="pop-item">Crypto-Raid — PvE-режим, мини-игры и боссы. В следующем обновлении.</div><div style="margin-top:12px"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`); }
function openMarket(){ pop(`<h2 style="color:var(--n1);text-align:center">ТЁМНЫЙ РЫНОК</h2><div class="pop-item">NFT, редкие предметы и временные бустеры — появятся позже.</div><div style="margin-top:12px"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`); }

/* init */
loadState();
ui();

</script>
</body>
</html>