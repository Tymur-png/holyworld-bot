<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CosmoPunk: Syndicate Wars</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #05000a;
            --accent: #d300d3;
            --cyan: #00f7ff;
            --yellow: #f7ff00;
            --red: #ff2a2a;
            --glass: rgba(16, 20, 30, 0.95);
            --border: rgba(0, 247, 255, 0.3);
            --font: 'Courier New', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            color: #fff;
            font-family: var(--font);
            height: 100vh;
            overflow: hidden;
            user-select: none;
            position: relative;
        }

        #matrix-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; opacity: 0.15; pointer-events: none;
        }

        #app { 
            display: flex; flex-direction: column; height: 100vh; padding: 12px; 
            position: relative; z-index: 10; pointer-events: none; 
        }
        
        .interactive { pointer-events: auto; }

        /* HUD */
        .hud { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .res-box {
            background: var(--glass); border: 1px solid var(--border);
            padding: 8px 12px; border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,247,255,0.1);
            min-width: 100px;
        }
        #energy-val { font-size: 20px; font-weight: 900; color: var(--cyan); text-shadow: 0 0 10px var(--cyan); }
        .sub-text { font-size: 10px; color: #aaa; margin-top: 2px; }
        .rank-box { text-align: right; border-color: var(--accent); }
        #rank-val { color: var(--accent); font-weight: bold; font-size: 12px; text-transform: uppercase; }

        /* LANG BUTTON */
        .lang-btn {
            position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
            background: #111; border: 1px solid #444; color: #fff;
            padding: 4px 10px; border-radius: 12px; font-size: 10px;
            z-index: 100; cursor: pointer; pointer-events: auto;
            opacity: 0.8;
        }

        /* COMBO BAR */
        .combo-container {
            width: 100%; height: 6px; background: #222; margin-bottom: 15px;
            border-radius: 3px; overflow: hidden; position: relative;
            box-shadow: 0 0 5px rgba(0,0,0,0.5); pointer-events: auto;
        }
        .combo-fill {
            height: 100%; background: linear-gradient(90deg, var(--yellow), var(--red));
            width: 0%; transition: width 0.1s linear;
        }
        .combo-text {
            position: absolute; width: 100%; text-align: center; top: -15px;
            font-size: 10px; font-weight: bold; color: var(--yellow); opacity: 0;
            transition: opacity 0.2s;
        }

        /* REACTOR */
        #stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; pointer-events: none; }
        
        .reactor-wrap { 
            position: relative; width: 280px; height: 280px; 
            display: flex; justify-content: center; align-items: center; 
            transition: transform 0.1s; z-index: 20; cursor: pointer;
        }
        .reactor-wrap:active { transform: scale(0.95); }
        .shake { animation: shake 0.15s cubic-bezier(.36,.07,.19,.97) both; }
        #reactor-img { 
            width: 100%; height: 100%; object-fit: contain; z-index: 5;
            filter: drop-shadow(0 0 30px rgba(211,0,211,0.5)); pointer-events: none;
        }

        /* RAID BTN */
        #raid-btn {
            position: absolute; top: 10%; right: 10px;
            width: 60px; height: 60px; background: var(--red);
            border-radius: 50%; border: 3px solid #fff;
            display: none; align-items: center; justify-content: center;
            font-size: 24px; animation: pulse-btn 0.5s infinite;
            z-index: 50; cursor: pointer; box-shadow: 0 0 20px var(--red);
        }

        /* HACK BTN */
        #hack-btn {
            margin-top: 25px;
            background: linear-gradient(90deg, #ff004c, #ff9100);
            border: none; padding: 12px 24px; border-radius: 25px;
            color: #fff; font-weight: bold; font-size: 14px; letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(255, 0, 76, 0.4);
            opacity: 0.5; filter: grayscale(1); pointer-events: none; transition: 0.3s;
            position: relative; z-index: 25;
        }
        #hack-btn.ready { opacity: 1; filter: grayscale(0); pointer-events: auto; animation: pulse-btn 1.5s infinite; }

        /* NAV */
        .nav { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding-bottom: 10px; position: relative; z-index: 30; pointer-events: auto; }
        .nav-btn {
            background: rgba(0,0,0,0.8); border: 1px solid var(--border); border-radius: 12px;
            height: 55px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; color: #888; transition: 0.2s; backdrop-filter: blur(4px);
        }
        .nav-btn span { font-size: 20px; margin-bottom: 4px; }
        .nav-btn:active { background: var(--cyan); color: #000; border-color: #fff; transform: translateY(2px); }

        /* MODALS */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; align-items: flex-end; justify-content: center;
            pointer-events: auto; animation: fadeIn 0.2s;
        }
        .modal-card {
            background: #0b0514; border-top: 2px solid var(--accent);
            width: 100%; max-height: 85vh; border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 -10px 50px rgba(211, 0, 211, 0.2);
            animation: slideUp 0.3s;
        }
        .modal-header { 
            padding: 15px; text-align: center; font-weight: bold; font-size: 16px; 
            border-bottom: 1px solid #222; letter-spacing: 2px; color: var(--accent);
        }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }

        .item { 
            display: flex; gap: 12px; align-items: center; 
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            padding: 10px; border-radius: 12px; margin-bottom: 10px;
        }
        .item img { 
            width: 50px; height: 50px; object-fit: contain; 
            background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid #333;
        }
        .item-info { flex: 1; }
        .item-name { font-size: 14px; font-weight: bold; color: #fff; margin-bottom: 4px;}
        .item-desc { font-size: 11px; color: #888; }
        .btn-buy {
            background: var(--cyan); color: #000; border: none; padding: 8px 14px;
            border-radius: 8px; font-size: 12px; font-weight: bold; min-width: 80px;
        }
        .btn-owned { background: #333; color: #555; pointer-events: none; }

        /* MINI GAME */
        #hack-game-ui { width: 100%; padding: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .hack-track {
            width: 100%; height: 24px; background: #111; border-radius: 12px;
            position: relative; overflow: hidden; margin: 25px 0; border: 2px solid #444;
        }
        .hack-target {
            position: absolute; top: 0; bottom: 0; width: 40px; 
            background: var(--yellow); opacity: 0.8; left: 50%; transform: translateX(-50%);
            box-shadow: 0 0 15px var(--yellow);
        }
        .hack-cursor {
            position: absolute; top: -2px; bottom: -2px; width: 4px;
            background: var(--red); left: 0%; 
            box-shadow: 0 0 10px var(--red); z-index: 2;
        }
        .hack-btn-action {
            width: 100%; padding: 18px; background: var(--red); color: #fff;
            border: none; font-size: 18px; font-weight: 900; border-radius: 12px;
        }

        .float-txt { 
            position: absolute; font-weight: 900; font-size: 26px; 
            pointer-events: none; z-index: 90; text-shadow: 0 2px 0 #000;
        }
        
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-3px, 0, 0); } 40%, 60% { transform: translate3d(3px, 0, 0); } }
        @keyframes pulse-btn { 0% {box-shadow: 0 0 0 0 rgba(255, 0, 76, 0.7); transform:scale(1);} 50% {transform:scale(1.05);} 100% {box-shadow: 0 0 0 15px rgba(255, 0, 76, 0); transform:scale(1);} }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div id="app">
    <button class="lang-btn" id="lang-toggle" onclick="toggleLang()">RU</button>

    <div class="hud interactive">
        <div class="res-box">
            <div id="energy-val">0</div>
            <div class="sub-text" id="inc-val">+0 / sec</div>
        </div>
        <div class="res-box rank-box">
            <div id="rank-val" data-key="rank_0">NOBODY</div>
            <div class="sub-text" data-key="ui_rank">SYSTEM RANK</div>
        </div>
    </div>

    <div class="combo-container">
        <div class="combo-text" id="combo-txt">COMBO x1.0</div>
        <div class="combo-fill" id="combo-bar"></div>
    </div>

    <div id="stage">
        <div id="raid-btn" class="interactive" onclick="hitRaidBoss()">ðŸ‘¾</div>
        <div class="reactor-wrap interactive" id="tap-zone">
            <img src="assets/reactor/reactor.gif" id="reactor-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/9309/9309584.png'">
        </div>
        <button id="hack-btn" class="interactive" onclick="startHackGame()" data-key="btn_hack">â˜  HACK SYSTEM</button>
    </div>

    <div class="nav interactive">
        <div class="nav-btn" onclick="openMenu('ships')"><span>ðŸš€</span><div data-key="menu_fleet">Fleet</div></div>
        <div class="nav-btn" onclick="openMenu('crew')"><span>ðŸ‘¥</span><div data-key="menu_crew">Crew</div></div>
        <div class="nav-btn" onclick="openMenu('implants')"><span>ðŸ§ </span><div data-key="menu_imp">Chips</div></div>
        <div class="nav-btn" onclick="openMenu('rebirth')"><span>ðŸ§¬</span><div data-key="menu_reset">Reset</div></div>
    </div>
</div>

<div class="modal-overlay" id="main-modal" onclick="if(event.target.id==='main-modal') closeModal()">
    <div class="modal-card interactive">
        <div class="modal-header" id="modal-title">TITLE</div>
        <div class="modal-body" id="modal-content"></div>
        <button style="padding:15px; background:#111; color:#fff; border:none; border-top:1px solid #333; font-weight:bold;" onclick="closeModal()" data-key="btn_close">CLOSE</button>
    </div>
</div>

<div class="modal-overlay" id="hack-modal">
    <div class="modal-card interactive" style="height: auto; border-color: var(--red);">
        <div class="modal-header" style="color:var(--red)" data-key="hack_title">FIREWALL BREACH</div>
        <div class="modal-body">
            <div id="hack-game-ui">
                <p style="color:#ccc; font-size:12px; margin-bottom:10px;" data-key="hack_desc">Stop cursor in yellow zone!</p>
                <div class="hack-track">
                    <div class="hack-target" id="hack-target-zone"></div>
                    <div class="hack-cursor" id="hack-cursor"></div>
                </div>
                <button class="hack-btn-action" onmousedown="stopHack()" ontouchstart="stopHack()" data-key="btn_breach">BREACH</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- TRANSLATIONS (RU, EN, PL) ---
    const LANGS = ['ru', 'en', 'pl'];
    let curLang = localStorage.getItem('cp_lang') || 'ru';

    const TEXT = {
        ru: {
            ui_rank: "Ð ÐÐÐ“ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ«",
            menu_fleet: "Ð¤Ð»Ð¾Ñ‚",
            menu_crew: "Ð‘Ð°Ð½Ð´Ð°",
            menu_imp: "Ð§Ð¸Ð¿Ñ‹",
            menu_reset: "Ð¡Ð±Ñ€Ð¾Ñ",
            btn_hack: "â˜  Ð’Ð—Ð›ÐžÐœ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ«",
            btn_hack_wait: "â³ Ð–Ð”Ð˜: ",
            btn_hack_ready: "â˜  Ð’Ð—Ð›ÐžÐœ Ð“ÐžÐ¢ÐžÐ’",
            btn_close: "Ð—ÐÐšÐ Ð«Ð¢Ð¬",
            btn_breach: "Ð’Ð—Ð›ÐžÐœÐÐ¢Ð¬",
            hack_title: "ÐŸÐ ÐžÐ Ð«Ð’ FIREWALL",
            hack_desc: "ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ ÐºÑƒÑ€ÑÐ¾Ñ€ Ð² Ð¶ÐµÐ»Ñ‚Ð¾Ð¹ Ð·Ð¾Ð½Ðµ!",
            title_ships: "ÐÐÐ“ÐÐ  Ð¤Ð›ÐžÐ¢Ð",
            title_crew: "ÐÐÐ™Ðœ Ð‘ÐÐÐ”Ð«",
            title_imp: "ÐšÐ˜Ð‘Ð•Ð -Ð˜ÐœÐŸÐ›ÐÐÐ¢Ð«",
            title_reset: "ÐŸÐ•Ð Ð•Ð ÐžÐ–Ð”Ð•ÐÐ˜Ð•",
            alert_offline: "ÐžÑ„Ð»Ð°Ð¹Ð½ Ð´Ð¾Ñ…Ð¾Ð´:",
            alert_hack_win: "Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ Ð’Ð—Ð›ÐžÐœÐÐÐ!\nÐ¡ÐšÐÐ§ÐÐÐž:",
            alert_raid_win: "Ð£Ð“Ð ÐžÐ—Ð Ð£Ð¡Ð¢Ð ÐÐÐ•ÐÐ!\nÐÐ°Ð³Ñ€Ð°Ð´Ð°:",
            alert_reset: "Ð¢Ð¾Ñ‡Ð½Ð¾ ÑÐ±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ?",
            txt_installed: "Ð£Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐž",
            txt_lvl: "Ð£Ñ€.",
            txt_reset_info: "Ð¡Ð±Ñ€Ð¾Ñ Ð´Ð°ÑÑ‚ ÐÐ°Ð½Ð¾-Ð‘Ð¾Ñ‚Ð¾Ð².\n1 Ð‘Ð¾Ñ‚ = +10% Ðº Ð´Ð¾Ñ…Ð¾Ð´Ñƒ Ð½Ð°Ð²ÑÐµÐ³Ð´Ð°.\nÐ¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð±Ð¾Ð½ÑƒÑ:",
            txt_reset_btn: "Ð¡Ð‘Ð ÐžÐ¡Ð˜Ð¢Ð¬ Ð—Ð",
            txt_reset_no: "ÐÐ£Ð–ÐÐž 1Ðœ PUNK",
            // Ranks
            rank_0: "ÐžÑ‚Ð±Ñ€Ð¾Ñ", rank_1: "Ð¡Ð±Ð¾Ñ€Ñ‰Ð¸Ðº", rank_2: "Ð¥Ð°ÐºÐµÑ€", rank_3: "ÐšÐ¸Ð±ÐµÑ€-ÐŸÐ°Ð½Ðº",
            rank_4: "Ð‘Ð¾ÑÑ Ð£Ð»Ð¸Ñ†", rank_5: "Ð“Ð»Ð°Ð²Ð°", rank_6: "ÐšÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚", rank_7: "Ð’Ð»Ð°ÑÑ‚ÐµÐ»Ð¸Ð½"
        },
        en: {
            ui_rank: "SYSTEM RANK",
            menu_fleet: "Fleet",
            menu_crew: "Crew",
            menu_imp: "Implants",
            menu_reset: "Reset",
            btn_hack: "â˜  HACK SYSTEM",
            btn_hack_wait: "â³ WAIT: ",
            btn_hack_ready: "â˜  HACK READY",
            btn_close: "CLOSE",
            btn_breach: "BREACH",
            hack_title: "FIREWALL BREACH",
            hack_desc: "Stop cursor in yellow zone!",
            title_ships: "FLEET HANGAR",
            title_crew: "HIRE CREW",
            title_imp: "CYBER IMPLANTS",
            title_reset: "REBIRTH",
            alert_offline: "Offline income:",
            alert_hack_win: "SYSTEM BREACHED!\nDOWNLOADED:",
            alert_raid_win: "THREAT ELIMINATED!\nReward:",
            alert_reset: "Reset all progress?",
            txt_installed: "INSTALLED",
            txt_lvl: "Lvl",
            txt_reset_info: "Reset grants Nano-Bots.\n1 Bot = +10% income forever.\nCurrent bonus:",
            txt_reset_btn: "RESET FOR",
            txt_reset_no: "NEED 1M PUNK",
            // Ranks
            rank_0: "Nobody", rank_1: "Scavenger", rank_2: "Hacker", rank_3: "Cyber-Punk",
            rank_4: "Street Boss", rank_5: "Syndicate Head", rank_6: "Corpo", rank_7: "Net Lord"
        },
        pl: {
            ui_rank: "RANGA SYSTEMU",
            menu_fleet: "Flota",
            menu_crew: "ZaÅ‚oga",
            menu_imp: "Implanty",
            menu_reset: "Reset",
            btn_hack: "â˜  WÅAMANIE",
            btn_hack_wait: "â³ CZEKAJ: ",
            btn_hack_ready: "â˜  GOTOWE",
            btn_close: "ZAMKNIJ",
            btn_breach: "PRZEÅAM",
            hack_title: "PRZEÅAMANIE ZAPORY",
            hack_desc: "Zatrzymaj kursor w Å¼Ã³Å‚tej strefie!",
            title_ships: "HANGAR FLOTY",
            title_crew: "REKRUTACJA",
            title_imp: "CYBER IMPLANTY",
            title_reset: "ODRODZENIE",
            alert_offline: "DochÃ³d offline:",
            alert_hack_win: "SYSTEM ZÅAMANY!\nPOBRANO:",
            alert_raid_win: "ZAGROÅ»ENIE USUNIÄ˜TE!\nNagroda:",
            alert_reset: "ZresetowaÄ‡ postÄ™p?",
            txt_installed: "ZAINSTALOWANO",
            txt_lvl: "Poz.",
            txt_reset_info: "Reset daje Nano-Boty.\n1 Bot = +10% do dochodu.\nObecny bonus:",
            txt_reset_btn: "RESETUJ ZA",
            txt_reset_no: "WYMAGA 1M PUNK",
            // Ranks
            rank_0: "Wyrzutek", rank_1: "Zbieracz", rank_2: "Haker", rank_3: "Cyber-Punk",
            rank_4: "Szef Ulicy", rank_5: "Szef Syndykatu", rank_6: "Korporat", rank_7: "WÅ‚adca Sieci"
        }
    };

    // ITEM NAMES DICTIONARY
    const DB_TEXT = {
        ru: {
            s1: "Ð”Ñ€Ð¾Ð½", s2: "Ð¨ÐµÑ€ÑˆÐµÐ½ÑŒ", s3: "Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚", s4: "Ð¤Ñ€ÐµÐ³Ð°Ñ‚ ÐÐµÐ¾Ð½", s5: "ÐŸÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ñ‡Ð¸Ðº",
            s6: "Ð­ÑÐ¼Ð¸Ð½ÐµÑ†", s7: "ÐšÑ€ÐµÐ¹ÑÐµÑ€", s8: "Ð›Ð¸Ð½ÐºÐ¾Ñ€", s9: "ÐÐ²Ð¸Ð°Ð½Ð¾ÑÐµÑ†", s10: "Ð—Ð²ÐµÐ·Ð´Ð° Ð¡Ð¼ÐµÑ€Ñ‚Ð¸",
            c1: "Ð¥Ð°ÐºÐµÑ€ Ð›Ð¸ÑÐ°", c1d: "ÐšÑ€Ð¸Ñ‚ ÑˆÐ°Ð½Ñ +5%",
            c2: "Ð‘Ð¾Ñ‚-ÑˆÐ°Ñ…Ñ‚ÐµÑ€", c2d: "ÐÐ²Ñ‚Ð¾-Ð´Ð¾Ñ…Ð¾Ð´ +30/ÑÐµÐº",
            c3: "ÐšÐ°Ð¿Ð¸Ñ‚Ð°Ð½", c3d: "Ð‘Ð°Ð·Ð° ÐºÐ»Ð¸ÐºÐ° x2",
            i1: "ÐÐµÐ¹Ñ€Ð¾-Ñ‡Ð¸Ð¿", i1d: "+2 Ðº ÐºÐ»Ð¸ÐºÑƒ",
            i2: "ÐšÐ¸Ð±ÐµÑ€-Ð“Ð»Ð°Ð·", i2d: "ÐšÑ€Ð¸Ñ‚ x2 Ð¼Ð¾Ñ‰Ð½ÐµÐµ",
            i3: "Ð¢Ð¸Ñ‚Ð°Ð½-Ð ÑƒÐºÐ°", i3d: "+50 Ðº ÐºÐ»Ð¸ÐºÑƒ",
            i4: "Ð“Ð»Ð¸Ñ‚Ñ‡-ÐœÐ¾Ð´ÑƒÐ»ÑŒ", i4d: "Ð”Ð¾Ñ…Ð¾Ð´ x1.2",
            i5: "ÐšÐ²Ð°Ð½Ñ‚-Ð¯Ð´Ñ€Ð¾", i5d: "Ð”Ð¾Ñ…Ð¾Ð´ x2"
        },
        en: {
            s1: "Drone", s2: "Hornet", s3: "Transport", s4: "Frigate Neon", s5: "Interceptor",
            s6: "Destroyer", s7: "Cruiser", s8: "Battleship", s9: "Carrier", s10: "Death Star",
            c1: "Hacker Fox", c1d: "Crit Chance +5%",
            c2: "Miner Bot", c2d: "Auto +30/sec",
            c3: "Captain", c3d: "Base Click x2",
            i1: "Neuro-Chip", i1d: "+2 Click Dmg",
            i2: "Cyber-Eye", i2d: "Crit Power x2",
            i3: "Titan Arm", i3d: "+50 Click Dmg",
            i4: "Glitch Mod", i4d: "Income x1.2",
            i5: "Quant Core", i5d: "Income x2"
        },
        pl: {
            s1: "Dron", s2: "SzerszeÅ„", s3: "Transport", s4: "Fregata Neon", s5: "Przechwytywacz",
            s6: "Niszczyciel", s7: "KrÄ…Å¼ownik", s8: "Pancernik", s9: "Lotniskowiec", s10: "Gwiazda Åšmierci",
            c1: "Hakerka Fox", c1d: "Szansa Kryt +5%",
            c2: "Bot GÃ³rnik", c2d: "Auto +30/sek",
            c3: "Kapitan", c3d: "Bazowy Klik x2",
            i1: "Neuro-Chip", i1d: "+2 do klika",
            i2: "Cyber-Oko", i2d: "Moc Kryt x2",
            i3: "Tytan-RÄ™ka", i3d: "+50 do klika",
            i4: "Glitch Mod", i4d: "DochÃ³d x1.2",
            i5: "Kwantowy RdzeÅ„", i5d: "DochÃ³d x2"
        }
    };

    function t(key) { return TEXT[curLang][key] || key; }
    function td(key) { return DB_TEXT[curLang][key] || key; }

    function updateLanguageUI() {
        document.getElementById('lang-toggle').innerText = curLang.toUpperCase();
        document.querySelectorAll('[data-key]').forEach(el => {
            el.innerText = t(el.getAttribute('data-key'));
        });
        updateHUD(); // Re-render rank
    }

    function toggleLang() {
        let idx = LANGS.indexOf(curLang);
        curLang = LANGS[(idx + 1) % LANGS.length];
        localStorage.setItem('cp_lang', curLang);
        updateLanguageUI();
    }

    // --- AUDIO ENGINE ---
    const AudioFX = {
        ctx: null,
        init: function() {
            if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        },
        play: function(type) {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            const now = this.ctx.currentTime;
            
            if(type === 'tap') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'buy') {
                osc.type = 'square'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'raid') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }
    };

    // --- GAME DATA ---
    const tg = window.Telegram.WebApp;
    tg.expand();
    const SAVE_KEY = 'cp_wars_multi';

    // DB only holds logic stats now, text is in DB_TEXT
    const DB = {
        ships: [
            { id: 's1', inc: 1, cost: 150, img: 'assets/ships/ship1.png' },
            { id: 's2', inc: 5, cost: 750, img: 'assets/ships/ship2.png' },
            { id: 's3', inc: 15, cost: 2500, img: 'assets/ships/ship3.png' },
            { id: 's4', inc: 45, cost: 9000, img: 'assets/ships/ship4.png' },
            { id: 's5', inc: 120, cost: 30000, img: 'assets/ships/ship5.png' },
            { id: 's6', inc: 400, cost: 100000, img: 'assets/ships/ship6.png' },
            { id: 's7', inc: 1500, cost: 450000, img: 'assets/ships/ship7.png' },
            { id: 's8', inc: 5000, cost: 1500000, img: 'assets/ships/ship8.png' },
            { id: 's9', inc: 20000, cost: 7000000, img: 'assets/ships/ship9.png' },
            { id: 's10', inc: 100000, cost: 50000000, img: 'assets/ships/ship10.png' }
        ],
        crew: [
            { id: 'c1', cost: 1000, img: 'assets/crew/hacker.png' },
            { id: 'c2', cost: 2000, img: 'assets/crew/bot.png' },
            { id: 'c3', cost: 10000, img: 'assets/crew/captain.png' }
        ],
        implants: [
            { id: 'i1', cost: 500, clickAdd: 2, img: 'assets/implants/base.png' },
            { id: 'i2', cost: 3500, critPower: 1, img: 'assets/implants/eye.png' },
            { id: 'i3', cost: 15000, clickAdd: 50, img: 'assets/implants/neuro.png' },
            { id: 'i4', cost: 50000, globalMult: 0.2, img: 'assets/implants/glitch.png' },
            { id: 'i5', cost: 1000000, globalMult: 1.0, img: 'assets/implants/chip.png' }
        ]
    };

    let state = {
        energy: 0,
        total: 0,
        prestigeTokens: 0,
        ships: {},
        crew: {},
        implants: [],
        lastHack: 0,
        lastSave: Date.now()
    };

    let comboCount = 0;
    let comboTimer = null;
    let raidActive = false;
    let raidClicks = 0;

    // --- INIT ---
    let saved = localStorage.getItem(SAVE_KEY);
    if(saved) {
        let parsed = JSON.parse(saved);
        state = { ...state, ...parsed };
        if(!state.implants) state.implants = [];
        if(!state.prestigeTokens) state.prestigeTokens = 0;
    }

    updateLanguageUI();

    // Offline Earnings
    let offlineSeconds = (Date.now() - state.lastSave) / 1000;
    if(offlineSeconds > 60) {
        let earn = calcIncome() * offlineSeconds;
        if(earn > 0) {
            state.energy += earn;
            state.total += earn;
            setTimeout(() => alert(`${t('alert_offline')} ${Math.floor(earn).toLocaleString()} PUNK`), 500);
        }
    }

    setInterval(() => {
        let inc = calcIncome() / 10;
        if(inc > 0) addEnergy(inc);
        updateHUD();
        checkHackStatus();
    }, 100);
    
    setInterval(() => { if(Math.random() > 0.8 && !raidActive) startRaidEvent(); }, 10000);
    setInterval(saveGame, 5000);
    initMatrix();

    // --- LOGIC ---
    function calcIncome() {
        let income = 0;
        DB.ships.forEach(s => { if(state.ships[s.id]) income += state.ships[s.id] * s.inc; });
        if(state.crew['c2']) income += state.crew['c2'] * 30;
        
        let mult = 1;
        state.implants.forEach(impId => {
            let item = DB.implants.find(i => i.id === impId);
            if(item && item.globalMult) mult += item.globalMult;
        });
        mult += (state.prestigeTokens * 0.1);
        return income * mult;
    }

    function addEnergy(amount) {
        state.energy += amount;
        state.total += amount;
    }

    function tap(e) {
        AudioFX.init();
        if(e) e.preventDefault();
        let touches = e ? (e.changedTouches || [e]) : [{clientX: window.innerWidth/2, clientY: window.innerHeight/2}];

        comboCount++;
        clearTimeout(comboTimer);
        comboTimer = setTimeout(() => { comboCount = 0; updateComboUI(); }, 1500);
        updateComboUI();

        let flatBonus = 0;
        let critMult = 10;

        state.implants.forEach(impId => {
            let item = DB.implants.find(i => i.id === impId);
            if(item && item.clickAdd) flatBonus += item.clickAdd;
            if(item && item.critPower) critMult += (10 * item.critPower);
        });

        let captainBonus = (state.crew['c3'] || 0) * 2; 
        let comboMult = 1 + Math.min(comboCount / 20, 4);
        let prestigeMult = 1 + (state.prestigeTokens * 0.1);
        let power = (1 + captainBonus + flatBonus) * comboMult * prestigeMult;

        for(let t of touches) {
            let critChance = 0.05 + (state.crew['c1'] || 0) * 0.05;
            let isCrit = Math.random() < critChance;
            if(isCrit) { power *= critMult; tg.HapticFeedback.notificationOccurred('warning'); } 
            else { tg.HapticFeedback.impactOccurred('light'); }

            addEnergy(power);
            spawnFloat(t.clientX, t.clientY, Math.floor(power), isCrit);
            AudioFX.play('tap');
        }

        const r = document.getElementById('reactor-img');
        r.classList.remove('shake');
        void r.offsetWidth; r.classList.add('shake');
    }

    function updateComboUI() {
        let bar = document.getElementById('combo-bar');
        let txt = document.getElementById('combo-txt');
        let perc = Math.min(comboCount * 2, 100);
        bar.style.width = perc + '%';
        let mult = 1 + Math.min(comboCount / 20, 4);
        txt.innerText = `COMBO x${mult.toFixed(1)}`;
        txt.style.opacity = comboCount > 1 ? 1 : 0;
    }

    function startRaidEvent() {
        raidActive = true; raidClicks = 0;
        let btn = document.getElementById('raid-btn');
        btn.style.display = 'flex';
        AudioFX.play('raid'); tg.HapticFeedback.notificationOccurred('error');
        setTimeout(() => { if(raidActive) { raidActive = false; btn.style.display = 'none'; } }, 5000);
    }

    function hitRaidBoss() {
        if(!raidActive) return;
        raidClicks++; tg.HapticFeedback.impactOccurred('heavy');
        let btn = document.getElementById('raid-btn');
        btn.style.transform = 'scale(0.9)'; setTimeout(() => btn.style.transform = 'scale(1)', 50);

        if(raidClicks >= 10) {
            raidActive = false; btn.style.display = 'none';
            let reward = calcIncome() * 120; if(reward < 500) reward = 500;
            addEnergy(reward);
            alert(`${t('alert_raid_win')} ${Math.floor(reward)} PUNK`);
            tg.HapticFeedback.notificationOccurred('success');
        }
    }

    // --- HACKING ---
    let hackAnim, hackDir = 1, hackPos = 0;
    
    function checkHackStatus() {
        let now = Date.now();
        let btn = document.getElementById('hack-btn');
        let diff = now - state.lastHack;
        if(diff > 300000) {
            btn.classList.add('ready');
            btn.innerText = t('btn_hack_ready');
        } else {
            btn.classList.remove('ready');
            let left = Math.ceil((300000 - diff)/1000);
            let min = Math.floor(left/60);
            let sec = left%60;
            btn.innerText = `${t('btn_hack_wait')} ${min}:${sec < 10 ? '0'+sec : sec}`;
        }
    }

    function startHackGame() {
        if(Date.now() - state.lastHack < 300000) return;
        document.getElementById('hack-modal').style.display = 'flex';
        hackPos = 0; hackDir = 1.2;
        let targetLeft = 20 + Math.random() * 50;
        document.getElementById('hack-target-zone').style.left = targetLeft + '%';
        window.hackTargetMin = targetLeft;
        window.hackTargetMax = targetLeft + 15;
        function animate() {
            hackPos += hackDir;
            if(hackPos > 100 || hackPos < 0) hackDir *= -1;
            document.getElementById('hack-cursor').style.left = hackPos + '%';
            hackAnim = requestAnimationFrame(animate);
        }
        animate();
    }

    function stopHack() {
        cancelAnimationFrame(hackAnim);
        if(hackPos >= window.hackTargetMin && hackPos <= window.hackTargetMax) {
            let reward = calcIncome() * 300; if(reward < 1000) reward = 1000;
            addEnergy(reward);
            alert(`${t('alert_hack_win')} ${Math.floor(reward)} PUNK`);
            tg.HapticFeedback.notificationOccurred('success');
            AudioFX.play('buy');
            state.lastHack = Date.now();
        } else {
            tg.HapticFeedback.notificationOccurred('error');
            AudioFX.play('error');
            state.lastHack = Date.now() - 240000; 
        }
        document.getElementById('hack-modal').style.display = 'none';
        checkHackStatus();
    }

    // --- MENUS ---
    function openMenu(type) {
        document.getElementById('main-modal').style.display = 'flex';
        const title = document.getElementById('modal-title');
        const content = document.getElementById('modal-content');
        content.innerHTML = '';

        if(type === 'ships') {
            title.innerText = t('title_ships');
            DB.ships.forEach(s => {
                let cnt = state.ships[s.id] || 0;
                let price = Math.floor(s.cost * Math.pow(1.15, cnt));
                renderItem(content, td(s.id), `+${s.inc}/s | ${t('txt_installed')}: ${cnt}`, price, s.img, false, () => {
                    if(state.energy >= price) {
                        state.energy -= price;
                        state.ships[s.id] = cnt + 1;
                        AudioFX.play('buy');
                        openMenu('ships');
                    }
                });
            });
        }
        else if(type === 'crew') {
            title.innerText = t('title_crew');
            DB.crew.forEach(c => {
                let lvl = state.crew[c.id] || 0;
                let price = Math.floor(c.cost * Math.pow(1.4, lvl));
                renderItem(content, `${td(c.id)} (${t('txt_lvl')} ${lvl})`, td(c.id+'d'), price, c.img, false, () => {
                    if(state.energy >= price) {
                        state.energy -= price;
                        state.crew[c.id] = lvl + 1;
                        AudioFX.play('buy');
                        openMenu('crew');
                    }
                });
            });
        }
        else if(type === 'implants') {
            title.innerText = t('title_imp');
            DB.implants.forEach(item => {
                let isOwned = state.implants.includes(item.id);
                renderItem(content, td(item.id), isOwned ? t('txt_installed') : td(item.id+'d'), item.cost, item.img, isOwned, () => {
                    if(isOwned) return;
                    if(state.energy >= item.cost) {
                        state.energy -= item.cost;
                        state.implants.push(item.id);
                        AudioFX.play('buy');
                        openMenu('implants');
                    }
                });
            });
        }
        else if(type === 'rebirth') {
            title.innerText = t('title_reset');
            renderRebirth(content);
        }
    }

    function renderItem(container, name, desc, price, img, isOwned, onClick) {
        let div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
            <img src="${img}" onerror="this.src='https://via.placeholder.com/50?text=ERR'">
            <div class="item-info">
                <div class="item-name">${name}</div>
                <div class="item-desc">${desc}</div>
            </div>
            <button class="btn-buy ${isOwned ? 'btn-owned' : ''}">${isOwned ? 'V' : formatNum(price)}</button>
        `;
        if(!isOwned) div.querySelector('button').onclick = onClick;
        container.appendChild(div);
    }

    function renderRebirth(container) {
        let p = document.createElement('p');
        p.style.fontSize = '12px'; p.style.marginBottom = '15px'; p.style.textAlign = 'center';
        p.innerText = `${t('txt_reset_info')} +${Math.floor(state.prestigeTokens * 10)}%`;
        container.appendChild(p);

        let potential = Math.floor(state.total / 1000000);
        let btn = document.createElement('button');
        btn.className = 'hack-btn-action';
        btn.innerText = `${t('txt_reset_btn')} ${potential} BOTS`;
        if(potential < 1) {
            btn.style.opacity = 0.5;
            btn.innerText = t('txt_reset_no');
        } else {
            btn.onclick = () => {
                if(confirm(t('alert_reset'))) {
                    state.prestigeTokens += potential;
                    state.energy = 0; state.total = 0; state.ships = {}; state.crew = {}; state.implants = [];
                    saveGame();
                    location.reload();
                }
            };
        }
        container.appendChild(btn);
    }

    function closeModal() { document.getElementById('main-modal').style.display = 'none'; }
    function formatNum(n) { return n > 1000000 ? (n/1000000).toFixed(1)+'M' : (n > 1000 ? (n/1000).toFixed(1)+'K' : n); }

    function updateHUD() {
        document.getElementById('energy-val').innerText = formatNum(Math.floor(state.energy));
        document.getElementById('inc-val').innerText = `+${formatNum(Math.floor(calcIncome()))} / s`;
        let ranks = [t('rank_0'), t('rank_1'), t('rank_2'), t('rank_3'), t('rank_4'), t('rank_5'), t('rank_6'), t('rank_7')];
        let rIdx = Math.min(Math.floor(Math.log10(state.total + 1)), ranks.length-1);
        if(state.total < 1000) rIdx = 0;
        document.getElementById('rank-val').innerText = ranks[rIdx];
    }

    function spawnFloat(x, y, val, isCrit) {
        let el = document.createElement('div');
        el.className = 'float-txt';
        el.style.left = (x - 20) + 'px'; el.style.top = (y - 40) + 'px';
        el.innerText = `+${val}`;
        el.style.color = isCrit ? 'var(--red)' : 'var(--cyan)';
        if(isCrit) el.style.fontSize = '32px';
        document.body.appendChild(el);
        setTimeout(() => {
            el.style.transition = 'all 0.6s';
            el.style.transform = 'translateY(-100px) scale(1.2)';
            el.style.opacity = 0;
        }, 50);
        setTimeout(() => el.remove(), 600);
    }

    function saveGame() {
        state.lastSave = Date.now();
        localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    }

    function initMatrix() {
        const c = document.getElementById('matrix-canvas');
        const ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const chars = "01XYZ"; 
        const fontSize = 14;
        const columns = c.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);
        function draw() {
            ctx.fillStyle = "rgba(5, 0, 10, 0.1)";
            ctx.fillRect(0, 0, c.width, c.height);
            ctx.fillStyle = "#0f0"; ctx.font = fontSize + "px monospace";
            for(let i=0; i<drops.length; i++) {
                const text = chars[Math.floor(Math.random()*chars.length)];
                ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                if(drops[i]*fontSize > c.height && Math.random() > 0.98) drops[i] = 0;
                drops[i]++;
            }
        }
        setInterval(draw, 50);
    }

    const zone = document.getElementById('tap-zone');
    zone.addEventListener('touchstart', tap, {passive:false});
    zone.addEventListener('mousedown', tap);

</script>
</body>
</html>