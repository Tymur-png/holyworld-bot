<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>CosmoPunk Tap Game — Theme Preview</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<style>
/* ====== Base / Reset ====== */
:root{
  --bg:#0a001a; --n1:#ff00ff; --n2:#00ffff; --text:#fff; --panel:rgba(255,255,255,0.04);
  --glass: rgba(255,255,255,0.04);
  --glow: 0 0 30px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body,#app{height:100%}
body{
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: radial-gradient(circle at 30% 20%, #1a0033 0%, var(--bg) 45%, #000 100%);
  color:var(--text);
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* ====== Themes (set class on body) ====== */
/* theme: neon (default) */
body.theme-neon { --bg:#0a001a; --n1:#ff00ff; --n2:#00ffff; --panel:linear-gradient(180deg, rgba(255,0,255,0.06), rgba(0,255,255,0.03)); --glow:0 0 40px }
body.theme-holo { --bg:#001022; --n1:#7fe3ff; --n2:#a7ffa8; --panel:linear-gradient(180deg, rgba(127,227,255,0.04), rgba(167,255,168,0.02)); --glow:0 0 24px; background:radial-gradient(circle at 50% 30%, #003344 0%, #001022 45%, #000 100%) }
body.theme-cartoon { --bg:#0a1022; --n1:#ffd166; --n2:#7ee7a6; --panel:linear-gradient(180deg, rgba(255,209,102,0.06), rgba(126,231,166,0.03)); --glow:0 0 18px; background: linear-gradient(180deg,#071029,#0a1022) }
body.theme-dark { --bg:#03040a; --n1:#ff3333; --n2:#33ff99; --panel:linear-gradient(180deg, rgba(255,51,51,0.03), rgba(51,255,153,0.02)); --glow:0 0 28px; background:radial-gradient(circle at 70% 20%, #06060a 0%, #03040a 60%, #000 100%) }
body.theme-3d { --bg:#08111a; --n1:#ff66cc; --n2:#66ddff; --panel:linear-gradient(180deg, rgba(255,102,204,0.04), rgba(102,221,255,0.02)); --glow:0 0 36px; background: linear-gradient(180deg,#041021,#08111a) }

/* ====== Layout ====== */
#app{position:relative;width:100vw;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hud{position:absolute;top:12px;left:12px;right:12px;display:flex;align-items:center;justify-content:space-between;z-index:80}
.hud-left{display:flex;flex-direction:column;gap:6px}
.badge{padding:6px 10px;border-radius:12px;background:var(--panel);border:1px solid rgba(255,255,255,0.03);font-weight:700;backdrop-filter: blur(6px)}
.title{font-size:14px;color:var(--n2);letter-spacing:0.6px}
.balance{font-size:18px;font-weight:800;text-shadow:var(--glow) var(--n1)}
.sub{font-size:12px;color:rgba(255,255,255,0.7)}

/* Theme selector */
.theme-switch{display:flex;gap:8px;align-items:center}
.theme-button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;cursor:pointer;color:var(--text);font-weight:700;min-width:36px;text-align:center}
.theme-button.active{box-shadow:var(--glow) var(--n1);transform:scale(1.04)}

/* Reactor */
.stage{position:relative;display:flex;align-items:center;justify-content:center;width:100%;height:100%;}
.reactor-wrap{width:min(76vmin,520px);height:min(76vmin,520px);position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50}
.reactor{
  width:100%;height:100%;border-radius:28px;background:
  radial-gradient(ellipse at 50% 20%, rgba(255,255,255,0.03) 0%, transparent 35%),
  linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15));
  display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;
  border:2px solid rgba(255,255,255,0.04);box-shadow: var(--glow) var(--n1);
  transition:transform .12s ease, box-shadow .12s ease;
}
.reactor img{width:78%;height:78%;object-fit:contain;filter:drop-shadow(var(--glow) var(--n1))}
.reactor:active{transform:scale(.98)}
.reactor.glitch{animation:glitch .18s steps(2);transform:translate3d(0,0,0)}
@keyframes glitch{20%{transform:translate(-6px,6px)}40%{transform:translate(6px,-6px)}60%{transform:translate(-6px,-6px)}80%{transform:translate(3px,3px)}}

/* pop numbers */
.floating{
  position:absolute;pointer-events:none;font-size:28px;color:var(--n2);text-shadow:var(--glow) var(--n1);
}
/* CSS для CRIT-эффекта */
.critBoom {
    position: fixed;
    color: #ff0077;
    font-size: 34px;
    font-weight: 900;
    text-shadow: 0 0 8px #ff00ff;
    pointer-events: none;
    z-index: 2000;
}

/* Footer controls - New Scrollable Bar */
.bottom-bar{
    position:absolute;
    bottom:0;
    left:0;
    right:0;
    padding: 12px 0;
    background: linear-gradient(180deg, rgba(0,0,0,0.01), var(--bg) 90%);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    z-index: 70;
}
.scroll-container{
    display: flex;
    gap: 10px;
    overflow-x: auto;
    white-space: nowrap;
    padding: 0 14px; /* padding for the sides */
    /* Скрываем скроллбар */
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}
.scroll-container::-webkit-scrollbar {
    display: none; /* Chrome, Safari and Opera */
}

.btn{background:var(--panel);border:1px solid rgba(255,255,255,0.04);padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;backdrop-filter:blur(6px); flex-shrink: 0;}
.btn.primary{background:linear-gradient(90deg,var(--n1),var(--n2));color:#000;box-shadow:var(--glow) var(--n2);border:none}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
.center-info{display:flex;flex-direction:column;align-items:center;gap:6px;z-index:60}

/* popup */
#pop{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(0,0,0,0.6),rgba(0,0,0,0.8));z-index:999}
.pop-card{width:min(760px,96%);max-height:86%;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2));padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.04)}
.pop-item{padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02)}

/* small responsive */
@media (max-width:600px){
  .reactor-wrap{width:92vw;height:92vw;border-radius:18px}
  .title{font-size:12px}
  .balance{font-size:16px}
  .btn{padding:8px 10px;font-size:13px}
}

/* little polish */
.small-muted{font-size:12px;color:rgba(255,255,255,0.6)}

/* Quest System CSS */
.questWindow {
    position: fixed;
    bottom: 64px;
    right: 14px;
    width: min(260px, 90%);
    background: linear-gradient(180deg, rgba(0,255,255,0.1), rgba(15, 15, 25, 0.8));
    border: 2px solid var(--n2);
    border-radius: 12px;
    color: var(--n2);
    padding: 10px;
    backdrop-filter: blur(5px);
    z-index: 90;
    font-size: 14px;
}
.questWindow h3 {
    font-size: 16px;
    margin-top: 10px;
    margin-bottom: 5px;
    color: var(--n1);
}
.questItem {
    padding: 6px;
    margin-bottom: 6px;
    background: rgba(0, 200, 255, 0.08);
    border-radius: 6px;
    font-size: 13px;
    border: 1px solid rgba(0, 200, 255, 0.15);
}
.questComplete {
    background: rgba(0, 255, 120, 0.3);
    border: 1px solid #00ff88;
    color: #00ff9d;
    font-weight: bold;
}
.questItem button {
    margin-top: 5px;
    font-size: 12px;
    padding: 4px 8px;
}
.questPopup {
    position: fixed;
    bottom: 120px;
    right: 20px;
    background: #00ffee;
    color: #001111;
    padding: 12px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 14px;
    box-shadow: 0 0 10px #00fff2;
    z-index: 3000;
    pointer-events: none;
}
</style>
</head>
<body class="theme-neon">
<div id="app">
  <div class="hud">
    <div class="hud-left">
      <div class="badge title">CosmoPunk Tap Game</div>
      <div class="badge balance" id="energy">0 PUNK</div>
      <div class="small-muted" id="punk">$0.0000 $PUNK • курс 1000:1</div>
    </div>
    <div class="theme-switch">
      <div class="small-muted" style="margin-right:6px">Theme</div>
      <button class="theme-button active" data-theme="neon" title="Cyberpunk Neon">N</button>
      <button class="theme-button" data-theme="holo" title="Hologram">H</button>
      <button class="theme-button" data-theme="cartoon" title="Cartoon">C</button>
      <button class="theme-button" data-theme="dark" title="Dark">D</button>
      <button class="theme-button" data-theme="3d" title="3D">3D</button>
    </div>
  </div>

  <div class="stage">
    <div class="reactor-wrap">
      <div id="reactor" class="reactor" onclick="tap(event)"><img alt="reactor" src="https://i.ibb.co/0jKX7Wv/reactor.gif"/></div>
      <div class="center-info" style="margin-top:12px">
        <div id="inc" class="small-muted">0 /сек (PPH: 0)</div>
        <div id="rank" class="badge" style="margin-top:6px">Street Rat</div>
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <div class="scroll-container">
      <button class="btn ghost" onclick="openShop('fleet')">ФЛОТ</button>
      <button class="btn ghost" onclick="openShop('crew')">ЭКИПАЖ</button>
      <button class="btn ghost" onclick="openShop('impl')">ИМПЛАНТЫ</button>
      <button class="btn primary" onclick="openShop('raid')">RAID</button>
      <button class="btn ghost" onclick="openQuests()">КВЕСТЫ</button>
      <button class="btn ghost" onclick="openShop('market')">ТЁМНЫЙ РЫНОК</button>
      <button class="btn ghost" onclick="openProfile()">ПРОФИЛЬ</button>
    </div>
  </div>
  </div>

<div id="pop" onclick="if(event.target.id==='pop')popClose()">
  <div class="pop-card" id="popcard"></div>
</div>

<script>
/* ========== Game core (GDD v1) ========== */
const SAVE_KEY = 'cp_tap_v5_gdd';
let s = {
  energy:0, punk:0, totalEarned:0, 
  tapBase:3, tapMult:1.0, tapImplMult:0, // tapImplMult - суммарный процент от имплантов
  pph:0, pphMult:1.0, pphImplMult:0, // pphImplMult - суммарный процент пассивного дохода от имплантов
  ships:{r:0,c:0,h:0,f:0,d:0}, crew:{}, impl:{}, 
  rank:0, 
  lastSave:Date.now(),
  // Quest state
  lastDailyReset: new Date().toDateString(),
  dailyProgress:{}, progressDone:{}, specialDone:{},
  botInterval: null // Добавлено для корректного хранения интервала
};

// GDD БАЛАНС - КОРАБЛИ
const SHIPS = {
  r:{name:'Void Reaper (S)', basePrice:20000000, income:1000}, // Доход/сек на 1 уровне
  c:{name:'Neon Corsair (A)', basePrice:10000000, income:500},
  h:{name:'Punk Hauler (B)', basePrice:5000000, income:200},
  f:{name:'Scrap Fighter (C)', basePrice:2000000, income:100},
  d:{name:'Rusty Drone (D)', basePrice:1000000, income:50}
};

// GDD БАЛАНС - ИМПЛАНТЫ (Теперь с Max Level)
const IMPLANTS = {
  neuro:{id:'neuro', name:'Нео-Нейрон (S)', basePrice:1e6, effect:2.0, levelMult:0.04, maxLvl:50, type:'tap', desc:'+200% тапы, +4% за уровень'},
  glitch:{id:'glitch', name:'Глитч-Протез (A)', basePrice:5e5, effect:1.0, levelMult:0.025, maxLvl:40, type:'pph', desc:'+100% PPH, +2.5% за уровень'},
  eye:{id:'eye', name:'Кибер-Глаз (B)', basePrice:2e5, effect:0.5, levelMult:0.016, maxLvl:30, type:'hack', desc:'+50% шанс хак, +1.6% за уровень'},
  chip:{id:'chip', name:'Ржавый Чип (C)', basePrice:1e5, effect:0.2, levelMult:0.008, maxLvl:25, type:'pph', desc:'+20% PPH, +0.8% за уровень'},
  base:{id:'base', name:'Базовый Имплант (D)', basePrice:5e4, effect:0.1, levelMult:0.005, maxLvl:20, type:'tap', desc:'+10% тапы, +0.5% за уровень'}
};

// GDD БАЛАНС - ЭКИПАЖ
const CREW = {
  captain:{id:'captain', name:'Капитан Космо (S)', price:1e7, mult:0.5, type:'pph', desc:'+50% флот-доход'},
  hacker:{id:'hacker', name:'Лиса-Хакер (A)', price:5e6, mult:0.3, type:'hack', desc:'+30% шанс хаков'},
  doctor:{id:'doctor', name:'Доктор Нейро (A)', price:4e6, mult:0.2, type:'regen', desc:'+20% реген/мин'},
  bot:{id:'bot', name:'ГигаПанк-Бот (B)', price:2e6, mult:1, type:'autotap', desc:'1 авто-тап/сек'}
};

const RANK_NAMES = ["Street Rat","Neon Scavenger","Void Pirate","Cyber Overlord","Galaxy Baron"];
const RANK_REQ = [0,1e3,1e6,1e9,1e12];

const QUESTS = {
  daily: [
    { id: 'daily_clicks', text: "Сделай 5000 кликов", target: 5000, reward: { energy: 20000 }, type: 'tapCount' },
    { id: 'daily_crit3', text: "Соверши 3 крита x10", target: 3, reward: { energy: 30000 }, type: 'crit10' },
    { id: 'daily_buy_impl', text: "Купи 1 имплант", target: 1, reward: { energy: 15000 }, type: 'buyImpl' }
  ],
  progress: [
    { id: 'prog_mult20', text: "Добейся множителя x20", target: 20, reward: { permMult: 1.1 }, type: 'multAchieved' },
    { id: 'prog_buy_shipC', text: "Купи корабль класса C", target: 1, reward: { energy: 50000 }, type: 'buyShipC' },
    { id: 'prog_energy1M', text: "Накопи 1 000 000 энергии", target: 1000000, reward: { permMult: 1.2 }, type: 'energyTotal' }
  ],
  special: [
    { id: 'spec_crit10', text: "Поймай 10 неоновых критов", target: 10, reward: { energy: 50000 }, type: 'critTotal' },
    { id: 'spec_daily5', text: "Выполни 5 ежедневных подряд (TODO)", target: 5, reward: { energy: 75000 }, type: 'dailyStreak' }
  ]
};


/* Telegram WebApp */
const tg = Telegram.WebApp;
tg.ready(); try{ tg.expand(); }catch(e){}

/* Theme switching */
document.querySelectorAll('.theme-button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.theme-button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.getAttribute('data-theme');
    document.body.className = 'theme-' + t;
  });
});

/* Utils */
function fmt(n){ return n>=1000?Math.floor(n).toLocaleString('ru-RU'):n.toFixed(2) }

// Цена для кораблей (растет экспоненциально)
function priceForShip(key){
  const owned = s.ships[key]||0;
  const base = SHIPS[key].basePrice;
  return Math.floor(base * Math.pow(1.15, owned));
}

// Цена для имплантов (растет экспоненциально)
function priceForImpl(id){
  const owned = s.impl[id]?.level || 0;
  const base = IMPLANTS[id].basePrice;
  return Math.floor(base * Math.pow(1.2, owned));
}

/* Load/save */
function saveState(){ s.lastSave = Date.now(); localStorage.setItem(SAVE_KEY, JSON.stringify(s)); }
function loadState(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(raw) try{ Object.assign(s, JSON.parse(raw)); }catch(e){}
  
  // Daily quest reset logic
  const now = Date.now();
  const today = new Date().toDateString();
  if(s.lastDailyReset !== today){
    s.dailyProgress = {};
    s.lastDailyReset = today;
  }

  // Оффлайн доход
  const secs = Math.min((now - (s.lastSave||now))/1000, 12*3600);
  if(secs>2){
    recalcPassive();
    const gained = s.pph * secs; 
    s.energy += gained; s.totalEarned += gained;
    try{ tg.showAlert(`Оффлайн: +${Math.floor(gained).toLocaleString('ru-RU')} энергии`); }catch(e){}
  }
  recalcPassive(); ui();
}

/* recalc passive with GDD logic */
function recalcPassive(){
  let shipIncomeSum = 0; 
  
  s.tapImplMult = 0;
  s.pphImplMult = 0;

  // 1. Расчет дохода от кораблей (PPH Base)
  for(let k in s.ships){
    const level = s.ships[k] || 0;
    shipIncomeSum += SHIPS[k].income * Math.pow(level, 1.2); 
  }
  
  // 2. Расчет множителей от Имплантов (tapMult / pphMult)
  for(let id in s.impl){
    const impl = IMPLANTS[id];
    const level = s.impl[id]?.level || 1;
    const currentMult = impl.effect + impl.levelMult * (level - 1);

    if (impl.type === 'tap') s.tapImplMult += currentMult;
    if (impl.type === 'pph') s.pphImplMult += currentMult;
  }

  // 3. Расчет множителей от Экипажа
  let crewMult = 1.0;
  if(s.crew['captain']) crewMult += CREW.captain.mult; 

  if(s.crew['bot'] && !s.botInterval){
     s.botInterval = setInterval(()=>{ 
        s.energy+=s.tapBase * s.tapMult; s.totalEarned+=s.tapBase * s.tapMult; 
        updateQuestProgress('daily', s.tapBase * s.tapMult, {type:'tapCount'}); 
        ui();
      }, 1000); 
  } else if (!s.crew['bot'] && s.botInterval) {
     clearInterval(s.botInterval);
     s.botInterval = null;
  }

  // 4. Итоговая PPH (PUNK per Hour)
  s.pph = shipIncomeSum * (1 + s.pphImplMult) * crewMult; // Доход в секунду
  
  // 5. Итоговый Tap Multiplier
  s.tapMult = 1.0 + s.tapImplMult;

  const currentTotalMult = s.tapMult + s.pph / (s.tapBase * s.tapMult || 1); 
  updateQuestProgress('progress', 1, {type:'multAchieved', value: currentTotalMult});
}

/* UI update */
function ui(){
  document.getElementById('energy').innerText = fmt(s.energy) + ' PUNK';
  document.getElementById('punk').innerText = (s.punk).toFixed(4) + ' $PUNK • курс 1000:1';
  document.getElementById('inc').innerText = fmt(s.pph) + ' /сек (PPH: ' + fmt(s.pph * 3600) + ')';
  
  for(let i=RANK_REQ.length-1;i>=0;i--) if(s.totalEarned>=RANK_REQ[i]){ s.rank=i; break; }
  document.getElementById('rank').innerText = RANK_NAMES[s.rank];
}

/* Tap handler - с критами и красивыми поп-апами */
function tap(ev){
  const x = (ev.touches && ev.touches[0]) ? ev.touches[0].clientX : (ev.clientX || window.innerWidth/2);
  const y = (ev.touches && ev.touches[0]) ? ev.touches[0].clientY : (ev.clientY || window.innerHeight/2);
  
  let crit = 1;
  const roll = Math.random();

  if (roll < 0.005) crit = 10;
  else if (roll < 0.035) crit = 5;
  else if (roll < 0.155) crit = 2;

  const gain = Math.floor(s.tapBase * s.tapMult * crit); 
  s.energy += gain; 
  s.totalEarned += gain;

  updateQuestProgress('daily', 1, {type:'tapCount'});
  if (crit === 10) updateQuestProgress('daily', 1, {type:'crit10'});
  if (crit > 1) updateQuestProgress('special', 1, {type:'critTotal'});

  const el = document.createElement('div');
  el.className = 'floating';
  const angle = (Math.random() * 40 - 20);
  const offsetX = (Math.random() * 60 - 30);
  const offsetY = Math.random() * 140 + 80;

  el.innerText = `+${gain}`;
  el.style.left = (x + offsetX) + 'px';
  el.style.top = (y + 10) + 'px';

  el.animate([
    { transform:`translate(0,0) rotate(${angle}deg)`, opacity:1 },
    { transform:`translate(0,-${offsetY}px) rotate(${angle}deg)`, opacity:0 }
  ], {
    duration: 1100 + Math.random()*400,
    easing: 'ease-out'
  });

  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1600);

  if (crit > 1) {
      const boom = document.createElement('div');
      boom.className = 'critBoom';
      boom.innerText = `x${crit}`;
      boom.style.left = (x - 20) + 'px';
      boom.style.top = (y - 20) + 'px';

      boom.animate([
        { transform: 'scale(1)', opacity: 1 },
        { transform: 'scale(2.2)', opacity: 0 }
      ], {
        duration: 420,
        easing: 'ease-out'
      });

      document.body.appendChild(boom);
      setTimeout(()=> boom.remove(), 500);
      try{ tg.HapticFeedback?.notificationOccurred('success'); }catch(e){}
  }

  const r = document.getElementById('reactor');
  r.classList.add('glitch');
  setTimeout(()=>r.classList.remove('glitch'),180);

  try { tg.HapticFeedback?.impactOccurred('light'); } catch(e){}
  ui(); saveState();
}

/* Passive loop (smooth) */
setInterval(()=>{
  recalcPassive();
  s.energy += s.pph/10; 
  
  if(s.energy >= 1000){
    const whole = Math.floor(s.energy/1000);
    const toAdd = whole * 0.95; 
    s.punk += toAdd; s.energy -= whole*1000;
  }
  updateQuestProgress('progress', s.energy, {type:'energyTotal', value: s.energy});
  ui();
},100);

/* Autosave */
setInterval(()=>saveState(),4000);
window.addEventListener('beforeunload', saveState);

/* Popup helpers */
function pop(html){ document.getElementById('popcard').innerHTML = html; document.getElementById('pop').style.display = 'flex'; }
function popClose(){ document.getElementById('pop').style.display = 'none'; }

/* Shops and special screens */
function openShop(type){
  if(type==='fleet') return openFleet();
  if(type==='crew') return openCrew();
  if(type==='impl') return openImplants();
  if(type==='raid') return openRaid();
  if(type==='market') return openMarket();
}

function openFleet(){
  let html = `<h2 style="color:var(--n1);text-align:center">ФЛОТ</h2>`;
  for(const k in SHIPS){
    const sh = SHIPS[k];
    const owned = s.ships[k]||0;
    const price = priceForShip(k);
    html += `<div class="pop-item"><strong>${sh.name}</strong><div class="small-muted">Базовый Доход: ${sh.income}/сек • Слоты: ${k==='r'?5:(k==='c'?4:(k==='h'?3:(k==='f'?2:1)))}</div>Цена: ${price.toLocaleString('ru-RU')} энергии • У тебя: ${owned}<div style="margin-top:8px"><button class="btn primary" onclick="buyShip('${k}',${price})">Купить</button></div></div>`;
  }
  html += `<div style="margin-top:12px"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`;
  pop(html);
}
function buyShip(k, price){
  if(s.energy >= price){
    s.energy -= price; 
    s.ships[k] = (s.ships[k]||0)+1; 
    if(k==='f') updateQuestProgress('progress', 1, {type:'buyShipC'});
    recalcPassive(); ui(); saveState(); popClose(); try{ tg.showAlert('Корабль приобретён'); }catch(e){} 
  } else { try{ tg.showAlert('Недостаточно энергии'); }catch(e){ alert('Недостаточно энергии'); } }
}

function openCrew(){
  let html = `<h2 style="color:var(--n1);text-align:center">ЭКИПАЖ</h2>`;
  for(const k in CREW){
    const it = CREW[k];
    const hired = s.crew[it.id];
    const ownedText = hired ? ' (нанят)' : '';
    const descText = it.type === 'pph' ? it.desc : (it.type === 'autotap' ? `${it.mult} авто-тап/сек` : it.desc);
    
    html += `<div class="pop-item"><strong>${it.name}</strong><div class="small-muted">${descText}</div>Цена: ${it.price.toLocaleString('ru-RU')} энергии${ownedText}<div style="margin-top:8px"><button class="btn" onclick="toggleCrew('${it.id}',${it.price})">${hired?'Уволить':'Нанять'}</button></div></div>`;
  }
  html += `<div style="margin-top:12px"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`;
  pop(html);
}
function toggleCrew(id, price){
  if(s.crew[id]){ 
    delete s.crew[id]; 
    recalcPassive(); ui(); saveState(); openCrew(); return; 
  }
  if(s.energy >= price){ 
    s.energy -= price; s.crew[id]=true; 
    recalcPassive(); ui(); saveState(); openCrew(); 
  }
  else try{ tg.showAlert('Недостаточно энергии'); }catch(e){}
}

function openImplants(){
  let html = `<h2 style="color:var(--n1);text-align:center">ИМПЛАНТЫ</h2>`;
  for(const k in IMPLANTS){
    const it = IMPLANTS[k];
    const currentLevel = s.impl[it.id]?.level || 0;
    const price = priceForImpl(it.id);
    const ownedText = currentLevel > 0 ? ` (Уровень: ${currentLevel}/${it.maxLvl})` : '';
    const isMax = currentLevel >= it.maxLvl;
    
    html += `<div class="pop-item"><strong>${it.name}</strong><div class="small-muted">${it.desc}</div>Цена: ${price.toLocaleString('ru-RU')} энергии${ownedText}<div style="margin-top:8px"><button class="btn ${!isMax ? 'primary' : 'ghost'}" onclick="buyImpl('${it.id}',${price})" ${isMax ? 'disabled' : ''}>${isMax ? 'МАКС. УРОВЕНЬ' : 'Улучшить'}</button></div></div>`;
  }
  html += `<div style="margin-top:12px"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`;
  pop(html);
}
function buyImpl(id, price){
  const it = IMPLANTS[id];
  const currentLevel = s.impl[it.id]?.level || 0;
  if (currentLevel >= it.maxLvl) return;

  if(s.energy >= price){ 
    s.energy -= price; 
    if(!s.impl[id]) s.impl[id] = {level: 0};
    s.impl[id].level++;
    
    if(s.impl[id].level === 1) updateQuestProgress('daily', 1, {type:'buyImpl'});
    
    recalcPassive(); ui(); saveState(); openImplants(); 
  }
  else try{ tg.showAlert('Недостаточно энергии'); }catch(e){}
}

function openRaid(){ pop(`<h2 style="color:var(--n1);text-align:center">КРИПТО-РЕЙД: NeonCorp</h2><div class="pop-item">Событие Community Raid. Тапайте по барьеру корпорации вместе с другими игроками, чтобы получить общий $PUNK приз. Cooldown 4 часа.</div><div style="margin-top:12px"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`); }
function openMarket(){ pop(`<h2 style="color:var(--n1);text-align:center">ТЁМНЫЙ РЫНОК (NFT)</h2><div class="pop-item">NFT-Флот (Ghost Ship), Временные Бустеры (x2 PPH) и другие редкие предметы за $PUNK. Появятся в следующем обновлении.</div><div style="margin-top:12px"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`); }
function openProfile(){ pop(`<h2 style="color:var(--n1);text-align:center">ПРОФИЛЬ</h2><div class="pop-item">Ранг: ${RANK_NAMES[s.rank]}<br>Всего заработано: ${fmt(s.totalEarned)}<br>PPH Множитель: x${s.pphMult.toFixed(2)}<br>Следующий ранг: ${RANK_NAMES[s.rank + 1]||'МАКС.'} (Требуется: ${fmt(RANK_REQ[s.rank + 1]||0)})</div><div style="margin-top:12px"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`); }

/* ======== QUEST SYSTEM LOGIC (без изменений) ======== */

function updateQuestProgress(category, amount, data = {}) {
  const questList = QUESTS[category];
  const progressState = category === 'daily' ? s.dailyProgress : (category === 'progress' ? s.progressDone : s.specialDone);

  for (const q of questList) {
    if (progressState[q.id] && progressState[q.id].done) continue;

    if (q.type === data.type) {
      let currentProgress = progressState[q.id]?.progress || 0;
      let isCompleted = false;

      if (q.type === 'tapCount' || q.type === 'crit10' || q.type === 'buyImpl' || q.type === 'buyShipC' || q.type === 'critTotal') {
        currentProgress += amount;
        if (q.target && currentProgress >= q.target) isCompleted = true;
      } else if (q.type === 'energyTotal') {
        if (data.value >= q.target) isCompleted = true;
        currentProgress = data.value;
      } else if (q.type === 'multAchieved') {
        if (data.value >= q.target) isCompleted = true;
        currentProgress = Math.min(data.value, q.target);
      }

      if (isCompleted) {
        progressState[q.id] = { progress: q.target || currentProgress, done: true, collected: false };
      } else {
        progressState[q.id] = { progress: currentProgress, done: false, collected: false };
      }
    }
  }
}

function giveReward(reward){
  if(reward.energy) s.energy += reward.energy;
  if(reward.permMult) s.pphMult *= reward.permMult; 
  recalcPassive();
}

function collectQuestReward(category, id) {
  const questList = QUESTS[category];
  const progressState = category === 'daily' ? s.dailyProgress : (category === 'progress' ? s.progressDone : s.specialDone);
  const q = questList.find(item => item.id === id);

  if (q && progressState[id] && progressState[id].done && !progressState[id].collected) {
    giveReward(q.reward);
    progressState[id].collected = true;
    showQuestPopup("Награда получена!", `+${q.reward.energy ? fmt(q.reward.energy) : `x${q.reward.permMult}`} бонус`);
    ui();
    openQuests(); 
  }
}

function showQuestPopup(title, text) {
    const el = document.createElement("div");
    el.className = "questPopup";
    el.innerHTML = `<strong>${title}</strong><br>${text}`;
    document.body.appendChild(el);

    el.animate([
        { transform: "translateY(0)", opacity: 1 },
        { transform: "translateY(-30px)", opacity: 0 }
    ], { duration: 1500 });

    setTimeout(() => el.remove(), 1500);
}

function openQuests(){
  let html = `<h2 style="color:var(--n1);text-align:center">СИСТЕМА КВЕСТОВ</h2>`;
  
  html += `<h3>Ежедневные Квесты</h3>`;
  html += buildQuestList('daily');
  
  html += `<h3>Квесты Прогрессии</h3>`;
  html += buildQuestList('progress');
  
  html += `<h3>Специальные Квесты</h3>`;
  html += buildQuestList('special');
  
  html += `<div style="margin-top:12px; text-align:center"><button class="btn ghost" onclick="popClose()">Закрыть</button></div>`;
  pop(html);
}

function buildQuestList(category) {
  let listHtml = '';
  const questList = QUESTS[category];
  const progressState = category === 'daily' ? s.dailyProgress : (category === 'progress' ? s.progressDone : s.specialDone);

  for (const q of questList) {
    const state = progressState[q.id] || { progress: 0, done: false, collected: false };
    const progressText = q.target ? `(${fmt(Math.min(state.progress, q.target))} / ${fmt(q.target)})` : '';
    const isDone = state.done;
    const isCollected = state.collected;
    const itemClass = isDone ? (isCollected ? 'questComplete' : 'questComplete') : '';
    const buttonText = isCollected ? 'Получено' : 'Получить';

    listHtml += `<div class="pop-item ${itemClass}">
      <strong>${q.text}</strong> ${progressText}
      <div class="small-muted">Награда: ${q.reward.energy ? `${fmt(q.reward.energy)} энергии` : (q.reward.permMult ? `x${q.reward.permMult} мульт PPH` : 'Бонус')}</div>
      <div style="margin-top:8px">
        <button class="btn ${isDone && !isCollected ? 'primary' : 'ghost'}" 
          onclick="collectQuestReward('${category}', '${q.id}')" 
          ${!isDone || isCollected ? 'disabled' : ''}>
          ${buttonText}
        </button>
      </div>
    </div>`;
  }
  return listHtml;
}


/* init */
loadState();
recalcPassive(); // Ensure initial passive calculation is correct, especially for autotap
ui();

</script>
</body>
</html>