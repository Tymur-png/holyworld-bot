<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CosmoPunk: Rebellion 2149</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #05000a;
            --accent: #d300d3; /* Neon Purple */
            --cyan: #00f7ff;    /* Cyber Blue */
            --yellow: #f7ff00;  /* Acid Yellow */
            --danger: #ff2a2a;
            --glass: rgba(20, 10, 30, 0.85);
            --border: rgba(255, 255, 255, 0.1);
            --font: 'Courier New', Courier, monospace; /* –ë–æ–ª–µ–µ —Ö–∞–∫–µ—Ä—Å–∫–∏–π —à—Ä–∏—Ñ—Ç */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            /* –°–µ—Ç–∫–∞ —Ä–µ—Ç—Ä–æ-–≤–µ–π–≤ –Ω–∞ —Ñ–æ–Ω–µ */
            background-image: 
                linear-gradient(rgba(11, 0, 20, 0.9), rgba(11, 0, 20, 0.9)),
                repeating-linear-gradient(0deg, transparent 0, transparent 1px, var(--cyan) 1px, transparent 2px),
                repeating-linear-gradient(90deg, transparent 0, transparent 1px, var(--accent) 1px, transparent 2px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            color: #fff;
            font-family: var(--font);
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #app { display: flex; flex-direction: column; height: 100vh; padding: 12px; position: relative; z-index: 2; }

        /* --- HUD --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .resource-panel {
            background: var(--glass);
            border-left: 3px solid var(--cyan);
            padding: 8px 15px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(0, 247, 255, 0.2);
        }
        
        #energy-display { font-size: 24px; font-weight: 900; color: var(--cyan); text-shadow: 0 0 8px var(--cyan); }
        .income-rate { font-size: 10px; color: #aaa; letter-spacing: 1px; }

        .rank-badge {
            text-align: right;
            border-right: 3px solid var(--accent);
            padding: 8px 15px;
            background: var(--glass);
        }
        #rank-name { color: var(--accent); font-weight: bold; font-size: 12px; text-transform: uppercase; }
        #level-display { font-size: 10px; color: #fff; }

        /* --- REACTOR --- */
        #main-stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; perspective: 800px; }
        
        .reactor-container { 
            position: relative; width: 260px; height: 260px; 
            display: flex; justify-content: center; align-items: center; 
            transition: transform 0.1s; cursor: pointer;
            transform-style: preserve-3d;
        }
        .reactor-container:active { transform: scale(0.97) !important; }

        .core-glow {
            position: absolute; inset: 0; border-radius: 50%;
            background: radial-gradient(circle, rgba(211,0,211,0.4) 0%, transparent 70%);
            animation: pulse 2s infinite alternate; pointer-events: none;
        }

        #reactor-visual { 
            width: 100%; height: 100%; object-fit: contain; z-index: 5;
            filter: drop-shadow(0 0 20px var(--accent));
        }

        /* --- CONTROLS --- */
        .nav-dock {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            padding-bottom: 10px;
        }
        .dock-btn {
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--border); border-radius: 8px;
            height: 55px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 9px; color: #888; cursor: pointer; transition: 0.2s;
        }
        .dock-btn.active { border-color: var(--cyan); color: #fff; background: rgba(0, 247, 255, 0.1); }
        .dock-btn span { font-size: 20px; margin-bottom: 3px; }

        /* --- MODALS --- */
        #modal-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            display: none; align-items: flex-end;
            animation: fadeIn 0.3s;
        }
        
        .cyber-card {
            background: #0f0518; 
            border-top: 2px solid var(--accent);
            width: 100%; max-height: 80vh;
            display: flex; flex-direction: column;
            box-shadow: 0 -10px 50px rgba(211, 0, 211, 0.3);
            border-radius: 20px 20px 0 0;
            animation: slideUp 0.3s cubic-bezier(0.1, 0.8, 0.2, 1);
        }

        .card-header { 
            padding: 20px; text-align: center; border-bottom: 1px solid #222;
            font-family: 'Arial', sans-serif; font-weight: 900; letter-spacing: 2px;
            color: #fff; text-transform: uppercase;
        }
        .card-scroll { padding: 15px; overflow-y: auto; flex: 1; }
        
        .close-btn {
            width: 100%; padding: 18px; background: #1a1a1a; border: none; color: #fff;
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer;
        }

        /* --- ITEMS --- */
        .item-row {
            display: flex; gap: 12px; align-items: center;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            padding: 12px; margin-bottom: 10px; border-radius: 12px;
        }
        .item-thumb { 
            width: 50px; height: 50px; background: #000; border-radius: 8px; 
            object-fit: contain; border: 1px solid #333;
        }
        .item-data { flex: 1; }
        .item-title { font-size: 14px; font-weight: bold; color: #fff; margin-bottom: 4px; }
        .item-desc { font-size: 10px; color: #777; font-style: italic; margin-bottom: 4px; display: block;}
        .item-stat { font-size: 11px; color: var(--cyan); }
        
        .buy-btn {
            background: var(--accent); color: #fff; border: none;
            padding: 8px 14px; border-radius: 6px; font-size: 12px; font-weight: bold;
        }
        .buy-btn:disabled { background: #333; color: #555; }

        /* --- FX --- */
        .float-txt {
            position: absolute; font-weight: bold; font-size: 24px; pointer-events: none; z-index: 50;
            text-shadow: 0 0 5px currentColor;
        }

        @keyframes pulse { 0% {opacity:0.3; transform:scale(0.9);} 100% {opacity:0.6; transform:scale(1.1);} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
    </style>
</head>
<body>

<div id="app">
    <div class="top-bar">
        <div class="resource-panel">
            <div id="energy-display">0</div>
            <div class="income-rate" id="income-display">0 PUNK/s</div>
        </div>
        <div class="rank-badge">
            <div id="rank-name">Street Rat</div>
            <div id="level-display">LVL 1</div>
        </div>
    </div>

    <div id="main-stage">
        <div class="reactor-container" id="tap-zone">
            <div class="core-glow"></div>
            <img src="assets/reactor/reactor.gif" id="reactor-visual" onerror="this.src='https://cdn-icons-png.flaticon.com/512/9309/9309584.png'">
        </div>
        <div style="margin-top:20px; opacity: 0.6; font-size: 10px; text-align: center;">
            TAP TO HACK THE SYSTEM
        </div>
    </div>

    <div class="nav-dock">
        <div class="dock-btn" onclick="openMenu('ships')"><span>üöÄ</span>–§–õ–û–¢</div>
        <div class="dock-btn" onclick="openMenu('crew')"><span>üë•</span>–≠–ö–ò–ü–ê–ñ</div>
        <div class="dock-btn" onclick="openMenu('implants')"><span>üß†</span>–ò–ú–ü–õ–ê–ù–¢–´</div>
        <div class="dock-btn" onclick="openMenu('profile')"><span>‚öôÔ∏è</span>–î–ê–ù–ù–´–ï</div>
    </div>
</div>

<div id="modal-overlay" onclick="if(event.target.id==='modal-overlay') closeMenu()">
    <div class="cyber-card">
        <div class="card-header" id="modal-title">TITLE</div>
        <div class="card-scroll" id="modal-content"></div>
        <button class="close-btn" onclick="closeMenu()">–ó–ê–ö–†–´–¢–¨ –¢–ï–†–ú–ò–ù–ê–õ</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- GAME CONFIG & DATA ---
    const CONFIG = {
        ranks: ["Street Rat", "Scavenger", "Cyber Punk", "Net Runner", "Void Lord", "GALAXY BARON"],
        saveKey: 'cosmopunk_save_v3'
    };

    // Database of items
    const DB = {
        ships: [
            { id: 's1', name: 'Rusty Drone', lore: '–°–ø–∏—Å–∞–Ω–Ω—ã–π –¥—Ä–æ–Ω –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏', baseCost: 100, inc: 1, img: 'ship1.png' },
            { id: 's2', name: 'Scrap Fighter', lore: '–°–æ–±—Ä–∞–Ω –∏–∑ –æ–±–ª–æ–º–∫–æ–≤', baseCost: 500, inc: 4, img: 'ship2.png' },
            { id: 's3', name: 'Punk Hauler', lore: '–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∏—Å—Ç—Å–∫–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç', baseCost: 1500, inc: 10, img: 'ship3.png' },
            { id: 's4', name: 'Neon Corsair', lore: '–ö–æ—Ä–∞–±–ª—å –ø–∏—Ä–∞—Ç—Å–∫–æ–π —ç–ª–∏—Ç—ã', baseCost: 5000, inc: 35, img: 'ship4.png' },
            { id: 's5', name: 'Void Reaper', lore: '–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–π –∫–ª–∞—Å—Å. –õ–µ–≥–µ–Ω–¥–∞', baseCost: 20000, inc: 120, img: 'ship5.png' }
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å ship6 - ship10 –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏
        ],
        implants: [
            { id: 'i_base', name: 'Base Implant', lore: '–ö–∞–∂–¥–∞—è –ª–µ–≥–µ–Ω–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –¥–µ—à—ë–≤–æ–≥–æ –∞–ø–≥—Ä–µ–π–¥–∞.', cost: 300, type: 'tap', val: 2, img: 'base.png' },
            { id: 'i_chip', name: '–†–∂–∞–≤—ã–π –ß–∏–ø', lore: '–†–∞–±–æ—Ç–∞–µ—Ç –ø–ª–æ—Ö–æ. –ù–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.', cost: 1000, type: 'passive_flat', val: 10, img: 'chip.png' },
            { id: 'i_eye', name: '–ö–∏–±–µ—Ä-–ì–ª–∞–∑', lore: '–¢—ã –Ω–µ –≤–∏–¥–∏—à—å –º–∏—Ä. –¢—ã —á–∏—Ç–∞–µ—à—å –µ–≥–æ.', cost: 5000, type: 'crit_mult', val: 0.5, img: 'eye.png' },
            { id: 'i_glitch', name: '–ì–ª–∏—Ç—á-–ü—Ä–æ—Ç–µ–∑', lore: '–û—à–∏–±–∫–∏ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏—Å—Ç–∏–Ω—ã.', cost: 15000, type: 'crit_chance', val: 0.1, img: 'glitch.png' },
            { id: 'i_neuro', name: '–ù–µ–æ-–ù–µ–π—Ä–æ–Ω', lore: '–î—É–º–∞–µ—à—å –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –º–∏—Ä —É—Å–ø–µ–≤–∞–µ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å.', cost: 50000, type: 'global_mult', val: 0.2, img: 'neuro.png' }
        ],
        crew: {
            bot: { name: '–ì–∏–≥–∞–ø–∞–Ω–∫-–ë–æ—Ç', role: '–ê–≤—Ç–æ-–º–∞–π–Ω–∏–Ω–≥', lore: '–¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å CosmoPunk.', cost: 500, mult: 1.5, img: 'bot.png' },
            hacker: { name: '–õ–∏—Å–∞-–•–∞–∫–µ—Ä', role: '–í–∑–ª–æ–º (–ö—Ä–∏—Ç)', lore: '–ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –≥–æ–≤–æ—Ä–∏—Ç –Ω–µ—Ç ‚Äî –ª–æ–º–∞–π –µ—ë.', cost: 1200, mult: 2.0, img: 'hacker.png' },
            captain: { name: '–ö–∞–ø–∏—Ç–∞–Ω –ö–æ—Å–º–æ', role: '–°—Ç—Ä–∞—Ç–µ–≥ –§–ª–æ—Ç–∞', lore: '–ì–∞–ª–∞–∫—Ç–∏–∫–∞ ‚Äî —ç—Ç–æ —à–∞—Ö–º–∞—Ç–Ω–∞—è –¥–æ—Å–∫–∞.', cost: 3000, mult: 1.8, img: 'captain.png' }
        }
    };

    // Player State
    let state = {
        energy: 0,
        total: 0,
        ships: {}, // {s1: 5, s2: 1...}
        crew: { bot: 0, hacker: 0, captain: 0 },
        implants: [], // ['i_base', 'i_eye']
        lastSave: Date.now()
    };

    // Load State
    const saved = localStorage.getItem(CONFIG.saveKey);
    if(saved) {
        state = { ...state, ...JSON.parse(saved) };
    }

    // --- LOGIC ENGINE ---

    // 1. Calculate Passive Income (Per Second)
    function getPassive() {
        let raw = 0;
        
        // Ships
        DB.ships.forEach(s => {
            if(state.ships[s.id]) raw += state.ships[s.id] * s.inc;
        });

        // Bot Bonus (Base passive income)
        if(state.crew.bot > 0) {
            raw += state.crew.bot * 20;
        }

        // Chip Implant (Flat Bonus)
        if(state.implants.includes('i_chip')) raw += 10;

        // Captain Multiplier (Boosts all fleet income)
        // Each captain level adds 10% to total fleet efficiency
        let fleetMult = 1 + (state.crew.captain * 0.1);
        raw = raw * fleetMult;

        // Neuro Implant (Global Multiplier x1.2)
        if(state.implants.includes('i_neuro')) raw *= 1.2;

        return raw;
    }

    // 2. Calculate Tap Power
    function getTap() {
        let base = 1;
        // Base Implant
        if(state.implants.includes('i_base')) base += 2;
        
        // Crew levels add slightly to tap
        base += (state.crew.hacker + state.crew.bot + state.crew.captain);

        // Crit Calculation
        let isCrit = false;
        let critChance = 0.05 + (state.crew.hacker * 0.02); // Hacker adds 2% per level
        if(state.implants.includes('i_glitch')) critChance += 0.1; // Glitch adds 10%

        let critMult = 10;
        if(state.implants.includes('i_eye')) critMult = 15; // Eye increases crit damage

        if(Math.random() < critChance) {
            isCrit = true;
            base *= critMult;
            tg.HapticFeedback.notificationOccurred('warning');
        } else {
            tg.HapticFeedback.impactOccurred('light');
        }

        // Neuro Implant
        if(state.implants.includes('i_neuro')) base *= 1.2;

        return { val: Math.floor(base), isCrit };
    }

    // Main Loop (1s tick)
    setInterval(() => {
        let inc = getPassive();
        if(inc > 0) {
            addEnergy(inc / 10); // 10 ticks per second
        }
        updateHUD();
    }, 100);

    // Save Loop
    setInterval(() => {
        localStorage.setItem(CONFIG.saveKey, JSON.stringify(state));
    }, 5000);

    function addEnergy(amount) {
        state.energy += amount;
        state.total += amount;
    }

    // --- INTERACTION ---

    document.getElementById('tap-zone').addEventListener('touchstart', (e) => {
        e.preventDefault();
        // Multitouch support
        [...e.changedTouches].forEach(t => handleTap(t.clientX, t.clientY));
    });
    
    document.getElementById('tap-zone').addEventListener('mousedown', (e) => {
        handleTap(e.clientX, e.clientY);
    });

    function handleTap(x, y) {
        const dmg = getTap();
        addEnergy(dmg.val);
        spawnFloater(x, y, dmg.val, dmg.isCrit);
        
        // Reactor Animation
        const el = document.getElementById('reactor-visual');
        el.style.transform = 'scale(0.95)';
        setTimeout(() => el.style.transform = 'scale(1)', 50);
    }

    // --- UI & MENUS ---

    function updateHUD() {
        document.getElementById('energy-display').innerText = Math.floor(state.energy).toLocaleString();
        document.getElementById('income-display').innerText = `+${Math.floor(getPassive())} PUNK/s`;
        
        let rankIdx = Math.min(Math.floor(state.total / 50000), CONFIG.ranks.length - 1);
        document.getElementById('rank-name').innerText = CONFIG.ranks[rankIdx];
        
        let totalLvl = state.crew.bot + state.crew.hacker + state.crew.captain + 1;
        document.getElementById('level-display').innerText = `LVL ${totalLvl}`;
    }

    function spawnFloater(x, y, val, crit) {
        let d = document.createElement('div');
        d.className = 'float-txt';
        d.innerText = `+${val}`;
        d.style.left = x + 'px';
        d.style.top = y + 'px';
        d.style.color = crit ? 'var(--yellow)' : 'var(--cyan)';
        if(crit) d.style.fontSize = '32px';
        document.body.appendChild(d);
        
        setTimeout(() => {
            d.style.transform = `translateY(-100px)`;
            d.style.opacity = 0;
        }, 50);
        setTimeout(() => d.remove(), 600);
    }

    // --- MENU GENERATOR ---

    function openMenu(type) {
        const modal = document.getElementById('modal-overlay');
        const title = document.getElementById('modal-title');
        const content = document.getElementById('modal-content');
        
        modal.style.display = 'flex';
        content.innerHTML = '';

        if (type === 'ships') {
            title.innerText = '–ê–ù–ì–ê–† –ö–û–†–ê–ë–õ–ï–ô';
            DB.ships.forEach(item => {
                let count = state.ships[item.id] || 0;
                let cost = Math.floor(item.baseCost * Math.pow(1.2, count));
                
                content.innerHTML += `
                <div class="item-row">
                    <img src="assets/ships/${item.img}" class="item-thumb" onerror="this.src='https://via.placeholder.com/50/00f7ff/000?text=S'">
                    <div class="item-data">
                        <div class="item-title">${item.name} <span style="color:#666">x${count}</span></div>
                        <span class="item-desc">${item.lore}</span>
                        <div class="item-stat">–î–æ—Ö–æ–¥: +${item.inc}/—Å–µ–∫</div>
                    </div>
                    <button class="buy-btn" onclick="buyShip('${item.id}', ${cost})">${cost.toLocaleString()}</button>
                </div>`;
            });
        }
        else if (type === 'crew') {
            title.innerText = '–ö–û–ú–ê–ù–î–ê';
            ['captain', 'hacker', 'bot'].forEach(role => {
                let data = DB.crew[role];
                let lvl = state.crew[role];
                let cost = Math.floor(data.cost * Math.pow(data.mult, lvl));

                content.innerHTML += `
                <div class="item-row">
                    <img src="assets/crew/${data.img}" class="item-thumb" onerror="this.src='https://via.placeholder.com/50/d300d3/000?text=C'">
                    <div class="item-data">
                        <div class="item-title">${data.name} (Lvl ${lvl})</div>
                        <span class="item-desc">"${data.lore}"</span>
                        <div class="item-stat">–†–æ–ª—å: ${data.role}</div>
                    </div>
                    <button class="buy-btn" onclick="upgradeCrew('${role}', ${cost})">${cost.toLocaleString()}</button>
                </div>`;
            });
        }
        else if (type === 'implants') {
            title.innerText = '–ö–ò–ë–ï–†-–•–ò–†–£–†–ì';
            DB.implants.forEach(imp => {
                let owned = state.implants.includes(imp.id);
                let btn = owned 
                    ? `<button class="buy-btn" disabled style="background:#333">–í–ñ–ò–í–õ–ï–ù–û</button>`
                    : `<button class="buy-btn" onclick="buyImplant('${imp.id}', ${imp.cost})">${imp.cost.toLocaleString()}</button>`;

                content.innerHTML += `
                <div class="item-row" style="${owned ? 'opacity:0.6' : ''}">
                    <img src="assets/implants/${imp.img}" class="item-thumb" onerror="this.src='https://via.placeholder.com/50/f7ff00/000?text=I'">
                    <div class="item-data">
                        <div class="item-title">${imp.name}</div>
                        <span class="item-desc">${imp.lore}</span>
                    </div>
                    ${btn}
                </div>`;
            });
        }
        else if (type === 'profile') {
            title.innerText = '–î–ê–ù–ù–´–ï';
            content.innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <h3 style="color:var(--cyan)">COSMOPUNK ID: #8821</h3>
                    <p style="color:#aaa; margin-top:10px;">–°—Ç–∞—Ç—É—Å: ${document.getElementById('rank-name').innerText}</p>
                    <hr style="border:0; border-bottom:1px solid #333; margin:20px 0;">
                    <button class="buy-btn" style="background:#ff2a2a; width:100%" onclick="resetGame()">–°–¢–ï–†–ï–¢–¨ –õ–ò–ß–ù–û–°–¢–¨ (–°–ë–†–û–°)</button>
                </div>
            `;
        }
    }

    function closeMenu() {
        document.getElementById('modal-overlay').style.display = 'none';
    }

    // --- ACTIONS ---

    function buyShip(id, cost) {
        if(state.energy >= cost) {
            state.energy -= cost;
            state.ships[id] = (state.ships[id] || 0) + 1;
            tg.HapticFeedback.selectionChanged();
            openMenu('ships'); // Redraw
        }
    }

    function upgradeCrew(role, cost) {
        if(state.energy >= cost) {
            state.energy -= cost;
            state.crew[role]++;
            tg.HapticFeedback.notificationOccurred('success');
            openMenu('crew');
        }
    }

    function buyImplant(id, cost) {
        if(state.energy >= cost && !state.implants.includes(id)) {
            state.energy -= cost;
            state.implants.push(id);
            tg.HapticFeedback.notificationOccurred('success');
            openMenu('implants');
        }
    }

    function resetGame() {
        if(confirm('–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç –≤–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
            localStorage.removeItem(CONFIG.saveKey);
            location.reload();
        }
    }

    // 3D Tilt Logic
    document.addEventListener('mousemove', (e) => {
        const x = (window.innerWidth / 2 - e.clientX) / 30;
        const y = (window.innerHeight / 2 - e.clientY) / 30;
        document.querySelector('.reactor-container').style.transform = `rotateY(${x}deg) rotateX(${y}deg)`;
    });

</script>
</body>
</html>