<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CosmoPunk: Syndicate Wars</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #05000a;
            --accent: #d300d3;
            --cyan: #00f7ff;
            --yellow: #f7ff00;
            --red: #ff2a2a;
            --glass: rgba(16, 20, 30, 0.95);
            --border: rgba(0, 247, 255, 0.3);
            --font: 'Courier New', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            color: #fff;
            font-family: var(--font);
            height: 100vh;
            overflow: hidden;
            user-select: none;
            position: relative;
        }

        /* MATRIX BG - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω z-index –∏ –∫–ª–∏–∫–∏ */
        #matrix-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; opacity: 0.15; pointer-events: none;
        }

        #app { 
            display: flex; flex-direction: column; height: 100vh; padding: 12px; 
            position: relative; z-index: 10; /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ã—à–µ —Ñ–æ–Ω–∞ */
            pointer-events: none; /* –°–∞–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ–∑—Ä–∞—á–µ–Ω –¥–ª—è –∫–ª–∏–∫–æ–≤ */
        }
        
        /* –†–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º */
        .hud, .reactor-wrap, .nav-btn, #hack-btn, .modal-card, .event-btn { pointer-events: auto; }

        /* HUD */
        .hud { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .res-box {
            background: var(--glass); border: 1px solid var(--border);
            padding: 8px 12px; border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,247,255,0.1);
            min-width: 100px;
        }
        #energy-val { font-size: 20px; font-weight: 900; color: var(--cyan); text-shadow: 0 0 10px var(--cyan); }
        .sub-text { font-size: 10px; color: #aaa; margin-top: 2px; }
        .rank-box { text-align: right; border-color: var(--accent); }
        #rank-val { color: var(--accent); font-weight: bold; font-size: 12px; text-transform: uppercase; }

        /* COMBO BAR */
        .combo-container {
            width: 100%; height: 6px; background: #222; margin-bottom: 15px;
            border-radius: 3px; overflow: hidden; position: relative;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            pointer-events: auto;
        }
        .combo-fill {
            height: 100%; background: linear-gradient(90deg, var(--yellow), var(--red));
            width: 0%; transition: width 0.1s linear;
        }
        .combo-text {
            position: absolute; width: 100%; text-align: center; top: -15px;
            font-size: 10px; font-weight: bold; color: var(--yellow); opacity: 0;
            transition: opacity 0.2s;
        }

        /* REACTOR */
        #stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; pointer-events: none; }
        
        .reactor-wrap { 
            position: relative; width: 280px; height: 280px; 
            display: flex; justify-content: center; align-items: center; 
            transition: transform 0.1s; 
            z-index: 20;
            cursor: pointer;
        }
        .reactor-wrap:active { transform: scale(0.95); }
        
        .shake { animation: shake 0.15s cubic-bezier(.36,.07,.19,.97) both; }

        #reactor-img { 
            width: 100%; height: 100%; object-fit: contain; z-index: 5;
            filter: drop-shadow(0 0 30px rgba(211,0,211,0.5));
            pointer-events: none; /* –ö–ª–∏–∫ –ª–æ–≤–∏—Ç —Ä–æ–¥–∏—Ç–µ–ª—å */
        }

        /* RAID EVENT BUTTON */
        #raid-btn {
            position: absolute; top: 10%; right: 10px;
            width: 60px; height: 60px; background: var(--red);
            border-radius: 50%; border: 3px solid #fff;
            display: none; align-items: center; justify-content: center;
            font-size: 24px; animation: pulse-btn 0.5s infinite;
            z-index: 50; cursor: pointer;
            box-shadow: 0 0 20px var(--red);
        }

        /* HACK BUTTON */
        #hack-btn {
            margin-top: 25px;
            background: linear-gradient(90deg, #ff004c, #ff9100);
            border: none; padding: 12px 24px; border-radius: 25px;
            color: #fff; font-weight: bold; font-size: 14px; letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(255, 0, 76, 0.4);
            opacity: 0.5; filter: grayscale(1); pointer-events: none; transition: 0.3s;
            position: relative; z-index: 25;
        }
        #hack-btn.ready { opacity: 1; filter: grayscale(0); pointer-events: auto; animation: pulse-btn 1.5s infinite; }

        /* NAV */
        .nav { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding-bottom: 10px; position: relative; z-index: 30; }
        .nav-btn {
            background: rgba(0,0,0,0.8); border: 1px solid var(--border); border-radius: 12px;
            height: 55px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; color: #888; transition: 0.2s; backdrop-filter: blur(4px);
        }
        .nav-btn span { font-size: 20px; margin-bottom: 4px; }
        .nav-btn:active { background: var(--cyan); color: #000; border-color: #fff; transform: translateY(2px); }

        /* MODALS */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; align-items: flex-end; justify-content: center;
            animation: fadeIn 0.2s;
        }
        .modal-card {
            background: #0b0514; border-top: 2px solid var(--accent);
            width: 100%; max-height: 85vh; border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 -10px 50px rgba(211, 0, 211, 0.2);
            animation: slideUp 0.3s;
        }
        .modal-header { 
            padding: 15px; text-align: center; font-weight: bold; font-size: 16px; 
            border-bottom: 1px solid #222; letter-spacing: 2px; color: var(--accent);
        }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }

        /* ITEMS LIST */
        .item { 
            display: flex; gap: 12px; align-items: center; 
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            padding: 10px; border-radius: 12px; margin-bottom: 10px;
        }
        .item img { 
            width: 50px; height: 50px; object-fit: contain; 
            background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid #333;
        }
        .item-info { flex: 1; }
        .item-name { font-size: 14px; font-weight: bold; color: #fff; margin-bottom: 4px;}
        .item-desc { font-size: 11px; color: #888; }
        .btn-buy {
            background: var(--cyan); color: #000; border: none; padding: 8px 14px;
            border-radius: 8px; font-size: 12px; font-weight: bold; min-width: 80px;
        }
        .btn-owned { background: #333; color: #555; pointer-events: none; }

        /* MINI GAME UI */
        #hack-game-ui { width: 100%; padding: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .hack-track {
            width: 100%; height: 24px; background: #111; border-radius: 12px;
            position: relative; overflow: hidden; margin: 25px 0; border: 2px solid #444;
        }
        .hack-target {
            position: absolute; top: 0; bottom: 0; width: 40px; 
            background: var(--yellow); opacity: 0.8; left: 50%; transform: translateX(-50%);
            box-shadow: 0 0 15px var(--yellow);
        }
        .hack-cursor {
            position: absolute; top: -2px; bottom: -2px; width: 4px;
            background: var(--red); left: 0%; 
            box-shadow: 0 0 10px var(--red); z-index: 2;
        }
        .hack-btn-action {
            width: 100%; padding: 18px; background: var(--red); color: #fff;
            border: none; font-size: 18px; font-weight: 900; border-radius: 12px;
        }

        /* FX */
        .float-txt { 
            position: absolute; font-weight: 900; font-size: 26px; 
            pointer-events: none; z-index: 90; text-shadow: 0 2px 0 #000;
        }
        
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-3px, 0, 0); } 40%, 60% { transform: translate3d(3px, 0, 0); } }
        @keyframes pulse-btn { 0% {box-shadow: 0 0 0 0 rgba(255, 0, 76, 0.7); transform:scale(1);} 50% {transform:scale(1.05);} 100% {box-shadow: 0 0 0 15px rgba(255, 0, 76, 0); transform:scale(1);} }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div id="app">
    <div class="hud">
        <div class="res-box">
            <div id="energy-val">0</div>
            <div class="sub-text" id="inc-val">+0 / —Å–µ–∫</div>
        </div>
        <div class="res-box rank-box">
            <div id="rank-val">NOBODY</div>
            <div class="sub-text">–†–ê–ù–ì –°–ò–°–¢–ï–ú–´</div>
        </div>
    </div>

    <div class="combo-container">
        <div class="combo-text" id="combo-txt">COMBO x1.0</div>
        <div class="combo-fill" id="combo-bar"></div>
    </div>

    <div id="stage">
        <div id="raid-btn" onclick="hitRaidBoss()">üëæ</div>

        <div class="reactor-wrap" id="tap-zone">
            <img src="assets/reactor/reactor.gif" id="reactor-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/9309/9309584.png'">
        </div>
        <button id="hack-btn" onclick="startHackGame()">‚ò† –í–ó–õ–û–ú –°–ò–°–¢–ï–ú–´</button>
    </div>

    <div class="nav">
        <div class="nav-btn" onclick="openMenu('ships')"><span>üöÄ</span>–§–ª–æ—Ç</div>
        <div class="nav-btn" onclick="openMenu('crew')"><span>üë•</span>–ë–∞–Ω–¥–∞</div>
        <div class="nav-btn" onclick="openMenu('implants')"><span>üß†</span>–ß–∏–ø—ã</div>
        <div class="nav-btn" onclick="openMenu('rebirth')"><span>üß¨</span>–°–±—Ä–æ—Å</div>
    </div>
</div>

<div class="modal-overlay" id="main-modal" onclick="if(event.target.id==='main-modal') closeModal()">
    <div class="modal-card">
        <div class="modal-header" id="modal-title">TITLE</div>
        <div class="modal-body" id="modal-content"></div>
        <button style="padding:15px; background:#111; color:#fff; border:none; border-top:1px solid #333; font-weight:bold;" onclick="closeModal()">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div class="modal-overlay" id="hack-modal">
    <div class="modal-card" style="height: auto; border-color: var(--red);">
        <div class="modal-header" style="color:var(--red)">–ü–†–û–†–´–í FIREWALL</div>
        <div class="modal-body">
            <div id="hack-game-ui">
                <p style="color:#ccc; font-size:12px; margin-bottom:10px;">–û—Å—Ç–∞–Ω–æ–≤–∏ –∫—É—Ä—Å–æ—Ä –≤ –∂–µ–ª—Ç–æ–π –∑–æ–Ω–µ!</p>
                <div class="hack-track">
                    <div class="hack-target" id="hack-target-zone"></div>
                    <div class="hack-cursor" id="hack-cursor"></div>
                </div>
                <button class="hack-btn-action" onmousedown="stopHack()" ontouchstart="stopHack()">–í–ó–õ–û–ú–ê–¢–¨</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- AUDIO ENGINE ---
    const AudioFX = {
        ctx: null,
        init: function() {
            if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        },
        play: function(type) {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            const now = this.ctx.currentTime;
            
            if(type === 'tap') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'buy') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'raid') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }
    };

    // --- GAME DATA ---
    const tg = window.Telegram.WebApp;
    tg.expand();
    const SAVE_KEY = 'cp_wars_redux';

    const DB = {
        ships: [
            { id: 's1', name: '–î—Ä–æ–Ω-—Ä–∞–∑–≤–µ–¥—á–∏–∫', inc: 1, cost: 150, img: 'assets/ships/ship1.png' },
            { id: 's2', name: '–®–µ—Ä—à–µ–Ω—å', inc: 5, cost: 750, img: 'assets/ships/ship2.png' },
            { id: 's3', name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∏–∫', inc: 15, cost: 2500, img: 'assets/ships/ship3.png' },
            { id: 's4', name: '–§—Ä–µ–≥–∞—Ç –ù–µ–æ–Ω', inc: 45, cost: 9000, img: 'assets/ships/ship4.png' },
            { id: 's5', name: '–ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫', inc: 120, cost: 30000, img: 'assets/ships/ship5.png' },
            { id: 's6', name: '–≠—Å–º–∏–Ω–µ—Ü –ë—É—Ä—è', inc: 400, cost: 100000, img: 'assets/ships/ship6.png' },
            { id: 's7', name: '–ö—Ä–µ–π—Å–µ—Ä –¢–µ—Å–ª–∞', inc: 1500, cost: 450000, img: 'assets/ships/ship7.png' },
            { id: 's8', name: '–õ–∏–Ω–∫–æ—Ä –î–æ–º–∏–Ω–∞—Ç–æ—Ä', inc: 5000, cost: 1500000, img: 'assets/ships/ship8.png' },
            { id: 's9', name: '–ê–≤–∏–∞–Ω–æ—Å–µ—Ü –£–ª—å—è', inc: 20000, cost: 7000000, img: 'assets/ships/ship9.png' },
            { id: 's10', name: '–ó–≤–µ–∑–¥–∞ –°–∏–Ω–¥–∏–∫–∞—Ç–∞', inc: 100000, cost: 50000000, img: 'assets/ships/ship10.png' }
        ],
        crew: [
            { id: 'c1', name: '–•–∞–∫–µ—Ä –õ–∏—Å–∞', desc: '–ö—Ä–∏—Ç —à–∞–Ω—Å +5%', cost: 1000, type: 'crit', val: 0.05, img: 'assets/crew/hacker.png' },
            { id: 'c2', name: '–ë–æ—Ç-—à–∞—Ö—Ç–µ—Ä', desc: '–ê–≤—Ç–æ-–¥–æ—Ö–æ–¥ +30/—Å–µ–∫', cost: 2000, type: 'passive', val: 30, img: 'assets/crew/bot.png' },
            { id: 'c3', name: '–ö–∞–ø–∏—Ç–∞–Ω', desc: '–ë–∞–∑–∞ –∫–ª–∏–∫–∞ x2', cost: 10000, type: 'mult', val: 1.0, img: 'assets/crew/captain.png' }
        ],
        implants: [
            { id: 'i1', name: '–ù–µ–π—Ä–æ-—á–∏–ø v1', desc: '+2 –∫ —Å–∏–ª–µ –∫–ª–∏–∫–∞', cost: 500, clickAdd: 2, img: 'assets/implants/base.png' },
            { id: 'i2', name: '–ö–∏–±–µ—Ä-–ì–ª–∞–∑', desc: '–ö—Ä–∏—Ç x2 –º–æ—â–Ω–µ–µ', cost: 3500, critPower: 1, img: 'assets/implants/eye.png' },
            { id: 'i3', name: '–¢–∏—Ç–∞–Ω-–†—É–∫–∞', desc: '+50 –∫ —Å–∏–ª–µ –∫–ª–∏–∫–∞', cost: 15000, clickAdd: 50, img: 'assets/implants/neuro.png' },
            { id: 'i4', name: '–ì–ª–∏—Ç—á-–ú–æ–¥—É–ª—å', desc: '–ê–≤—Ç–æ-–¥–æ—Ö–æ–¥ x1.2', cost: 50000, globalMult: 0.2, img: 'assets/implants/glitch.png' },
            { id: 'i5', name: '–ö–≤–∞–Ω—Ç–æ–≤–æ–µ –Ø–¥—Ä–æ', desc: '–ê–≤—Ç–æ-–¥–æ—Ö–æ–¥ x2', cost: 1000000, globalMult: 1.0, img: 'assets/implants/chip.png' }
        ]
    };

    let state = {
        energy: 0,
        total: 0,
        prestigeTokens: 0, // –ù–∞–Ω–æ-–±–æ—Ç—ã
        ships: {},
        crew: {},
        implants: [],
        lastHack: 0,
        lastSave: Date.now()
    };

    // COMBO SYSTEM VARS
    let comboCount = 0;
    let comboTimer = null;
    let raidActive = false;
    let raidClicks = 0;

    // --- INIT ---
    let saved = localStorage.getItem(SAVE_KEY);
    if(saved) {
        let parsed = JSON.parse(saved);
        state = { ...state, ...parsed };
        if(!state.implants) state.implants = [];
        if(!state.prestigeTokens) state.prestigeTokens = 0;
    }

    // Offline Earnings
    let offlineSeconds = (Date.now() - state.lastSave) / 1000;
    if(offlineSeconds > 60) {
        let earn = calcIncome() * offlineSeconds;
        if(earn > 0) {
            state.energy += earn;
            state.total += earn;
            setTimeout(() => alert(`–û—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥: ${Math.floor(earn).toLocaleString()} PUNK`), 500);
        }
    }

    // Loops
    setInterval(() => {
        let inc = calcIncome() / 10;
        if(inc > 0) addEnergy(inc);
        updateHUD();
        checkHackStatus();
    }, 100);
    
    // Random Raid Event (Every 60-120s)
    setInterval(() => {
        if(Math.random() > 0.8 && !raidActive) startRaidEvent();
    }, 10000);

    setInterval(saveGame, 5000);
    initMatrix();

    // --- LOGIC ---
    function calcIncome() {
        let income = 0;
        DB.ships.forEach(s => {
            if(state.ships[s.id]) income += state.ships[s.id] * s.inc;
        });
        if(state.crew['c2']) income += state.crew['c2'] * 30;
        
        let mult = 1;
        state.implants.forEach(impId => {
            let item = DB.implants.find(i => i.id === impId);
            if(item && item.globalMult) mult += item.globalMult;
        });

        // Prestige Bonus (+10% per token)
        mult += (state.prestigeTokens * 0.1);
        
        return income * mult;
    }

    function addEnergy(amount) {
        state.energy += amount;
        state.total += amount;
    }

    function tap(e) {
        AudioFX.init();
        if(e) e.preventDefault(); // Stop zoom
        
        let touches = e ? (e.changedTouches || [e]) : [{clientX: window.innerWidth/2, clientY: window.innerHeight/2}];

        // COMBO LOGIC
        comboCount++;
        clearTimeout(comboTimer);
        comboTimer = setTimeout(() => {
            comboCount = 0;
            updateComboUI();
        }, 1500); // 1.5 sec to keep combo
        updateComboUI();

        // Calc Power
        let flatBonus = 0;
        let critMult = 10;

        if(state.implants) {
            state.implants.forEach(impId => {
                let item = DB.implants.find(i => i.id === impId);
                if(item && item.clickAdd) flatBonus += item.clickAdd;
                if(item && item.critPower) critMult += (10 * item.critPower);
            });
        }

        let captainBonus = (state.crew['c3'] || 0) * 2; 
        
        // Combo Multiplier (max x5)
        let comboMult = 1 + Math.min(comboCount / 20, 4);
        
        // Prestige Multiplier
        let prestigeMult = 1 + (state.prestigeTokens * 0.1);

        let power = (1 + captainBonus + flatBonus) * comboMult * prestigeMult;

        for(let t of touches) {
            let critChance = 0.05 + (state.crew['c1'] || 0) * 0.05;
            let isCrit = Math.random() < critChance;
            
            if(isCrit) {
                power *= critMult;
                tg.HapticFeedback.notificationOccurred('warning');
            } else {
                tg.HapticFeedback.impactOccurred('light');
            }

            addEnergy(power);
            spawnFloat(t.clientX, t.clientY, Math.floor(power), isCrit);
            AudioFX.play('tap');
        }

        const r = document.getElementById('reactor-img');
        r.classList.remove('shake');
        void r.offsetWidth;
        r.classList.add('shake');
    }

    function updateComboUI() {
        let bar = document.getElementById('combo-bar');
        let txt = document.getElementById('combo-txt');
        let perc = Math.min(comboCount * 2, 100);
        bar.style.width = perc + '%';
        
        let mult = 1 + Math.min(comboCount / 20, 4);
        txt.innerText = `COMBO x${mult.toFixed(1)}`;
        txt.style.opacity = comboCount > 1 ? 1 : 0;
    }

    // --- RAID EVENT ---
    function startRaidEvent() {
        raidActive = true;
        raidClicks = 0;
        let btn = document.getElementById('raid-btn');
        btn.style.display = 'flex';
        AudioFX.play('raid'); // Alert sound
        tg.HapticFeedback.notificationOccurred('error');

        // Disappear after 5 sec
        setTimeout(() => {
            if(raidActive) {
                raidActive = false;
                btn.style.display = 'none';
            }
        }, 5000);
    }

    function hitRaidBoss() {
        if(!raidActive) return;
        raidClicks++;
        tg.HapticFeedback.impactOccurred('heavy');
        
        // Scale effect
        let btn = document.getElementById('raid-btn');
        btn.style.transform = 'scale(0.9)';
        setTimeout(() => btn.style.transform = 'scale(1)', 50);

        if(raidClicks >= 10) {
            raidActive = false;
            btn.style.display = 'none';
            let reward = calcIncome() * 120; // 2 mins of income
            if(reward < 500) reward = 500;
            addEnergy(reward);
            alert(`–£–ì–†–û–ó–ê –£–°–¢–†–ê–ù–ï–ù–ê!\n–ù–∞–≥—Ä–∞–¥–∞: ${Math.floor(reward)} PUNK`);
            tg.HapticFeedback.notificationOccurred('success');
        }
    }

    // --- HACKING ---
    let hackAnim, hackDir = 1, hackPos = 0;
    
    function checkHackStatus() {
        let now = Date.now();
        let btn = document.getElementById('hack-btn');
        let diff = now - state.lastHack;
        if(diff > 300000) {
            btn.classList.add('ready');
            btn.innerText = "‚ò† –í–ó–õ–û–ú –î–û–°–¢–£–ü–ï–ù";
        } else {
            btn.classList.remove('ready');
            let left = Math.ceil((300000 - diff)/1000);
            let min = Math.floor(left/60);
            let sec = left%60;
            btn.innerText = `‚è≥ ${min}:${sec < 10 ? '0'+sec : sec}`;
        }
    }

    function startHackGame() {
        if(Date.now() - state.lastHack < 300000) return;
        document.getElementById('hack-modal').style.display = 'flex';
        hackPos = 0; hackDir = 1.2;
        let targetLeft = 20 + Math.random() * 50;
        document.getElementById('hack-target-zone').style.left = targetLeft + '%';
        window.hackTargetMin = targetLeft;
        window.hackTargetMax = targetLeft + 15;

        function animate() {
            hackPos += hackDir;
            if(hackPos > 100 || hackPos < 0) hackDir *= -1;
            document.getElementById('hack-cursor').style.left = hackPos + '%';
            hackAnim = requestAnimationFrame(animate);
        }
        animate();
    }

    function stopHack() {
        cancelAnimationFrame(hackAnim);
        if(hackPos >= window.hackTargetMin && hackPos <= window.hackTargetMax) {
            let reward = calcIncome() * 300; 
            if(reward < 1000) reward = 1000;
            addEnergy(reward);
            alert(`–°–ò–°–¢–ï–ú–ê –í–ó–õ–û–ú–ê–ù–ê!\n–°–ö–ê–ß–ê–ù–û: ${Math.floor(reward)} PUNK`);
            tg.HapticFeedback.notificationOccurred('success');
            AudioFX.play('buy');
            state.lastHack = Date.now();
        } else {
            tg.HapticFeedback.notificationOccurred('error');
            AudioFX.play('error');
            state.lastHack = Date.now() - 240000; 
        }
        document.getElementById('hack-modal').style.display = 'none';
        checkHackStatus();
    }

    // --- MENUS ---
    function openMenu(type) {
        document.getElementById('main-modal').style.display = 'flex';
        const title = document.getElementById('modal-title');
        const content = document.getElementById('modal-content');
        content.innerHTML = '';

        if(type === 'ships') {
            title.innerText = "–ê–ù–ì–ê–† –§–õ–û–¢–ê";
            DB.ships.forEach(s => {
                let cnt = state.ships[s.id] || 0;
                let price = Math.floor(s.cost * Math.pow(1.15, cnt));
                renderItem(content, s.name, `+${s.inc}/—Å–µ–∫ | –ê–Ω–≥–∞—Ä: ${cnt}`, price, s.img, false, () => {
                    if(state.energy >= price) {
                        state.energy -= price;
                        state.ships[s.id] = cnt + 1;
                        AudioFX.play('buy');
                        openMenu('ships');
                    }
                });
            });
        }
        else if(type === 'crew') {
            title.innerText = "–ù–ê–ô–ú –ë–ê–ù–î–´";
            DB.crew.forEach(c => {
                let lvl = state.crew[c.id] || 0;
                let price = Math.floor(c.cost * Math.pow(1.4, lvl));
                renderItem(content, `${c.name} (Lvl ${lvl})`, c.desc, price, c.img, false, () => {
                    if(state.energy >= price) {
                        state.energy -= price;
                        state.crew[c.id] = lvl + 1;
                        AudioFX.play('buy');
                        openMenu('crew');
                    }
                });
            });
        }
        else if(type === 'implants') {
            title.innerText = "–ö–ò–ë–ï–†-–ò–ú–ü–õ–ê–ù–¢–´";
            DB.implants.forEach(item => {
                let isOwned = state.implants.includes(item.id);
                renderItem(content, item.name, isOwned ? "–£–°–¢–ê–ù–û–í–õ–ï–ù–û" : item.desc, item.cost, item.img, isOwned, () => {
                    if(isOwned) return;
                    if(state.energy >= item.cost) {
                        state.energy -= item.cost;
                        state.implants.push(item.id);
                        AudioFX.play('buy');
                        openMenu('implants');
                    }
                });
            });
        }
        else if(type === 'rebirth') {
            title.innerText = "–°–ò–°–¢–ï–ú–ê –ü–ï–†–ï–†–û–ñ–î–ï–ù–ò–Ø";
            renderRebirth(content);
        }
    }

    function renderItem(container, name, desc, price, img, isOwned, onClick) {
        let div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
            <img src="${img}" onerror="this.src='https://via.placeholder.com/50?text=ERR'">
            <div class="item-info">
                <div class="item-name">${name}</div>
                <div class="item-desc">${desc}</div>
            </div>
            <button class="btn-buy ${isOwned ? 'btn-owned' : ''}">${isOwned ? 'V' : formatNum(price)}</button>
        `;
        if(!isOwned) div.querySelector('button').onclick = onClick;
        container.appendChild(div);
    }

    function renderRebirth(container) {
        let p = document.createElement('p');
        p.style.fontSize = '12px'; p.style.marginBottom = '15px'; p.style.textAlign = 'center';
        p.innerHTML = `–°–±—Ä–æ—Å –≤—Å–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–∞—Å—Ç <b style="color:var(--accent)">–ù–∞–Ω–æ-–ë–æ—Ç–æ–≤</b>.<br>1 –ë–æ—Ç = +10% –∫ –¥–æ—Ö–æ–¥—É –Ω–∞–≤—Å–µ–≥–¥–∞.<br>–¢–µ–∫—É—â–∏–π –±–æ–Ω—É—Å: <b style="color:var(--cyan)">+${Math.floor(state.prestigeTokens * 10)}%</b>`;
        container.appendChild(p);

        let potential = Math.floor(state.total / 1000000);
        let btn = document.createElement('button');
        btn.className = 'hack-btn-action';
        btn.innerText = `–°–ë–†–û–°–ò–¢–¨ –ó–ê ${potential} –ë–û–¢–û–í`;
        if(potential < 1) {
            btn.style.opacity = 0.5;
            btn.innerText = "–ù–£–ñ–ù–û 1–ú –í–°–ï–ì–û PUNK";
        } else {
            btn.onclick = () => {
                if(confirm("–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–¥–∏ –±–æ–Ω—É—Å–∞?")) {
                    state.prestigeTokens += potential;
                    state.energy = 0;
                    state.total = 0;
                    state.ships = {};
                    state.crew = {};
                    state.implants = [];
                    saveGame();
                    location.reload();
                }
            };
        }
        container.appendChild(btn);
    }

    function closeModal() { document.getElementById('main-modal').style.display = 'none'; }
    function formatNum(n) { return n > 1000000 ? (n/1000000).toFixed(1)+'M' : (n > 1000 ? (n/1000).toFixed(1)+'K' : n); }

    // --- UTILS & FX ---
    function updateHUD() {
        document.getElementById('energy-val').innerText = formatNum(Math.floor(state.energy));
        document.getElementById('inc-val').innerText = `+${formatNum(Math.floor(calcIncome()))} / —Å–µ–∫`;
        
        let ranks = ["–û—Ç–±—Ä–æ—Å", "–°–±–æ—Ä—â–∏–∫", "–•–∞–∫–µ—Ä", "–ö–∏–±–µ—Ä-–ü–∞–Ω–∫", "–ë–æ—Å—Å –£–ª–∏—Ü", "–ì–ª–∞–≤–∞ –°–∏–Ω–¥–∏–∫–∞—Ç–∞", "–ö–æ—Ä–ø–æ—Ä–∞—Ç", "–í–ª–∞—Å—Ç–µ–ª–∏–Ω –°–µ—Ç–∏"];
        let rIdx = Math.min(Math.floor(Math.log10(state.total + 1)), ranks.length-1);
        if(state.total < 1000) rIdx = 0;
        document.getElementById('rank-val').innerText = ranks[rIdx];
    }

    function spawnFloat(x, y, val, isCrit) {
        let el = document.createElement('div');
        el.className = 'float-txt';
        el.style.left = (x - 20) + 'px'; el.style.top = (y - 40) + 'px';
        el.innerText = `+${val}`;
        el.style.color = isCrit ? 'var(--red)' : 'var(--cyan)';
        if(isCrit) el.style.fontSize = '32px';
        document.body.appendChild(el);
        setTimeout(() => {
            el.style.transition = 'all 0.6s';
            el.style.transform = 'translateY(-100px) scale(1.2)';
            el.style.opacity = 0;
        }, 50);
        setTimeout(() => el.remove(), 600);
    }

    function saveGame() {
        state.lastSave = Date.now();
        localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    }

    // --- MATRIX BG ---
    function initMatrix() {
        const c = document.getElementById('matrix-canvas');
        const ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const chars = "01XYZ"; 
        const fontSize = 14;
        const columns = c.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);
        function draw() {
            ctx.fillStyle = "rgba(5, 0, 10, 0.1)";
            ctx.fillRect(0, 0, c.width, c.height);
            ctx.fillStyle = "#0f0"; ctx.font = fontSize + "px monospace";
            for(let i=0; i<drops.length; i++) {
                const text = chars[Math.floor(Math.random()*chars.length)];
                ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                if(drops[i]*fontSize > c.height && Math.random() > 0.98) drops[i] = 0;
                drops[i]++;
            }
        }
        setInterval(draw, 50);
    }

    // EVENTS
    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Å–æ–±—ã—Ç–∏–µ –≤–µ—à–∞–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–∫, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å –≤–µ–∑–¥–µ
    const zone = document.getElementById('tap-zone');
    zone.addEventListener('touchstart', tap, {passive:false});
    zone.addEventListener('mousedown', tap);

</script>
</body>
</html>