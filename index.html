<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CosmoPunk: Energy War</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #05000a;
            --accent: #ff00ff;
            --cyan: #00ffff;
            --glass: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.15);
            --font: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            background-image: 
                radial-gradient(circle at 50% 20%, #1a0033 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, #001122 0%, transparent 30%);
            color: #fff;
            font-family: var(--font);
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
        }

        /* --- HUD --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 10;
        }

        .stats-block {
            background: var(--glass);
            padding: 12px 20px;
            border-radius: 20px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #energy {
            font-size: 24px;
            font-weight: 900;
            color: var(--cyan);
            text-shadow: 0 0 15px var(--cyan);
        }

        .rank-box { text-align: right; }
        #rank { color: var(--accent); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; font-size: 14px; }
        
        .progress-container {
            width: 100px;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        #rank-bar { width: 0%; height: 100%; background: var(--accent); transition: 0.3s; }

        /* --- Reactor --- */
        #center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .reactor-core {
            width: 260px;
            height: 260px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s active;
        }

        .reactor-core:active { transform: scale(0.95); }

        .ring {
            position: absolute;
            inset: 0;
            border: 2px solid var(--accent);
            border-radius: 50%;
            opacity: 0.3;
            animation: pulse 2s infinite;
        }

        #reactor-img {
            width: 80%;
            z-index: 2;
            filter: drop-shadow(0 0 20px var(--accent));
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(1.3); opacity: 0; }
        }

        /* --- Bottom Menu --- */
        .bottom-nav {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding-bottom: 10px;
        }

        .nav-btn {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 5px;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            color: #ccc;
            transition: 0.2s;
        }

        .nav-btn:active { background: var(--accent); color: white; }

        /* --- Popups --- */
        #pop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            z-index: 100;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        .pop-content {
            background: #110022;
            border: 1px solid var(--accent);
            border-radius: 24px;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .close-btn {
            align-self: center;
            margin-top: 15px;
            background: var(--accent);
            border: none;
            color: white;
            padding: 10px 30px;
            border-radius: 50px;
            font-weight: bold;
        }

        .shop-item {
            display: flex;
            align-items: center;
            background: var(--glass);
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .shop-item img { width: 50px; height: 50px; margin-right: 15px; }
        .shop-info { flex: 1; }
        .shop-info h4 { font-size: 16px; color: var(--cyan); }
        .shop-info p { font-size: 12px; opacity: 0.7; }
        .buy-btn {
            background: #222;
            border: 1px solid var(--cyan);
            color: var(--cyan);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
        }
        .buy-btn:disabled { opacity: 0.3; border-color: gray; color: gray; }

        /* --- Animations --- */
        .float-text {
            position: absolute;
            color: var(--cyan);
            font-weight: 900;
            font-size: 28px;
            pointer-events: none;
            z-index: 50;
            text-shadow: 0 0 10px var(--cyan);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <div class="stats-block">
            <div id="energy">0</div>
            <div style="font-size: 10px; color: #aaa;">PUNK ENERGY</div>
            <div id="inc" style="font-size: 11px; color: var(--cyan);">+0/s</div>
        </div>
        <div class="rank-box">
            <div id="rank">Street Rat</div>
            <div class="progress-container"><div id="rank-bar"></div></div>
        </div>
    </div>

    <div id="center">
        <div class="reactor-core" id="tap-zone">
            <div class="ring"></div>
            <div class="ring" style="animation-delay: 0.5s"></div>
            <img src="assets/reactor/reactor.gif" id="reactor-img" alt="Reactor">
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-btn" onclick="openShop('ships')">ФЛОТ</div>
        <div class="nav-btn" onclick="openShop('implants')">ИМПЛАНТЫ</div>
        <div class="nav-btn" onclick="openCrew()">ЭКИПАЖ</div>
        <div class="nav-btn" onclick="openPop('Raid')">РЕЙДЫ</div>
        <div class="nav-btn" onclick="openPop('Profile')">ПРОФИЛЬ</div>
        <div class="nav-btn" onclick="openPop('Market')">РЫНОК</div>
        <div class="nav-btn" onclick="openPop('Settings')">ОПЦИИ</div>
        <div class="nav-btn" onclick="resetGame()" style="color: #ff4444;">RESET</div>
    </div>
</div>

<div id="pop">
    <div class="pop-content" id="card"></div>
    <button class="close-btn" onclick="closePop()">ЗАКРЫТЬ</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.backgroundColor = '#05000a';

    let s = JSON.parse(localStorage.getItem("cp_save_v2")) || {
        energy: 0,
        total: 0,
        pass: 0,
        rankIdx: 0,
        ships: {},
        implants: {},
        last: Date.now()
    };

    const RANKS = [
        { name: "Street Rat", goal: 1000 },
        { name: "Neon Scavenger", goal: 10000 },
        { name: "Void Pirate", goal: 50000 },
        { name: "Cyber Overlord", goal: 200000 },
        { name: "Galaxy Baron", goal: Infinity }
    ];

    const DATA = {
        ships: [
            { id: 's1', name: "Rusty Drone", price: 50, inc: 1, img: "ship1" },
            { id: 's2', name: "Scrap Fighter", price: 250, inc: 5, img: "ship2" },
            { id: 's3', name: "Punk Hauler", price: 1000, inc: 15, img: "ship3" }
        ],
        implants: [
            { id: 'i1', name: "Base Chip", price: 100, inc: 2, img: "base" },
            { id: 'i2', name: "Neuro Link", price: 800, inc: 10, img: "neuro" }
        ]
    };

    // --- Core Logic ---
    function updateUI() {
        document.getElementById('energy').textContent = Math.floor(s.energy).toLocaleString();
        document.getElementById('inc').textContent = `+${s.pass.toFixed(1)}/сек`;
        
        const rank = RANKS[s.rankIdx];
        document.getElementById('rank').textContent = rank.name;
        
        const prevGoal = s.rankIdx > 0 ? RANKS[s.rankIdx-1].goal : 0;
        const progress = ((s.total - prevGoal) / (rank.goal - prevGoal)) * 100;
        document.getElementById('rank-bar').style.width = Math.min(progress, 100) + "%";

        if (s.total >= rank.goal && s.rankIdx < RANKS.length - 1) {
            s.rankIdx++;
            tg.HapticFeedback.notificationOccurred('success');
        }
    }

    function save() {
        s.last = Date.now();
        localStorage.setItem("cp_save_v2", JSON.stringify(s));
    }

    // --- Tapping ---
    document.getElementById('tap-zone').addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        
        s.energy += 1;
        s.total += 1;
        
        createFloatText(touch.clientX, touch.clientY);
        tg.HapticFeedback.impactOccurred('medium');
        updateUI();
    });

    function createFloatText(x, y) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.textContent = '+1';
        el.style.left = `${x - 20}px`;
        el.style.top = `${y - 40}px`;
        document.body.appendChild(el);

        const randX = (Math.random() - 0.5) * 100;
        el.animate([
            { transform: 'translate(0, 0) scale(1)', opacity: 1 },
            { transform: `translate(${randX}px, -150px) scale(1.5)`, opacity: 0 }
        ], { duration: 800, easing: 'ease-out' });

        setTimeout(() => el.remove(), 800);
    }

    // --- Shop System ---
    function openShop(type) {
        let html = `<h2>${type === 'ships' ? 'АНГАР ФЛОТА' : 'КИБЕР-ИМПЛАНТЫ'}</h2><br>`;
        DATA[type].forEach(item => {
            const count = s[type][item.id] || 0;
            const currentPrice = Math.floor(item.price * Math.pow(1.5, count));
            const canBuy = s.energy >= currentPrice;

            html += `
                <div class="shop-item">
                    <img src="assets/${type}/${item.img}.png" onerror="this.src='https://via.placeholder.com/50/ff00ff?text=ITEM'">
                    <div class="shop-info">
                        <h4>${item.name}</h4>
                        <p>Доход: +${item.inc}/сек | У вас: ${count}</p>
                        <p style="color:var(--cyan)">Цена: ${currentPrice} PUNK</p>
                    </div>
                    <button class="buy-btn" ${canBuy ? '' : 'disabled'} 
                        onclick="buyItem('${type}', '${item.id}', ${currentPrice}, ${item.inc})">
                        КУПИТЬ
                    </button>
                </div>`;
        });
        showPop(html);
    }

    function buyItem(type, id, price, inc) {
        if (s.energy >= price) {
            s.energy -= price;
            s.pass += inc;
            s.ships[id] = (s.ships[id] || 0) + 1; // Упростил для примера
            tg.HapticFeedback.impactOccurred('heavy');
            save();
            openShop(type);
            updateUI();
        }
    }

    function openCrew() {
        let h = `<h2>ЭКИПАЖ</h2><br>
            <div class="shop-item">
                <img src="assets/crew/captain.png" onerror="this.src='https://via.placeholder.com/50/ff00ff?text=CAP'">
                <div class="shop-info"><h4>Капитан Космо</h4><p>Увеличивает весь доход на 10% (Скоро)</p></div>
            </div>
            <div class="shop-item">
                <img src="assets/crew/hacker.png" onerror="this.src='https://via.placeholder.com/50/00ffff?text=FOX'">
                <div class="shop-info"><h4>Лиса-Хакер</h4><p>Шанс критического тапа x5 (Скоро)</p></div>
            </div>`;
        showPop(h);
    }

    function showPop(html) {
        document.getElementById('card').innerHTML = html;
        document.getElementById('pop').style.display = 'flex';
    }

    function closePop() {
        document.getElementById('pop').style.display = 'none';
    }

    function resetGame() {
        if(confirm("Сбросить весь прогресс?")) {
            localStorage.removeItem("cp_save_v2");
            location.reload();
        }
    }

    // --- Init ---
    // Offline income
    const now = Date.now();
    const offlineTime = (now - s.last) / 1000;
    if (offlineTime > 10) {
        const mined = s.pass * offlineTime;
        s.energy += mined;
        alert(`Пока тебя не было, флот добыл: ${Math.floor(mined)} PUNK`);
    }

    setInterval(() => {
        s.energy += s.pass / 10;
        updateUI();
        if (Math.random() > 0.9) save(); // Автосохранение раз в секунду с шансом
    }, 100);

    updateUI();
</script>
</body>
</html>