<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CosmoPunk: Syndicate</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0b0014;
            --accent: #d300d3; /* –ù–µ–æ–Ω–æ–≤—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
            --cyan: #00f7ff;    /* –ù–µ–æ–Ω–æ–≤—ã–π –≥–æ–ª—É–±–æ–π */
            --yellow: #f7ff00;  /* –ö–∏—Å–ª–æ—Ç–Ω—ã–π –∂–µ–ª—Ç—ã–π */
            --glass: rgba(30, 0, 40, 0.6);
            --border: rgba(255, 255, 255, 0.15);
            --font: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            /* –ö—Ä–∞—Å–∏–≤—ã–π —Å–ª–æ–∂–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            background-image: 
                radial-gradient(circle at 50% 10%, rgba(211, 0, 211, 0.2) 0%, transparent 60%),
                radial-gradient(circle at 90% 90%, rgba(0, 247, 255, 0.15) 0%, transparent 50%);
            color: #fff;
            font-family: var(--font);
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #app { display: flex; flex-direction: column; height: 100vh; padding: 16px; position: relative; }

        /* --- HUD (–í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å) --- */
        .header { display: flex; justify-content: space-between; align-items: flex-start; z-index: 10; margin-bottom: 20px; }
        
        .stats-box {
            background: var(--glass);
            padding: 10px 18px;
            border: 1px solid var(--border);
            border-radius: 16px;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            min-width: 100px;
        }
        
        #energy { font-size: 24px; font-weight: 800; color: var(--cyan); text-shadow: 0 0 10px rgba(0, 247, 255, 0.5); }
        .sub-text { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 2px; }
        
        #rank { font-size: 13px; color: var(--accent); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }

        /* --- REACTOR (–¶–µ–Ω—Ç—Ä) --- */
        #center { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        
        .reactor-wrap { 
            position: relative; width: 260px; height: 260px; 
            display: flex; justify-content: center; align-items: center; 
            transition: transform 0.1s;
        }
        .reactor-wrap:active { transform: scale(0.95); }

        .reactor-glow {
            position: absolute; inset: -20px; border-radius: 50%;
            background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
            opacity: 0.3; animation: pulse 3s infinite;
        }
        
        /* –ö—Ä—É–≥–ª—ã–µ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–ª—å—Ü–∞ */
        .ring {
            position: absolute; inset: 0; border: 1px solid var(--cyan); border-radius: 50%;
            opacity: 0.2; animation: spin 10s linear infinite;
        }
        .ring:nth-child(2) { inset: 20px; border-color: var(--accent); animation-direction: reverse; animation-duration: 7s; }

        #reactor-img { 
            width: 85%; height: 85%; object-fit: contain; z-index: 2;
            filter: drop-shadow(0 0 20px rgba(211, 0, 211, 0.6));
        }

        @keyframes pulse { 0% {opacity:0.2; transform:scale(1);} 50% {opacity:0.4; transform:scale(1.1);} 100% {opacity:0.2; transform:scale(1);} }
        @keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }

        /* --- BOTTOM NAV (–ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å) --- */
        .nav-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            padding-top: 10px;
        }
        .nav-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border); border-radius: 14px;
            height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 9px; font-weight: bold; color: #ccc; cursor: pointer;
            backdrop-filter: blur(5px); transition: 0.2s;
        }
        .nav-btn span { font-size: 18px; margin-bottom: 2px; }
        .nav-btn:active { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* --- POPUPS (–û–∫–Ω–∞) --- */
        #pop {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: none; align-items: flex-end; /* –í—ã–µ–∑–∂–∞–µ—Ç —Å–Ω–∏–∑—É */
            animation: fadeIn 0.2s;
        }
        .card {
            background: #1a0b2e; 
            border-top: 2px solid var(--accent);
            border-radius: 24px 24px 0 0; 
            width: 100%; max-height: 85vh;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.5);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .card-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .card-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        .close-btn {
            margin: 10px 20px 20px; background: #333; border: none; color: #fff;
            padding: 14px; border-radius: 16px; font-weight: bold; font-size: 14px;
        }

        /* --- LIST ITEMS --- */
        .list-item {
            display: flex; align-items: center; gap: 15px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            padding: 12px; border-radius: 16px; margin-bottom: 10px;
        }
        .list-item img { width: 48px; height: 48px; object-fit: contain; border-radius: 8px; background: rgba(0,0,0,0.2); }
        .list-info { flex: 1; }
        .list-info h4 { color: #fff; font-size: 15px; margin-bottom: 4px; }
        .list-info p { color: #888; font-size: 12px; }
        
        .action-btn {
            background: var(--cyan); color: #05000a; border: none;
            padding: 8px 16px; border-radius: 10px; font-size: 12px; font-weight: 800;
        }
        .action-btn:disabled { background: #333; color: #555; }
        .action-btn.claim { background: var(--yellow); }

        /* --- FX --- */
        .float-txt {
            position: absolute; font-weight: 900; font-size: 28px; pointer-events: none; z-index: 50;
            text-shadow: 0 0 10px currentColor;
        }
        
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <div class="stats-box">
            <div id="energy">0</div>
            <div class="sub-text" id="inc">+0 / —Å–µ–∫</div>
        </div>
        <div style="text-align: right;">
            <div class="stats-box" style="border-color: var(--accent);">
                <div id="rank">Street Rat</div>
                <div class="sub-text" id="lvl">LVL 1</div>
            </div>
        </div>
    </div>

    <div id="center">
        <div class="reactor-wrap" id="tap-area">
            <div class="reactor-glow"></div>
            <div class="ring"></div>
            <div class="ring"></div>
            <img src="assets/reactor/reactor.gif" id="reactor-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/9309/9309584.png'">
        </div>
    </div>

    <div class="nav-grid">
        <div class="nav-btn" onclick="openShop('ships')"><span>üöÄ</span>–§–ª–æ—Ç</div>
        <div class="nav-btn" onclick="openCrew()"><span>üë•</span>–≠–∫–∏–ø–∞–∂</div>
        <div class="nav-btn" onclick="openQuests()"><span>üìú</span>–ó–∞–¥–∞–Ω–∏—è</div>
        <div class="nav-btn" onclick="openSettings()"><span>‚öôÔ∏è</span>–û–ø—Ü–∏–∏</div>
    </div>
</div>

<div id="pop" onclick="if(event.target.id==='pop') closePop()">
    <div class="card">
        <div class="card-header"><h3 id="pop-title">TITLE</h3></div>
        <div class="card-body" id="pop-body"></div>
        <button class="close-btn" onclick="closePop()">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<script>
    /* --- SYSTEM SETUP --- */
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.headerColor = '#0b0014';
    
    // Config
    const SAVE_KEY = 'cp_save_modern_v4';
    const RANKS = ["Street Rat", "Scavenger", "Cyber Punk", "Net Runner", "Void Lord"];

    // Default State
    let s = JSON.parse(localStorage.getItem(SAVE_KEY)) || {
        energy: 0,
        total: 0,
        level: 1,
        ships: {},
        crew: { hacker: 0, bot: 0 },
        quests: { q1: false, q2: false, q3: false },
        settings: { sound: true, vibro: true },
        lastLogin: 0,
        lastSave: Date.now()
    };

    // --- GAME LOOP ---
    setInterval(() => {
        // Passive Income
        let passive = calculatePassive();
        if(passive > 0) {
            s.energy += passive / 10;
            s.total += passive / 10;
        }
        updateUI();
    }, 100);

    setInterval(saveGame, 5000); // Auto-save

    // Check Daily Bonus
    checkDaily();

    // --- LOGIC ---

    function calculatePassive() {
        let income = 0;
        // Ships Logic
        if(s.ships['s1']) income += s.ships['s1'] * 1;
        if(s.ships['s2']) income += s.ships['s2'] * 5;
        // Bot Logic
        if(s.crew['bot']) income += s.crew['bot'] * 20; 
        return income;
    }

    function tap(e) {
        e.preventDefault();
        let touch = e.touches ? e.touches[0] : e;
        
        // Crit Logic (Hacker)
        let isCrit = false;
        let gain = 1;
        
        // Hacker gives 5% chance per level to crit x10
        let critChance = s.crew['hacker'] * 0.05; 
        if (Math.random() < critChance) {
            isCrit = true;
            gain = 10;
            if(s.settings.vibro) tg.HapticFeedback.notificationOccurred('warning');
        } else {
            if(s.settings.vibro) tg.HapticFeedback.impactOccurred('light');
        }

        s.energy += gain;
        s.total += gain;
        
        checkQuests();
        createParticle(touch.clientX, touch.clientY, gain, isCrit);
        updateUI();
    }

    // --- UI RENDERING ---

    function updateUI() {
        document.getElementById('energy').innerText = Math.floor(s.energy).toLocaleString();
        document.getElementById('inc').innerText = `+${calculatePassive().toFixed(1)} / —Å–µ–∫`;
        
        // Rank Logic
        let rIndex = Math.min(Math.floor(s.total / 10000), RANKS.length - 1);
        document.getElementById('rank').innerText = RANKS[rIndex];
        document.getElementById('lvl').innerText = `LVL ${s.crew['bot'] + s.crew['hacker'] + 1}`;
    }

    function createParticle(x, y, val, isCrit) {
        const el = document.createElement('div');
        el.className = 'float-txt';
        el.style.color = isCrit ? 'var(--yellow)' : 'var(--cyan)';
        el.innerText = `+${val}`;
        el.style.left = (x - 20) + 'px';
        el.style.top = (y - 50) + 'px';
        if(isCrit) el.style.fontSize = '40px';
        
        document.body.appendChild(el);

        let destX = (Math.random() - 0.5) * 80;
        el.animate([
            { transform: 'translate(0,0) scale(1)', opacity: 1 },
            { transform: `translate(${destX}px, -120px) scale(${isCrit?1.3:1.1})`, opacity: 0 }
        ], { duration: 800, easing: 'cubic-bezier(0,0,0.2,1)' });

        setTimeout(() => el.remove(), 800);
    }

    // --- MENUS ---

    function openShop(type) {
        const title = document.getElementById('pop-title');
        const body = document.getElementById('pop-body');
        document.getElementById('pop').style.display = 'flex';
        
        title.innerText = "–ê–ù–ì–ê–† –§–õ–û–¢–ê";
        
        const items = [
            { id: 's1', name: 'Scout Drone', cost: 100, inc: 1, img: 'ship1' },
            { id: 's2', name: 'Battle Cruiser', cost: 500, inc: 5, img: 'ship2' }
        ];

        body.innerHTML = items.map(i => {
            let count = s.ships[i.id] || 0;
            let price = Math.floor(i.cost * Math.pow(1.3, count));
            return `
            <div class="list-item">
                <img src="assets/ships/${i.img}.png" onerror="this.src='https://via.placeholder.com/48/00ffff?text=S'">
                <div class="list-info">
                    <h4>${i.name}</h4>
                    <p>–î–æ—Ö–æ–¥: +${i.inc}/—Å–µ–∫ | –£ —Ç–µ–±—è: ${count}</p>
                </div>
                <button class="action-btn" onclick="buyShip('${i.id}', ${price})">${price}</button>
            </div>`;
        }).join('');
    }

    function buyShip(id, price) {
        if(s.energy >= price) {
            s.energy -= price;
            s.ships[id] = (s.ships[id] || 0) + 1;
            saveGame();
            openShop('ships'); // Redraw
            tg.HapticFeedback.selectionChanged();
        }
    }

    function openCrew() {
        const title = document.getElementById('pop-title');
        const body = document.getElementById('pop-body');
        document.getElementById('pop').style.display = 'flex';
        title.innerText = "–≠–ö–ò–ü–ê–ñ";

        // Hacker Cost
        let hLvl = s.crew.hacker;
        let hCost = Math.floor(1000 * Math.pow(2, hLvl));
        
        // Bot Cost
        let bLvl = s.crew.bot;
        let bCost = Math.floor(2000 * Math.pow(1.5, bLvl));

        body.innerHTML = `
            <div class="list-item">
                <img src="assets/crew/hacker.png" onerror="this.src='https://via.placeholder.com/48/d300d3?text=H'">
                <div class="list-info">
                    <h4>–õ–∏—Å–∞-–•–∞–∫–µ—Ä (LVL ${hLvl})</h4>
                    <p>–®–∞–Ω—Å –∫—Ä–∏—Ç–∞ (x10) +5%</p>
                </div>
                <button class="action-btn" onclick="upgradeCrew('hacker', ${hCost})">${hCost}</button>
            </div>
            <div class="list-item">
                <img src="assets/crew/bot.png" onerror="this.src='https://via.placeholder.com/48/f7ff00?text=B'">
                <div class="list-info">
                    <h4>–ê–≤—Ç–æ-–ë–æ—Ç (LVL ${bLvl})</h4>
                    <p>–î–æ–±—ã–≤–∞–µ—Ç +20/—Å–µ–∫</p>
                </div>
                <button class="action-btn" onclick="upgradeCrew('bot', ${bCost})">${bCost}</button>
            </div>
        `;
    }

    function upgradeCrew(role, price) {
        if(s.energy >= price) {
            s.energy -= price;
            s.crew[role]++;
            saveGame();
            openCrew();
            tg.HapticFeedback.notificationOccurred('success');
        }
    }

    function openQuests() {
        document.getElementById('pop').style.display = 'flex';
        document.getElementById('pop-title').innerText = "–ó–ê–î–ê–ù–ò–Ø";
        const body = document.getElementById('pop-body');

        const qData = [
            { id: 'q1', txt: '–ù–∞–∫–æ–ø–∏—Ç—å 1000 —ç–Ω–µ—Ä–≥–∏–∏', reward: 500, done: s.total >= 1000 },
            { id: 'q2', txt: '–ö—É–ø–∏—Ç—å 5 –î—Ä–æ–Ω–æ–≤', reward: 1000, done: (s.ships['s1']||0) >= 5 },
            { id: 'q3', txt: '–ù–∞–Ω—è—Ç—å –•–∞–∫–µ—Ä–∞', reward: 2000, done: s.crew['hacker'] > 0 }
        ];

        body.innerHTML = qData.map(q => {
            let isClaimed = s.quests[q.id];
            let btn = '';
            
            if(isClaimed) btn = `<button class="action-btn" disabled>‚úì</button>`;
            else if(q.done) btn = `<button class="action-btn claim" onclick="claimQuest('${q.id}', ${q.reward})">–ó–ê–ë–†–ê–¢–¨</button>`;
            else btn = `<button class="action-btn" disabled>üîí</button>`;

            return `
            <div class="list-item">
                <div class="list-info">
                    <h4>${q.txt}</h4>
                    <p style="color:var(--yellow)">–ù–∞–≥—Ä–∞–¥–∞: ${q.reward} PUNK</p>
                </div>
                ${btn}
            </div>`;
        }).join('');
    }

    function claimQuest(qid, reward) {
        s.quests[qid] = true;
        s.energy += reward;
        tg.HapticFeedback.notificationOccurred('success');
        saveGame();
        openQuests();
    }

    function openSettings() {
        document.getElementById('pop').style.display = 'flex';
        document.getElementById('pop-title').innerText = "–ù–ê–°–¢–†–û–ô–ö–ò";
        const body = document.getElementById('pop-body');

        body.innerHTML = `
            <div class="list-item" onclick="toggleSet('sound')">
                <div class="list-info"><h4>–ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</h4></div>
                <div style="color:var(--cyan)">${s.settings.sound ? '–í–ö–õ' : '–í–´–ö–õ'}</div>
            </div>
            <div class="list-item" onclick="toggleSet('vibro')">
                <div class="list-info"><h4>–í–∏–±—Ä–∞—Ü–∏—è (Haptic)</h4></div>
                <div style="color:var(--cyan)">${s.settings.vibro ? '–í–ö–õ' : '–í–´–ö–õ'}</div>
            </div>
            <div class="list-item" style="border-color:rgba(255,0,0,0.3)" onclick="resetGame()">
                <div class="list-info"><h4 style="color:#ff4444">–°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h4><p>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ</p></div>
            </div>
        `;
    }

    function toggleSet(key) {
        s.settings[key] = !s.settings[key];
        saveGame();
        openSettings();
    }

    // --- UTILS ---
    function checkDaily() {
        const today = new Date().toDateString();
        if(s.lastLogin !== today) {
            s.lastLogin = today;
            s.energy += 500;
            saveGame();
            setTimeout(() => alert("üéÅ –ï–ñ–ï–î–ù–ï–í–ù–´–ô –ë–û–ù–£–°: +500 PUNK"), 1000);
        }
    }
    
    function checkQuests() {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–µ—Å—Ç–æ–≤ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
    }

    function saveGame() {
        localStorage.setItem(SAVE_KEY, JSON.stringify(s));
    }
    
    function resetGame() {
        if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å.")) {
            localStorage.removeItem(SAVE_KEY);
            location.reload();
        }
    }

    function closePop() { document.getElementById('pop').style.display = 'none'; }

    // Bind Tap
    document.getElementById('tap-area').addEventListener('touchstart', tap);
    document.getElementById('tap-area').addEventListener('mousedown', tap);

    // Initial UI Update
    updateUI();

</script>
</body>
</html>