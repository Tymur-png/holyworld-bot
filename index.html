<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CosmoPunk Tap Game v8.0</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@600&display=swap" rel="stylesheet">
<style>
/* ТВОЙ КРАСИВЫЙ ДИЗАЙН — 100% сохранён */
:root{--bg:#0a001a;--n1:#ff00ff;--n2:#00ffff;--text:#fff;--panel:rgba(255,255,255,0.04);--glow:0 0 30px}
*{box-sizing:border-box;margin:0;padding:0}
html,body,#app{height:100%}
body{font-family:'Orbitron','Rajdhani',system-ui;background:radial-gradient(circle at 30% 20%,#1a0033 0%,var(--bg) 45%,#000 100%);color:var(--text);overflow:hidden}

/* Темы */
body.theme-neon{--bg:#0a001a;--n1:#ff00ff;--n2:#00ffff;--panel:linear-gradient(180deg,rgba(255,0,255,0.06),rgba(0,255,255,0.03))}
body.theme-holo{--bg:#001022;--n1:#7fe3ff;--n2:#a7ffa8;background:radial-gradient(circle at 50% 30%,#003344 0%,#001022 45%,#000 100%)}
body.theme-dark{--bg:#03040a;--n1:#ff3333;--n2:#33ff99;background:radial-gradient(circle at 70% 20%,#06060a 0%,#03040a 60%,#000 100%)}

/* Основные элементы */
#app{position:relative;width:100vw;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hud{position:absolute;top:12px;left:12px;right:12px;display:flex;align-items:center;justify-content:space-between;z-index:80}
.hud-left{display:flex;flex-direction:column;gap:6px}
.badge{padding:6px 10px;border-radius:12px;background:var(--panel);border:1px solid rgba(255,255,255,0.03);font-weight:700;backdrop-filter:blur(6px)}
.balance{font-size:18px;font-weight:800;text-shadow:var(--glow) var(--n1)}
.sub{font-size:12px;color:rgba(255,255,255,0.7)}

.stage{position:relative;display:flex;align-items:center;justify-content:center;width:100%;height:100%}
.reactor-wrap{width:min(76vmin,520px);height:min(76vmin,520px);position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50}
.reactor{width:100%;height:100%;border-radius:28px;background:radial-gradient(ellipse at 50% 20%,rgba(255,255,255,0.03) 0%,transparent 35%),linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.15));display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;border:2px solid rgba(255,255,255,0.04);box-shadow:var(--glow) var(--n1);transition:transform .12s ease}
.reactor img{width:78%;height:78%;object-fit:contain;filter:drop-shadow(var(--glow) var(--n1))}
.reactor:active{transform:scale(.98)}
.reactor.glitch{animation:glitch .18s steps(2)}
@keyframes glitch{20%{transform:translate(-6px,6px)}40%{transform:translate(6px,-6px)}60%{transform:translate(-6px,-6px)}80%{transform:translate(3px,3px)}

.floating{position:absolute;pointer-events:none;font-size:32px;color:var(--n2);text-shadow:var(--glow) var(--n1);animation:floatUp 1.4s forwards}
@keyframes floatUp{to{transform:translateY(-400px) rotate(720deg);opacity:0}}

.controls{position:absolute;bottom:14px;left:14px;right:14px;display:flex;gap:10px;justify-content:space-between;z-index:70}
.controls .left,.controls .right{display:flex;gap:8px;align-items:center}
.btn{background:var(--panel);border:1px solid rgba(255,255,255,0.04);padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;backdrop-filter:blur(6px);transition:all .2s}
.btn:hover{box-shadow:var(--glow) var(--n2);transform:translateY(-2px)}
.btn.primary{background:linear-gradient(90deg,var(--n1),var(--n2));color:#000;box-shadow:var(--glow) var(--n2);border:none}
.center-info{display:flex;flex-direction:column;align-items:center;gap:6px;z-index:60}

#pop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);z-index:999}
.pop-card{width:min(760px,96%);max-height:86%;overflow:auto;background:rgba(10,0,30,0.9);padding:20px;border-radius:14px;border:2px solid var(--n2);box-shadow:var(--glow) var(--n1);backdrop-filter:blur(20px)}
.pop-item{padding:14px;border-radius:10px;margin:10px 0;border:1px solid rgba(0,255,255,0.2);background:rgba(255,255,255,0.03)}
</style>
</head>
<body class="theme-neon">
<div id="app">
  <div class="hud">
    <div class="hud-left">
      <div class="badge title">CosmoPunk Tap Game</div>
      <div class="badge balance" id="energy">0 PUNK</div>
      <div class="sub" id="punk">0.0000 $PUNK</div>
    </div>
  </div>

  <div class="stage">
    <div class="reactor-wrap">
      <div id="reactor" class="reactor" onclick="tap(event)">
        <img src="https://i.ibb.co/0jKX7Wv/reactor.gif" alt="reactor">
      </div>
      <div class="center-info" style="margin-top:12px">
        <div id="inc" class="sub">0 /сек</div>
        <div id="rank" class="badge" style="margin-top:6px">Street Rat</div>
      </div>
    </div>
  </div>

  <div class="controls">
    <div class="left">
      <button class="btn ghost" onclick="openShop('fleet')">ФЛОТ</button>
      <button class="btn ghost" onclick="openShop('crew')">ЭКИПАЖ</button>
      <button class="btn ghost" onclick="openShop('impl')">ИМПЛАНТЫ</button>
    </div>
    <div class="right">
      <button class="btn primary" onclick="openShop('raid')">RAID</button>
      <button class="btn ghost" onclick="openShop('market')">ТЁМНЫЙ РЫНОК</button>
    </div>
  </div>
</div>

<div id="pop" onclick="if(event.target.id==='pop')popClose()">
  <div class="pop-card" id="popcard"></div>
</div>

<script>
const tg = Telegram.WebApp; tg.ready(); tg.expand();
const SAVE_KEY = 'cosmopunk_v8';
let s = {energy:0,punk:0,total:0,tap:3,mult:1,passive:0,ships:{r:0,c:0,h:0,f:0,d:0},crew:{},impl:{},nft:{},last:Date.now()};

const SHIPS = {r:{n:'Void Reaper',p:200000,i:10},c:{n:'Neon Corsair',p:100000,i:5},h:{n:'Punk Hauler',p:50000,i:2},f:{n:'Scrap Fighter',p:20000,i:1},d:{n:'Rusty Drone',p:10000,i:0.3}};
const CREW = {kosmo:{n:'Капитан Космо',p:1e6,e:'+50% пассив'},lisa:{n:'Лиса-Хакер',p:5e5,e:'+30% хак'},bot:{n:'ГигаПанк-Бот',p:3e5,e:'+1 авто-тап/сек'}};
const IMPLANTS = {neo:{n:'Нео-Нейрон',p:2e5,e:'+200% тап'},glitch:{n:'Глитч-Протез',p:1e5,e:'+100% пассив'}};

// TON
const ton = new TON_CONNECT.UI.TonConnectUI({manifestUrl:location.origin+"/tonconnect-manifest.json"});

// Сохранение + оффлайн
function save(){ s.last=Date.now(); localStorage.setItem(SAVE_KEY,JSON.stringify(s)); }
function load(){ const d=localStorage.getItem(SAVE_KEY); if(d) Object.assign(s,JSON.parse(d)); offline(); }
function offline(){ const diff=Math.min((Date.now()-s.last)/1000,43200); s.energy+=s.passive*diff; if(diff>60) tg.showAlert(`Оффлайн: +${(s.passive*diff).toFixed(0)} энергии`); }

// Пассив + обмен
setInterval(()=>{ s.energy+=s.passive/10; if(s.energy>=1000){ let c=Math.floor(s.energy/1000); s.punk+=c*0.95; s.energy-=c*1000; } recalcPassive(); ui(); },100);
setInterval(save,5000);

// Пересчёт пассивки
function recalcPassive(){
  let inc = 0;
  for(let k in s.ships) inc += s.ships[k] * SHIPS[k].i;
  if(s.crew.kosmo) inc *= 1.5;
  if(s.impl.glitch) inc *= 2;
  s.passive = inc;
}

// UI
function ui(){
  document.getElementById('energy').innerText = Math.floor(s.energy).toLocaleString() + ' PUNK';
  document.getElementById('punk').innerText = s.punk.toFixed(4) + ' $PUNK';
  document.getElementById('inc').innerText = s.passive.toFixed(1) + ' /сек';
}

// ТАП + КРИТЫ
function tap(ev){
  let crit=1; const r=Math.random();
  if(r<0.005) crit=10; else if(r<0.035) crit=5; else if(r<0.155) crit=2;
  const gain = Math.floor(s.tap * s.mult * crit);
  s.energy += gain; s.total += gain;

  const x = ev.touches?.[0]?.clientX || ev.clientX || innerWidth/2;
  const y = ev.touches?.[0]?.clientY || ev.clientY || innerHeight/2;

  const el=document.createElement('div'); el.className='floating'; el.innerText='+'+gain.toLocaleString();
  el.style.left=(x-30)+'px'; el.style.top=(y-30)+'px';
  const angle=Math.random()*60-30; const dist=120+Math.random()*100;
  el.style.transform=`rotate(${angle}deg)`;
  el.animate([{opacity:1,transform:`translate(0,0)`},{opacity:0,transform:`translate(0,-${dist}px)`}],{duration:1400,easing:'cubic-bezier(0.2,0.8,0.4,1)'});
  document.body.appendChild(el); setTimeout(()=>el.remove(),1500);

  if(crit>1){
    const b=document.createElement('div'); b.className='floating'; b.style.fontSize='72px'; b.innerText='×'+crit; b.style.color='#ff0088';
    b.style.left=(x-80)+'px'; b.style.top=(y-140)+'px';
    document.body.appendChild(b); setTimeout(()=>b.remove(),1000);
  }

  document.getElementById('reactor').classList.add('glitch');
  setTimeout(()=>document.getElementById('reactor').classList.remove('glitch'),200);
  tg.HapticFeedback.impactOccurred('light');
  ui();
}

// МАГАЗИНЫ — ВСЕ РАБОТАЮТ
function openShop(type){
  let html = `<h2 style="color:var(--n1);text-align:center;margin-bottom:20px">${type.toUpperCase()}</h2>`;
  if(type==='fleet'){
    for(let k in SHIPS){
      let sh=SHIPS[k], o=s.ships[k]||0, p=sh.p*Math.pow(1.15,o);
      html+=`<div class="pop-item"><strong>\( {sh.n}</strong><br>+ \){sh.i}/сек<br>Цена: \( {p.toLocaleString()}<br>У тебя: \){o}<br><button class="btn primary" style="margin-top:10px;width:100%" onclick="buyShip('\( {k}', \){p})">КУПИТЬ</button></div>`;
    }
  }
  if(type==='crew'){
    for(let k in CREW){
      let c=CREW[k], owned=s.crew[k]?'НАНЯТ':'НАНЯТЬ';
      html+=`<div class="pop-item"><strong>\( {c.n}</strong><br> \){c.e}<br>Цена: \( {c.p.toLocaleString()}<br><button class="btn primary" style="margin-top:10px;width:100%" onclick="hire(' \){k}',\( {c.p})"> \){owned}</button></div>`;
    }
  }
  if(type==='impl'){
    for(let k in IMPLANTS){
      let i=IMPLANTS[k], owned=s.impl[k]?'УСТАНОВЛЕН':'УСТАНОВИТЬ';
      html+=`<div class="pop-item"><strong>\( {i.n}</strong><br> \){i.e}<br>Цена: \( {i.p.toLocaleString()}<br><button class="btn primary" style="margin-top:10px;width:100%" onclick="install(' \){k}',\( {i.p})"> \){owned}</button></div>`;
    }
  }
  if(type==='raid'){
    html+=`<div class="pop-item">Crypto-Raid: тапай босса 100 раз!<br>Текущий прогресс: 0/100<br><button class="btn primary" style="margin-top:10px;width:100%">НАЧАТЬ РЕЙД</button></div>`;
  }
  if(type==='market'){
    html+=`<div class="pop-item"><strong>Ghost Ship NFT</strong><br>x5 глобальный множитель<br>Цена: 1000 $PUNK<br><button class="btn primary" style="margin-top:10px;width:100%" onclick="buyNFT()">МИНТИТЬ</button></div>`;
  }
  pop(html);
}

function buyShip(k,p){ if(s.energy>=p){ s.energy-=p; s.ships[k]=(s.ships[k]||0)+1; recalcPassive(); tg.showAlert('Корабль куплен!'); popClose(); openShop('fleet'); } else tg.showAlert('Недостаточно!'); }
function hire(k,p){ if(s.energy>=p && !s.crew[k]){ s.energy-=p; s.crew[k]=true; if(k==='bot') setInterval(()=>{tap({clientX:innerWidth/2,clientY:innerHeight/2})},1000); recalcPassive(); popClose(); } }
function install(k,p){ if(s.energy>=p && !s.impl[k]){ s.energy-=p; s.impl[k]=true; if(k==='neo') s.mult+=2; recalcPassive(); popClose(); } }
function buyNFT(){ if(s.punk>=1000){ s.punk-=1000; s.mult*=5; tg.showAlert('NFT получен! x5 навсегда!'); popClose(); } }

// Попап
function pop(html){ document.getElementById('popcard').innerHTML=html; document.getElementById('pop').style.display='flex'; }
function popClose(){ document.getElementById('pop').style.display='none'; }

load(); recalcPassive(); ui();
</script>
</body>
</html>